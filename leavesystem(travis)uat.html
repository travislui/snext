<!DOCTYPE html>
<html lang="en">

<head>
    <title>S-Next 請假及賀金系統</title>
    
    <link href='https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.10/main.min.css' rel='stylesheet' />
    <link href='https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.10/main.min.css' rel='stylesheet' />
    <script src='https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.10/main.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.10/main.min.js'></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    
    <style>
        /* Responsive styles */
        @media screen and (max-width: 768px) {
            /* Container adjustments */
            .container {
                margin: 10px;
                padding: 10px;
                width: auto;
            }

            /* Form adjustments */
            form {
                padding: 10px;
            }

            /* Table responsiveness */
            table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }

            /* Input field adjustments */
            input[type="text"],
            input[type="password"],
            input[type="number"],
            input[type="date"],
            select {
                font-size: 16px; /* Prevents zoom on iOS */
                padding: 10px;
            }

            /* Button adjustments */
            button {
                width: 100%;
                padding: 12px;
                margin: 5px 0;
                font-size: 16px;
            }

            /* Header adjustments */
            header h1 {
                font-size: 1.5rem;
                padding: 10px;
            }

            /* Employee information adjustments */
            #employee-page p strong {
                width: 100%;
                display: block;
                margin-bottom: 5px;
            }

            /* Modal adjustments */
            .proof-modal-content {
                width: 90%;
                margin: 5% auto;
            }

            /* Penalty form adjustments */
            #penalty-form {
                grid-template-columns: 1fr;
            }

            /* Status table adjustments */
            .application-status table,
            #employee-penalty-table {
                font-size: 14px;
            }

            /* Make tables scrollable horizontally */
            .application-list {
                overflow-x: auto;
            }

            /* Adjust cell padding for better touch targets */
            th, td {
                padding: 8px;
            }

            /* Stack form elements vertically */
            #add-employee-form,
            #apply-leave-form {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }

            /* Improve button touch targets */
            .remove-btn,
            .show-proof-btn,
            .reject-btn,
            .submit-proof-btn,
            .view-proof-btn {
                padding: 8px 16px;
                margin: 5px 0;
                min-height: 44px; /* Minimum touch target size */
            }

            /* Stack label-input pairs */
            form label {
                display: block;
                margin-bottom: 5px;
            }

            /* Adjust spacing for stacked elements */
            h2, h3 {
                margin-top: 20px;
                margin-bottom: 10px;
            }
        }

        /* Additional adjustments for very small screens */
        @media screen and (max-width: 480px) {
            /* Further reduce font sizes */
            body {
                font-size: 14px;
            }

            header h1 {
                font-size: 1.2rem;
            }

            /* Stack table cells for better readability */
            #employee-penalty-table td,
            #application-status-table td {
                padding: 6px;
            }

            /* Adjust modal for smaller screens */
            .proof-modal-content {
                width: 95%;
                margin: 2% auto;
            }

            /* Make sure buttons are easily tappable */
            button {
                min-height: 44px;
            }
        }

        /* Improve table scrolling on mobile */
        .table-container {
            width: 100%;
            overflow-x: auto;
            margin: 20px 0;
            padding-bottom: 10px; /* For scroll bar space */
        }

        /* Add visual indication of scrollable tables */
        .table-container::after {
            content: '⟺';
            position: absolute;
            right: 10px;
            color: #666;
            animation: scroll-hint 1s infinite;
            display: none;
        }

        @media screen and (max-width: 768px) {
            .table-container::after {
                display: block;
            }
        }

        @keyframes scroll-hint {
            0% { opacity: 0; }
            50% { opacity: 1; }
            100% { opacity: 0; }
        }

        /* Color variables */
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #34495e;
            --accent-color: #3498db;
            --light-bg: #f5f6fa;
            --text-color: #2c3e50;
            --border-color: #dcdde1;
        }

        /* Base styles */
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--light-bg);
            color: var(--text-color);
            line-height: 1.6;
        }

        header {
            background-color: var(--primary-color);
            color: white;
            text-align: center;
            padding: 1rem 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        header h1 {
            margin: 0;
            font-size: 1.8rem;
        }

        .container {
            max-width: 1100px;
            width: 95%;
            margin: 20px auto;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        /* Form styles */
        form {
            margin-top: 20px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 6px;
        }

        input[type="text"],
        input[type="password"],
        input[type="number"],
        input[type="date"],
        select {
            padding: 8px 12px;
            width: 100%;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
        }

        button {
            padding: 8px 16px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #2980b9;
        }

        button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }

        /* Table styles */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background-color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        th, td {
            padding: 12px 15px;
            border: 1px solid var(--border-color);
        }

        th {
            background-color: var(--secondary-color);
            color: white;
            font-weight: 500;
        }

        tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        /* Button variations */
        .remove-btn {
            background-color: #e74c3c;
            padding: 4px 8px;  /* Reduced padding */
            font-size: 12px;   /* Smaller font size */
            border-radius: 4px;
            min-height: unset; /* Remove minimum height if any */
            width: auto;       /* Allow button to size to content */
        }

        .remove-btn:hover {
            background-color: #c0392b;
        }

        .show-proof-btn {
            background-color: #27ae60;
        }

        .show-proof-btn:hover {
            background-color: #219a52;
        }

        #proof-modal img {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px;
            background-color: white;
        }

        /* Add smooth animation to modal */
        #proof-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            /* Ensure modal is centered */
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #proof-modal.show {
            opacity: 1;
        }

        .status-approved {
            color: green;
            font-weight: bold;
        }

        .status-rejected {
            color: red;
            font-weight: bold;
        }

        .status-pending {
            color: #ffc107;
            font-weight: bold;
        }

        .reject-btn {
            background-color: #e74c3c;
            padding: 4px 8px;
            font-size: 12px;
            margin-top: 5px;
        }

        .reject-btn:hover {
            background-color: #c82333;
        }

        /* Update the flex container for buttons */
        .d-flex.flex-column > div {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }

        .leave-activity {
            background-color: #FF69B4 !important; /* Hot pink for activity leave */
            border-color: #FF69B4 !important;
            color: white !important;
        }

        /* Make all action buttons consistent in size */
        .show-proof-btn,
        .reject-btn,
        .remove-btn-small {
            padding: 5px 10px;
            font-size: 12px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        /* Adjust button container spacing */
        .status-submitted,
        .status-not-submitted {
            margin-bottom: 5px;
        }

        /* Section headings */
        h2, h3 {
            color: var(--primary-color);
            margin-top: 30px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-color);
        }

        /* Company rules section */
        #home-page p {
            padding: 10px;
            background-color: #f8f9fa;
            border-left: 4px solid var(--accent-color);
            margin: 10px 0;
        }

        /* Employee information section */
        .employee-info-boxes {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* 3 boxes per row */
            gap: 20px;
            margin-top: 20px;
        }

        /* Individual square box styling */
        .info-box {
            background: #ffffff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 150px; /* Ensures the box is square */
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .info-box:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        /* Text inside the box */
        .info-box strong {
            font-size: 1rem;
            color: #0056b3;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .info-box p {
            font-size: 1rem;
            color: #555;
            margin: 0;
        }


        /* Special note styling */
        .note {
            background: #fff5e6;
            border: 1px solid #ffcc80;
            color: #d48806;
            font-weight: 500;
            text-align: center;
            margin-top: 20px;
            padding: 10px;
        }

        /* Scanner and message sections */
        .scanner-section,
        .scan-result {
            width: 100%;
            margin: 20px 0;
            padding: 20px;
            text-align: center;
            background: #f0f0f0;
            border: 1px dashed #ccc;
            border-radius: 8px;
        }

        .hidden {
            display: none;
        }

        /* Logout button */
        #logout-btn, #logout-btn-employee {
            background-color: #95a5a6;
            margin-top: 30px;
        }

        #logout-btn:hover, #logout-btn-employee:hover {
            background-color: #7f8c8d;
        }

        #scroll-to-bottom-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            width: 50px;
            height: 50px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        #scroll-to-bottom-btn.visible {
            opacity: 1.0;
            visibility: visible;
            pointer-events: auto;
        }

        #scroll-to-bottom-btn:hover {
            opacity: 1;
        }

        @media screen and (max-width: 768px) {
            #scroll-to-bottom-btn {
                bottom: 10px;
                right: 10px;
                width: 40px;
                height: 40px;
                font-size: 20px;
            }
        }

        /* Modal styles update */
        .proof-modal-content {
            background-color: white;
            padding: 20px;
            width: 90%;
            max-width: 700px;
            border-radius: 8px;
            position: relative;
            /* Center the modal and handle overflow */
            max-height: 90vh;
            overflow-y: auto;
            /* Add some animation */
            transform: translateY(-20px);
            transition: transform 0.3s ease-in-out;
        }

        #proof-modal.show .proof-modal-content {
            transform: translateY(0);
        }

        .close-modal-btn {
            position: absolute;
            right: 10px;
            top: 10px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            line-height: 1;
            color: #666;
            transition: color 0.3s ease;
        }

        .close-modal-btn:hover {
            color: #000;
        }

        .close-modal {
            color: #7f8c8d;
        }

        .close-modal:hover {
            color: var(--primary-color);
        }

        #proof-content img {
            max-width: 100%;
            max-height: 70vh;
            object-fit: contain;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px;
            background-color: white;
        }

        /* Responsive adjustments */
        @media screen and (max-width: 768px) {
            .proof-modal-content {
                width: 95%;
                margin: 10px;
                padding: 15px;
            }

            #proof-content img {
                max-height: 60vh;
            }
        }

        #penalty-form {
            display: grid;
            gap: 10px;
            margin-bottom: 20px;
        }

        #penalty-form select,
        #penalty-form input {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }

        #penalty-form button {
            justify-self: start;
        }

        #penalty-table {
            margin-top: 20px;
        }

        #penalty-reason {
            padding: 8px 12px;
            width: 100%;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
        }

        #penalty-form select,
        #penalty-form input {
            margin-bottom: 10px;
        }

        #employee-penalty-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background-color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        #employee-penalty-table th,
        #employee-penalty-table td {
            padding: 12px 15px;
            border: 1px solid var(--border-color);
        }

        #employee-penalty-table th {
            background-color: var(--secondary-color);
            color: white;
            font-weight: 500;
        }

        #employee-penalty-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .status-submitted {
            color: green;
            font-weight: bold;
        }

        .status-not-submitted {
            color: red;
            font-weight: bold;
        }

        .submit-proof-btn {
            margin-top: 5px;
            padding: 5px 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        .submit-proof-btn:hover {
            background-color: #45a049;
        }

        .view-proof-btn {
            margin-left: 10px;
            padding: 3px 8px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        .view-proof-btn:hover {
            background-color: #1976D2;
        }

        .status-submitted {
            color: green;
            font-weight: bold;
        }

        .status-not-submitted {
            color: red;
            font-weight: bold;
        }

        .view-proof-btn {
            margin-left: 10px;
            padding: 3px 8px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        .view-proof-btn:hover {
            background-color: #1976D2;
        }

        .cancel-double-btn {
        margin-left: 5px;
        padding: 3px 8px;
        background-color: #ff9800;
        color: white;
        border: none;
        border-radius: 3px;
        cursor: pointer;
        }

        .cancel-double-btn:hover {
            background-color: #f57c00;
        }

        /* Update button container styles */
        .d-flex.flex-column > div {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 5px;
        }

        /* Make all action buttons consistent in size */
        .show-proof-btn,
        .reject-btn,
        .cancel-double-btn,
        .remove-btn-small {
            padding: 5px 10px;
            font-size: 12px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
            white-space: nowrap;
        }

        .export-btn {
            background-color: #28a745;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }

        .export-btn:hover {
            background-color: #218838;
        }

        .add-btn {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }

        .add-btn:hover {
            background-color: #45a049;
        }

        .add-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        #change-password-form {
            max-width: 400px;
            margin-top: 20px;
        }

        #change-password-form input[type="password"] {
            width: 100%;
            padding: 8px 12px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
        }

        #change-password-form button {
            background-color: #2c3e50;
        }

        #change-password-form button:hover {
            background-color: #34495e;
        }

        .sync-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 4px;
            display: none;
            z-index: 1000;
            animation: fadeIn 0.3s ease-in-out;
        }

        .sync-status.success {
            background-color: #4CAF50;
            color: white;
        }

        .sync-status.error {
            background-color: #f44336;
            color: white;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .remove-btn-small {
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .remove-btn-small:hover {
            background-color: #c82333;
        }

        .d-flex {
            display: flex;
        }

        .flex-column {
            flex-direction: column;
        }

        .overdue-row {
            background-color: rgba(220, 53, 69, 0.1) !important; /* Light red background */
            color: #dc3545; /* Red text */
            font-weight: 500;
        }

        /* Alternate row colors but keep overdue highlighting */
        #penalty-table tbody tr:nth-child(even):not(.overdue-row) {
            background-color: #f8f9fa;
        }

        #penalty-table tbody tr:hover:not(.overdue-row) {
            background-color: #f2f2f2;
        }

        /* Keep overdue row styling even on hover */
        .overdue-row:hover {
            background-color: rgba(220, 53, 69, 0.15) !important;
        }

        .d-flex {
            display: flex;
        }

        #applicationListContainer {
            max-height: 2000px; /* Adjust this value based on your needs */
            overflow-y: auto;
            overflow-x: auto;
            margin: 20px 0;
            padding-bottom: 10px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        #applicationListContainer.collapsed {
            max-height: 0;
            opacity: 0;
            margin: 0;
            padding: 0;
            border: none;
        }

        #applicationListContainer.expanded {
            opacity: 1;
            margin-bottom: 20px;
        }

        .clear-records-btn {
            background-color: #dc3545;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 0;
            font-weight: bold;
        }

        .clear-records-btn:hover {
            background-color: #c82333;
        }

        .clear-records-btn:active {
            transform: translateY(1px);
        }

        .flex-column {
            flex-direction: column;
        }

        .status-submitted {
            color: green;
            font-weight: bold;
        }

        .status-not-submitted {
            color: red;
            font-weight: bold;
        }

        .remove-btn-small {
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .remove-btn-small:hover {
            background-color: #c82333;
        }

        /* Modern color palette */
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #34495e;
            --accent-color: #3498db;
            --success-color: #2ecc71;
            --warning-color: #f1c40f;
            --danger-color: #e74c3c;
            --light-bg: #f5f6fa;
            --card-bg: #ffffff;
            --text-primary: #2c3e50;
            --text-secondary: #7f8c8d;
            --border-radius: 8px;
        }

        /* Body background with gradient */
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }

        /* Header styling */
        header {
            background: linear-gradient(120deg, var(--primary-color), var(--secondary-color));
            padding: 1.5rem 0;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        header h1 {
            font-size: 2rem;
            font-weight: 600;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        /* Container styling */
        .container {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease;
            margin: 2rem auto;
            padding: 2rem;
        }

        .container:hover {
            transform: translateY(-5px);
        }

        /* Form styling */
        form {
            background: var(--light-bg);
            border-radius: var(--border-radius);
            padding: 2rem;
            margin: 1.5rem 0;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        input[type="text"],
        input[type="password"],
        input[type="number"],
        input[type="date"],
        select {
            border: 2px solid #eee;
            border-radius: var(--border-radius);
            padding: 0.8rem 1rem;
            transition: all 0.3s ease;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        input:focus,
        select:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
            outline: none;
        }

        /* Button styling */
        button {
            padding: 0.8rem 1.5rem;
            border-radius: var(--border-radius);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        button:active {
            transform: translateY(0);
        }

        /* Table styling */
        table {
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        th {
            background: linear-gradient(120deg, var(--primary-color), var(--secondary-color));
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 1rem 1.5rem;
        }

        td {
            padding: 1rem 1.5rem;
            transition: background-color 0.3s ease;
        }

        tr:hover td {
            background-color: rgba(52, 152, 219, 0.05);
        }

        /* Status badges */
        .status-submitted,
        .status-approved,
        .status-rejected,
        .status-pending,
        .status-not-submitted {
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
            display: inline-block;
        }

        .status-submitted,
        .status-approved {
            background-color: rgba(46, 204, 113, 0.1);
            color: #27ae60;
        }

        .status-rejected,
        .status-not-submitted {
            background-color: rgba(231, 76, 60, 0.1);
            color: #c0392b;
        }

        .status-pending {
            background-color: rgba(241, 196, 15, 0.1);
            color: #f39c12;
        }

        .status-late {
            color: #dc2626 !important; /* Red color */
            font-weight: 700 !important;
        }

        /* Status badges with enhanced styling */
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            line-height: 1.25rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
        }

        .status-badge.punctual {
            background-color: #def7ec;
            color: #03543f;
        }

        .status-badge.late {
            background-color: #fde8e8;
            color: #dc2626;
            font-weight: 700;
        }

        .status-badge.unknown {
            background-color: #6B7280;
            color: white;
        }

        /* For the penalty amount */
        .penalty-amount {
            color: #dc2626;
            font-weight: 600;
            margin-left: 0.25rem;
        }

        /* Modal styling */
        .proof-modal-content {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            padding: 2rem;
        }

        .draggable {
            cursor: move;
        }

        .drag-over {
            border: 2px dashed #2196F3 !important;
            background-color: rgba(33, 150, 243, 0.1) !important;
        }

        .dragging {
            opacity: 0.5;
            background-color: #f8f9fa;
        }

        /* Add this to make the first cell (name cell) act as the drag handle */
        .drag-handle {
            position: relative;
            cursor: move;
            padding-left: 35px !important; /* Increased padding to make room for the handle */
        }

        .drag-handle::before {
            content: "⋮⋮";
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 20px;
            color: #666;
            opacity: 0.7;
            line-height: 1;
            cursor: move;
            user-select: none;
            pointer-events: auto;
        }

        .edit-select {
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
            font-size: 14px;
            width: 100%;
            max-width: 150px;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }

        .edit-select:hover {
            border-color: #aaa;
        }

        .edit-select:focus {
            border-color: #2196F3;
            outline: none;
            box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.1);
        }

        .edit-select option {
            padding: 8px;
        }

        .collapse-btn {
            background-color: #2c3e50;
            border: 1px solid #dee2e6;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .collapse-btn:hover {
            background-color: #e9ecef;
        }

        .collapse-icon {
            display: inline-block;
            transition: transform 0.3s ease;
        }

        .collapse-btn.collapsed .collapse-icon {
            transform: rotate(-90deg);
        }

        .button-group {
            display: flex;
            gap: 5px;
        }

        .adjust-btn {
            padding: 6px 12px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .adjust-btn:hover {
            background-color: #45a049;
        }

        .adjust-btn.save-btn {
            background-color: #2196F3;
        }

        .adjust-btn.save-btn:hover {
            background-color: #1976D2;
        }

        .editable-cell {
            position: relative;
        }

        .display-text {
            padding: 6px 8px;
            display: block;
        }

        .adjust-amount-btn {
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            padding: 5px 10px;
            font-size: 12px;
        }

        .adjust-amount-btn:hover {
            background-color: #1976D2;
        }

        .edit-select {
            display: none;
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
            font-size: 14px;
            cursor: pointer;
        }

        .edit-select:focus {
            border-color: #2196F3;
            outline: none;
            box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.1);
        }

        /* Make sure the edit select boxes are properly sized */
        .editable-cell .edit-select {
            min-width: 120px;
            max-width: 200px;
        }

        /* Style for the cell when in edit mode */
        .editable-cell.editing {
            background-color: #f8f9fa;
        }

        .edit-input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            margin: 0;
        }

        .edit-input:focus {
            border-color: #2196F3;
            outline: none;
            box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.1);
        }

        /* Ensure proper spacing in table cells */
        .editable-cell {
            padding: 8px !important;
            min-width: 120px;
        }

        .calendar-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin: 20px 0;
        }

        .calendar-container.collapsed {
            max-height: 0;
            padding: 0;
            margin: 0;
            opacity: 0;
        }

        #leave-calendar {
            width: 100%;
            height: 600px;
        }

        .leave-special-approve {
            background-color: #9E9E9E !important; /* Grey color for Special Approve */
            border-color: #9E9E9E !important;
            color: white !important;
        }

        .fc .fc-toolbar {
            display: flex !important;
            justify-content: space-between !important;
            padding: 10px !important;
        }

        .fc .fc-toolbar-title {
            font-size: 1.2em !important;
            margin: 0 !important;
        }

        /* Ensure calendar grid is visible */
        .fc .fc-daygrid-body {
            width: 100% !important;
        }

        .fc .fc-daygrid-day-frame {
            min-height: 100px !important;
        }

        .fc { /* the calendar root */
            max-width: 100%;
            height: auto !important;
            background: white;
            padding: 10px;
            border-radius: 8px;
        }

        .fc-event {
            margin: 2px 0;
            padding: 4px 6px;
            border-radius: 4px;
            font-size: 0.9em;
            white-space: normal !important; /* Allow text wrapping */
        }

        .fc-daygrid-event {
            height: auto !important; /* Ensure events take up appropriate space */
        }

        .fc-event-title {
            font-size: 0.85em;
            white-space: normal !important; /* Allow text to wrap */
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 2px;
        }

        .fc-day-today {
            background-color: rgba(52, 152, 219, 0.1) !important;
        }

        .fc-header-toolbar {
            margin-bottom: 1.5em !important;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .fc-toolbar-chunk {
            display: flex;
            gap: 0.5rem;
        }

        .fc-button {
            background-color: var(--primary-color) !important;
            border: none !important;
            border-radius: 4px !important;
            padding: 0.5rem 1rem !important;
            font-size: 0.875rem !important;
        }

        .fc-button:hover {
            background-color: var(--accent-color) !important;
        }

        .fc-button-active {
            background-color: var(--accent-color) !important;
        }

        #penaltyListContainer.collapsed {
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            margin: 0;
            padding: 0;
            border: none;
            transition: all 0.3s ease;
        }

        #penaltyListContainer.expanded {
            max-height: 2000px;
            opacity: 1;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .success-animation {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.2);
            z-index: 2000;
        }

        .checkmark {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: block;
            stroke-width: 2;
            stroke: #4CAF50;
            stroke-miterlimit: 10;
            box-shadow: inset 0px 0px 0px #4CAF50;
            animation: fill .4s ease-in-out .4s forwards, scale .3s ease-in-out .9s both;
            margin: 0 auto;
        }

        .checkmark__circle {
            stroke-dasharray: 166;
            stroke-dashoffset: 166;
            stroke-width: 2;
            stroke-miterlimit: 10;
            stroke: #4CAF50;
            fill: none;
            animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
        }

        .checkmark__check {
            transform-origin: 50% 50%;
            stroke-dasharray: 48;
            stroke-dashoffset: 48;
            animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards;
        }

        @keyframes stroke {
            100% { stroke-dashoffset: 0; }
        }

        @keyframes scale {
            0%, 100% { transform: none; }
            50% { transform: scale3d(1.1, 1.1, 1); }
        }

        @keyframes fill {
            100% { box-shadow: inset 0px 0px 0px 30px #4CAF50; }
        }

        #calendar-legend {
            margin-bottom: 1rem;
            padding: 0.5rem;
            border-radius: 4px;
            background-color: #f8f9fa;
        }

        #calendar-legend .flex {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
        }

        #calendar-legend .flex > div {
            display: flex;
            align-items: center;
            margin-right: 1rem;
        }

        #calendar-legend .w-4 {
            width: 1rem;
            height: 1rem;
            margin-right: 0.5rem;
            border-radius: 0.25rem;
        }

        .leave-annual-normal {
            background-color: #4CAF50 !important; /* Green */
            border-color: #4CAF50 !important;
            color: white !important;
        }
        .leave-annual-golden {
            background-color: #FFC107 !important; /* Yellow */
            border-color: #FFC107 !important;
            color: black !important;
        }
        .leave-sick {
            background-color: #F44336 !important; /* Red */
            border-color: #F44336 !important;
            color: white !important;
        }
        .leave-force-majeure {
            background-color: #9C27B0 !important; /* Purple */
            border-color: #9C27B0 !important;
            color: white !important;
        }
        .leave-overseas {
            background-color: #2196F3 !important; /* Blue */
            border-color: #2196F3 !important;
            color: white !important;
        }
        .leave-special-approve {
            background-color: #9E9E9E !important; /* Grey */
            border-color: #9E9E9E !important;
            color: white !important;
        }
        .leave-activity {
            background-color: #FF69B4 !important; /* Pink */
            border-color: #FF69B4 !important;
            color: white !important;
        }
        .leave-default {
            background-color: #607D8B !important; /* Greyish-blue fallback */
            border-color: #607D8B !important;
            color: white !important;
        }

        .compensate-btn {
            background-color: #3498db;
            padding: 4px 8px;
            font-size: 12px;
            border-radius: 4px;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .compensate-btn:hover {
            background-color: #2980b9;
        }

        .reduce-btn {
            background-color: #fff600;
            padding: 4px 8px;
            font-size: 12px;
            border-radius: 4px;
            color: black;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .reduce-btn:hover {
            background-color: #fff000 ;
        }

        .filter-container {
            background-color: #ffffff;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 0.5rem;
        }

        .filter-group {
            min-width: 150px;
        }

        .filter-group select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            background-color: white;
        }

        .filter-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
        }

        #resetFilters {
            background-color: #6b7280;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        #resetFilters:hover {
            background-color: #4b5563;
        }

        #attendanceRecordsContainer {
            max-height: 2000px; /* Adjust this value based on your needs */
            overflow-y: auto;
            overflow-x: auto;
            margin: 20px 0;
            padding-bottom: 10px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        #attendanceRecordsContainer.collapsed {
            max-height: 0;
            opacity: 0;
            margin: 0;
            padding: 0;
            border: none;
        }

        #attendanceRecordsContainer.expanded {
            opacity: 1;
            margin-bottom: 20px;
        }

        .bg-red-600 {
            background-color: #dc2626;
        }

        .hover\:bg-red-700:hover {
            background-color: #b91c1c;
        }

        .focus\:ring-red-500:focus {
            --tw-ring-color: rgba(239, 68, 68, 0.5);
        }

        #clearAttendanceBtn {
            transition: all 0.2s ease-in-out;
        }

        #clearAttendanceBtn:hover {
            transform: translateY(-1px);
        }

        #clearAttendanceBtn:active {
            transform: translateY(1px);
        }

        /* Animation for the table container */
        #agentListContainer {
            max-height: 400px; /* You can adjust this value to your preferred height */
            overflow-y: auto;
            overflow-x: auto;
            margin: 20px 0;
            padding-bottom: 10px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
        }

        #employee-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        #employee-table thead th {
            position: sticky;
            top: 0;
            background: linear-gradient(120deg, var(--primary-color), var(--secondary-color));
            z-index: 1;
            padding: 15px;
        }

        /* Add some spacing between rows */
        #employee-table tbody tr {
            border-bottom: 1px solid #dee2e6;
        }

        #employee-table tbody tr:last-child {
            border-bottom: none;
        }

        #employee-table td {
            padding: 12px;
            vertical-align: middle;
        }

        #employee-table tbody tr:hover {
            background-color: rgba(52, 152, 219, 0.05);
        }

        #employee-table th:nth-child(3), #employee-table td:nth-child(3) { /* Role column */
            width: 70px !important; /* Adjust as needed */
            min-width: 70px !important; /* Ensure minimum width */
        }

        #employee-table th:nth-child(4), #employee-table td:nth-child(4) { /* Clubs & Awards column */
            width: 100px !important; /* Adjust as needed */
            min-width: 100px !important; /* Ensure minimum width */
        }

        #agentListContainer::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        #agentListContainer::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        #agentListContainer::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        #agentListContainer::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        #agentListContainer.collapsed {
            max-height: 0;
            opacity: 0;
            margin: 0;
            padding: 0;
        }

        #agentListContainer.expanded {
            max-height: 2000px; /* Adjust this value based on your needs */
            opacity: 1;
            margin-bottom: 20px;
        }

        tr:hover .drag-handle::before {
            opacity: 1;
            color: #333;
        }

        /* Ensure the handle is visible in all states */
        tr.dragging .drag-handle::before {
            opacity: 1;
            color: #2196F3;
        }

        /* Section headings */
        h2, h3 {
            color: var(--text-primary);
            font-weight: 600;
            position: relative;
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
        }

        h2::after, h3::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 50px;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-color), transparent);
            border-radius: 3px;
        }

        /* Employee info styling */
        #employee-page p {
            border-radius: var(--border-radius);
            padding: 1rem;
            margin: 0.5rem 0;
            transition: transform 0.3s ease;
        }

        #employee-page p:hover {
            transform: translateX(5px);
        }

        .year-filter-btn {
            transition: all 0.2s ease-in-out;
        }

        .year-filter-btn.active {
            background-color: var(--accent-color);
            transform: translateY(-1px);
        }

        .year-filter-btn:hover {
            transform: translateY(-1px);
        }

        .year-filter-btn:active {
            transform: translateY(1px);
        }

        #success-notice {
            display: none;
            color: green;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid green;
            border-radius: 5px;
            background-color: #e6ffe6;
        }

    </style>
</head>

<body>
    <div id="sync-status" class="sync-status"></div>
    <header>
    <h1>S-Next 請假及賀金系統</h1>
    </header>
    <div class="container" id="home-page">
        <h3>Login</h3>
        <form id="login-form">
            <input type="text" id="username" placeholder="Username" required>
            <input type="password" id="password" placeholder="Password" required>
            <p><strong>Username 請輸入自己名字 e.g. Sam Hui **記得中間有空格！！！**</span></p>
            <p><strong>Password 請輸入 next(your agent code) e.g. nextA12345 **Agent Code有英文字母要大楷**</span></p>
            <button type="submit">Login</button>
        </form>
    </div>

    <div class="container" id="admin-page" style="display: none;">
        <!-- Section 1: Add Agent, Add Leave Record, and Add Penalty -->
        <div class="container">
            <h2>Admin Interface</h2>
            <button id="show-qr-code" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded mt-4">
                Show Attendance QR Code
            </button>
            <h3>Add Agents</h3>
            <form id="add-employee-form">
                <input type="text" id="emp-name" placeholder="Agent Name" required>
                <input type="text" id="emp-code" placeholder="Agent Code" required>
                <label for="emp-role">Role position:</label>
                <select id="emp-role" required>
                    <option value="Agent">Agent</option>
                    <option value="AUM/UM">AUM/UM</option>
                    <option value="SUM">SUM</option>
                    <option value="BM">BM</option>
                    <option value="DM">DM</option>
                    <option value="DD">DD</option>
                </select>
                <label for="emp-mdrt">Clubs & Awards</label>
                <select id="emp-mdrt" required>
                    <option value="no">NO</option>
                    <option value="mdrt">MDRT</option>
                    <option value="cot or above">COT or above</option>
                </select>
                <label for="emp-team">Team:</label>
                <select id="emp-team" required>
                    <option value="">Select Team</option>
                    <option value="Honour">Honour</option>
                    <option value="Bee">Bee</option>
                    <option value="Novas">Novas</option>
                    <option value="Define">Define</option>
                    <option value="Belong">Belong</option>
                    <option value="Ride">Ride</option>
                    <option value="Ark">Ark</option>
                    <option value="Giant">Giant</option>
                </select>
                <label for="emp-team-leader">
                    <input type="checkbox" id="emp-team-leader"> Team Leader?????????
                </label>
                <button type="button" id="add-employee-btn" class="add-btn">Add Agent</button>
            </form>
    
            <h3>Add Leave Record</h3>
            <form id="admin-leave-form">
                <select id="admin-leave-employee" required>
                    <option value="">Select Agent</option>
                </select>
                <label for="admin-apply-date">Apply Date:</label>
                <input type="date" id="admin-apply-date" required>
                <label for="admin-leave-start-date">Leave Start Date:</label>
                <input type="date" id="admin-leave-start-date" required>
                <label for="admin-leave-end-date">Leave End Date:</label>
                <input type="date" id="admin-leave-end-date" required>
                <label for="admin-leave-type">Leave Type:</label>
                <select id="admin-leave-type" required>
                    <option value="Annual Leave (Normal)">Annual Leave (Normal)</option>
                    <option value="Annual Leave (黃金事假)">Annual Leave (黃金事假)</option>
                    <option value="Sick Leave">Sick Leave</option>
                    <option value="不可抗力因素">不可抗力因素</option>
                    <option value="離港">離港</option>
                    <option value="Special Approve">Special Approve</option>
                    <option value="活動請假">活動請假</option>
                </select>
                <div id="admin-force-majeure-options" style="display: none;">
                    <label for="admin-force-majeure-reason">Reason:</label>
                    <select id="admin-force-majeure-reason">
                        <option value="">Select a reason</option>
                        <option value="大學生考試">大學生考試</option>
                        <option value="IIQE PAPER 1 & 3 考試">IIQE PAPER 1 & 3 考試</option>
                        <option value="擔任公司/其他區域的分享嘉賓及伴同出席分享的同事">擔任公司/其他區域的分享嘉賓及伴同出席分享的同事</option>
                        <option value="參加公司活動(只有一個時間)">參加公司活動(只有一個時間)</option>
                        <option value="參加頒獎典禮及領獎">參加頒獎典禮及領獎</option>
                        <option value="CIAM課程">CIAM課程</option>
                        <option value="PA/EDP/PA & EDP Elite/FP/新UM課程">PA/EDP/PA & EDP Elite/FP/新UM課程</option>
                        <option value="正日莊務">正日莊務</option>
                        <option value="考車正日">考車正日</option>
                        <option value="直系親屬紅白二事(包括自己結婚)">直系親屬紅白二事(包括自己結婚)</option>
                        <option value="陪同行動不便的父母、子女、配偶見醫生(需當日提供合理證明)">陪同行動不便的父母、子女、配偶見醫生(需當日提供合理證明)</option>
                        <option value="陪同寵物見醫生(同事是唯一照顧者&需當日提供合理證明)">陪同寵物見醫生(同事是唯一照顧者&需當日提供合理證明)</option>
                    </select>
                </div>
                <div id="admin-proof-container" style="display: none;">
                    <label for="admin-proof-file">Proof:</label>
                    <input type="file" id="admin-proof-file" accept="image/*">
                </div>
                <button type="submit">Add Leave Record</button>
            </form>
    
            <h3>Add 賀金</h3>
            <form id="penalty-form">
                <select id="penalty-employee" required>
                    <option value="">Select Agent</option>
                </select>
                <input type="date" id="penalty-date" required>
                <select id="penalty-reason" required>
                    <option value="Meeting">Meeting</option>
                </select>
                <input type="number" id="penalty-minutes" placeholder="Late Minutes" min="0" required>
                <p><strong>備註：No Show請輸入500</span></p>
                <button type="submit">Add 賀金</button>
            </form>
        </div>
    
        <div class="container">
            <h3>Agent List</h3>
            <div style="margin-bottom: 10px;">
                <button id="toggleAgentList" class="collapse-btn">
                    <span class="collapse-icon">▼</span> Collapse Agent List
                </button>
            </div>
            <div id="agentListContainer" class="table-container">
                <table id="employee-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Code</th>
                            <th>Role</th>
                            <th>Clubs & Awards</th>
                            <th>Remaining Annual Leaves (Normal)</th>
                            <th>Remaining Annual Leaves (黃金事假)</th>
                            <th>Team</th>
                            <th>Team Leader</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="employee-list">
                        <!-- Rows will be dynamically added here -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Section 3: Agent Leave Application Record -->
        <div class="container">
            <h3>Agent Leave Application Record</h3>
        
            <div class="export-buttons" style="margin-top: 20px;">
                <button id="export-applications-btn" class="export-btn">Export Applications to Excel</button>
                <button id="clearRecordsBtn" class="clear-records-btn">Clear All Leave Records</button>
            </div>
        
            <div class="filter-container p-4 bg-white shadow-sm rounded-lg mb-4">
                <div class="flex flex-wrap gap-4">
                    <!-- Agent filter -->
                    <div class="filter-group">
                        <label for="application-employee-filter" class="block text-sm font-medium text-gray-700 mb-1">Agent</label>
                        <select id="application-employee-filter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                            <option value="">All Agents</option>
                        </select>
                    </div>
                        
                    <!-- Reset button -->
                    <div class="flex items-end">
                        <button id="resetFilters" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">
                            Reset Filter
                        </button>
                    </div>                    

                    <!-- Date filter -->
                    <div>
                        <label for="applicationdateFilter" class="block text-sm font-medium text-gray-700">Date Filter</label>
                        <input type="date" id="applicationdateFilter" value="">
                    </div>

                </div>
            </div>

            <div class="year-filter-container p-4 bg-white shadow-sm rounded-lg mb-4">
                <div class="flex items-center gap-4">
                    <span class="text-sm font-medium text-gray-700">Filter by Year:</span>
                    <button id="filter-year-2025" class="year-filter-btn bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">2025</button>
                    <button id="filter-year-2026" class="year-filter-btn bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">2026</button>
                    <button id="filter-year-2027" class="year-filter-btn bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">2027</button>
                    <button id="filter-year-2028" class="year-filter-btn bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">2028</button>
                </div>
                <div style="height: 2rem;"></div> <!-- Spacer div -->
            </div>

            <div style="margin-bottom: 10px;">
                <button id="toggleApplicationList" class="collapse-btn">
                    <span class="collapse-icon">▼</span> Collapse Application List
                </button>
            </div>

            <div class="table-container applications-container" id="applicationListContainer">
                <table id="application-list-table">
                    <thead>
                        <tr>
                            <th>Agent Name</th>
                            <th>Apply Date</th>
                            <th>Leave Start Date</th>
                            <th>Leave End Date</th>
                            <th>Leave Type</th>
                            <th>Status</th>
                            <th>Proof</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="application-list-body"></tbody>
                </table>
            </div>
        </div>
        
        <div class="container">
            <h3>All Agents Attendance Records</h3>
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <div class="bg-white shadow rounded-lg">
                    <!-- Filter controls -->
                    <div class="p-4 bg-gray-50 border-b border-gray-200">
                        <div class="flex flex-wrap gap-4 items-center">
                            <div class="flex-1 min-w-md">
                                <label for="dateFilter" class="block text-sm font-medium text-gray-700">Date Filter</label>
                                <input type="date" id="dateFilter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                            </div>
                            <div class="flex-1 min-w-md">
                                <label for="statusFilter" class="block text-sm font-medium text-gray-700">Status</label>
                                <select id="statusFilter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                    <option value="">All</option>
                                    <option value="Punctual">Punctual</option>
                                    <option value="Late">Late</option>
                                </select>
                            </div>
                            <div class="flex-1 min-w-md">
                                <label for="attendanceEmployeeFilter" class="block text-sm font-medium text-gray-700">Agent</label>
                                <select id="attendanceEmployeeFilter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                    <option value="">All Agents</option>
                                </select>
                            </div>
                            <div class="flex items-end gap-10">
                                <button id="resetFilters" class="mt-6 px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                    Reset Filters
                                </button>
                                <button id="clearAttendanceBtn" class="mt-6 px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                                    Clear All Attendance Records
                                </button>
                                <button id="toggleAttendanceRecords" class="collapse-btn mt-6">
                                    <span class="collapse-icon">▼</span> Collapse Attendance Records
                                </button>
                            </div>
                        </div>
                    </div>
        
                    <!-- Table Container -->
                    <div id="attendanceRecordsContainer" class="expanded">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Agent Name
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Role
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Date & Time
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Status
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            IP Address
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Action
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="allAttendanceTableBody" class="bg-white divide-y divide-gray-200">
                                    <!-- Records will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Section 4: 賀金 Info -->
        <div class="container">
            <h3>賀金 Info</h3>

            <div style="margin-bottom: 10px;">
                <label for="penaltyStatusFilter">Filter by Status: </label>
                <select id="penaltyStatusFilter" onchange="filterPenaltyTable()">
                    <option value="All">All</option>
                    <option value="Submitted">Submitted</option>
                    <option value="Not Submitted">Not Submitted</option>
                </select>
                <label for="penaltyDateFilter">Filter by Date: </label>
                <input type="date" id="penaltyDateFilter" onchange="filterPenaltyTable()">
                <button onclick="resetPenaltyFilter()">Reset Status</button>
            </div>

            <div class="export-buttons" style="margin-top: 20px; margin-bottom: 10px;">
                <button id="export-penalties-btn" class="export-btn">Export Penalties to Excel</button>
            </div>
            <div style="margin-bottom: 10px;">
                <button id="togglePenaltyList" class="collapse-btn">
                    <span class="collapse-icon">▼</span> Collapse 賀金 Info
                </button>
            </div>
        
            <div id="penaltyListContainer" class="table-container expanded">
                <table id="penalty-table">
                    <thead>
                        <tr>
                            <th>Agent Name</th>
                            <th>Date</th>
                            <th>Reason</th>
                            <th>Late Minutes</th>
                            <th>Amount</th>
                            <th>Deadline</th>
                            <th>Status/Action</th>
                        </tr>
                    </thead>
                    <tbody id="penalty-list"></tbody>
                </table>
            </div>
        </div>
        
        <!-- Section 5: Change Admin Password -->
        <div class="container">
            <h3>Change Admin Password</h3>
            <form id="change-password-form">
                <input type="password" id="current-password" placeholder="Current Password" required>
                <input type="password" id="new-password" placeholder="New Password" required>
                <input type="password" id="confirm-password" placeholder="Confirm New Password" required>
                <button type="submit" class="add-btn">Change Password</button>
            </form>
        </div>
        
        <!-- Proof Modal -->
        <div id="proof-modal" style="display: none;">
            <div class="proof-modal-content">
                <button onclick="closeProofModal()" class="close-modal-btn">×</button>
                <h3 style="margin-bottom: 20px;">Proof Submitted</h3>
                <div id="proof-content" style="text-align: center;">
                    <!-- Proof image will be displayed here -->
                </div>
            </div>
        </div>
        
        <!-- Scroll to Bottom Button -->
        <button id="scroll-to-bottom-btn" style="position: fixed; bottom: 20px; right: 20px; z-index: 1000; padding: 10px; border-radius: 50%; width: 50px; height: 50px; background-color: var(--primary-color); color: white; border: none; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); display: flex; justify-content: center; align-items: center;">
            ↓
        </button>
        
        <!-- Logout Button -->
        <button id="logout-btn">Logout</button>
        </div>

    <div class="container" id="employee-page" style="display: none;">
    <h2>Agent Information</h2>

    <div class="text-center mt-4">
        <button onclick="startScanning()" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg text-lg shadow-lg">
            Take Attendance
        </button>

        <button onclick="loadEmployeeDetails()" class="bg-green-500 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg text-lg shadow-lg">
            Load All Data
        </button>
        <span id="reminderText" class="mt-2 text-sm text-gray-600 hidden">
            This may take a few minutes...
        </span>
        
    </div>
  
    <!-- Add this div for the scanner -->
    <div id="reader" class="scanner-section hidden"></div>
    
    <!-- Add this for success/failure messages -->
    <div id="scan-result" class="scan-result hidden"></div>

    <!-- Employee Information Table -->
    <div class="employee-info-boxes">
        <div class="info-box">
            <strong>Name</strong>
            <p id="employee-name"></p>
        </div>
        <div class="info-box">
            <strong>Code</strong>
            <p id="employee-code"></p>
        </div>
        <div class="info-box">
            <strong>Role</strong>
            <p id="employee-role"></p>
        </div>
        <div class="info-box">
            <strong>Clubs & Awards</strong>
            <p id="employee-mdrt"></p>
        </div>
        <div class="info-box">
            <strong>Annual Leaves (Normal)</strong>
            <p id="employee-leave-normal"></p>
        </div>
        <div class="info-box">
            <strong>Annual Leaves (黃金事假)</strong>
            <p id="employee-leave-golden"></p>
        </div>
        <div class="info-box">
            <strong>Remaining Annual Leaves (Normal)</strong>
            <p id="remaining-leave-normal"></p>
        </div>
        <div class="info-box">
            <strong>Remaining Annual Leaves (黃金事假)</strong>
            <p id="remaining-leave-golden"></p>
        </div>
        <div class="info-box">
            <strong>Applied Leaves for 區會 (Monday)</strong>
            <p id="used-monday-leaves">0</p>
        </div>        
        <div class="info-box">
            <strong>Used Sick Leave Days</strong>
            <p id="used-sick-leave">0</p>
        </div>
        <div class="info-box">
            <strong>Used 不可抗力因素 Days</strong>
            <p id="used-force-majeure">0</p>
        </div>
        <div class="info-box">
            <strong>Used 離港 Days</strong>
            <p id="used-overseas">0</p>
        </div>
    </div>
    <!-- Note -->
    <p class="note">備註：Annual Leaves (黃金事假)包含於Annual Leaves (Normal)之內</p>    

    <!-- Update the leave application form -->
    <h3>Apply for Leave</h3>
    <form id="apply-leave-form">
        <label for="apply-date">Apply Date:</label>
        <input type="date" id="apply-date" required>
        <label for="leave-start-date">Leave Start Date:</label>
        <input type="date" id="leave-start-date" required>
        <label for="leave-end-date">Leave End Date:</label>
        <input type="date" id="leave-end-date" required>
        <p>
        <label for="leave-type">Leave Type:</label>
        <select id="leave-type" required>
            <option value="Annual Leave (Normal)">Annual Leave (Normal)</option>
            <option value="Annual Leave (黃金事假)">Annual Leave (黃金事假)</option>
            <option value="Sick Leave">Sick Leave</option>
            <option value="不可抗力因素">不可抗力因素</option>
            <option value="離港">離港</option>
            <option value="Special Approve">Special Approve</option>
            <option value="活動請假">活動請假</option>
        </select>
        <div id="force-majeure-options" style="display: none;">
            <label for="force-majeure-reason">Reason:</label>
            <select id="force-majeure-reason">
                <option value="">Select a reason</option>
                <option value="大學生考試">大學生考試</option>
                <option value="IIQE PAPER 1 & 3 考試">IIQE PAPER 1 & 3 考試</option>
                <option value="擔任公司/其他區域的分享嘉賓及伴同出席分享的同事">擔任公司/其他區域的分享嘉賓及伴同出席分享的同事</option>
                <option value="參加公司活動(只有一個時間)">參加公司活動(只有一個時間)</option>
                <option value="參加頒獎典禮及領獎">參加頒獎典禮及領獎</option>
                <option value="CIAM課程">CIAM課程</option>
                <option value="PA/EDP/PA & EDP Elite/FP/新UM課程">PA/EDP/PA & EDP Elite/FP/新UM課程</option>
                <option value="正日莊務">正日莊務</option>
                <option value="考車正日">考車正日</option>
                <option value="直系親屬紅白二事(包括自己結婚)">直系親屬紅白二事(包括自己結婚)</option>
                <option value="陪同行動不便的父母、子女、配偶見醫生(需當日提供合理證明)">陪同行動不便的父母、子女、配偶見醫生(需當日提供合理證明)</option>
                <option value="陪同寵物見醫生(同事是唯一照顧者&需當日提供合理證明)">陪同寵物見醫生(同事是唯一照顧者&需當日提供合理證明)</option>
            </select>
        </div>
        <div id="proof-container" style="display: none;">
            <label for="proof-file">Proof:</label>
            <input type="file" id="proof-file" accept="image/*">
        </div>
        <button type="submit" id="apply-button">Apply</button>
    </form>
    <div id="success-notice" style="display: none; color: green; margin-top: 10px;">
    Your application was submitted successfully. Please do not click again to avoid duplicate records.
    </div>

    <div class="container mx-auto p-4 mt-8">
        <h3>Application Status</h3>
        <div class="table-container">
            <table id="application-status-table">
            <tr>
                <th>Apply Date</th>
                <th>Leave Start Date</th>
                <th>Leave End Date</th>
                <th>Leave Type</th>
                <th>Status</th>
            </tr>
            </table>
        </div>
    </div>

    <div class="container" id="team-leader-section" style="display: none; margin-top: 20px;">
        <h3>Team Leave Application Record</h3>
        <div class="table-container">
            <div>
                <label for="date-filter">Date Filter:</label>
                <input type="date" id="date-filter" style="width: 950px">            
            </div>
            <div>
                <label for="agent-filter">Agent:</label>
                <select id="agent-filter">
                    <option value="">All Agents</option>
                </select>
            </div>
        </div>

        <div class="table-container">
            <table id="team-leave-table">
                <thead>
                    <tr>
                        <th>Agent Name</th>
                        <th>Apply Date</th>
                        <th>Leave Start Date</th>
                        <th>Leave End Date</th>
                        <th>Leave Type</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="team-leave-list">
                    <!-- Team leave applications will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Attendance Record Section -->
    <div class="container mx-auto p-4 mt-8">
        <h2 class="text-2xl font-bold mb-4">Attendance Record</h2>
        <div class="overflow-x-auto bg-white rounded-lg shadow">
            <table class="min-w-full table-auto">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date & Time</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                    </tr>
                </thead>
                <tbody id="attendanceTableBody" class="bg-white divide-y divide-gray-200">
                    <!-- Records will be inserted here -->
                </tbody>
            </table>
        </div>
    </div>

    <div class="container mx-auto p-4 mt-8">
        <h3>賀金 Info *14/4 起計*</h3>
        <div class="table-container">
            <table id="employee-penalty-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Reason</th>
                        <th>Late Minutes</th>
                        <th>Amount</th>
                        <th>Deadline</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="employee-penalty-list"></tbody>
            </table>
        </div>
    </div>

    <div id="penalty-total" style="text-align: right; margin-top: 10px; padding: 10px; background-color: #f8f9fa; border-radius: 4px;">
        <strong>Total (Not Submitted): $<span id="penalty-sum">0</span></strong>
    </div>
    
    <input type="file" id="proof-upload" accept="image/*" style="display: none;">

    <!-- Move the logout button downwards -->
    <div style="margin-top: 20px;">
        <button id="logout-btn-employee">Logout</button>
    </div>

    <div id="sync-status" style="position: fixed; bottom: 10px; right: 10px; padding: 8px; border-radius: 4px; background: #2ecc71; color: white; display: none;">
        Changes synced ✓
    </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/11.3.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.3.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.3.1/firebase-auth-compat.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>

    <script>

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCzHtfZxBlFCdIeu0-omlGhgDkgg9Q3_wY",
            authDomain: "leavesystem-ab5bd.firebaseapp.com",
            databaseURL: "https://leavesystem-ab5bd-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "leavesystem-ab5bd",
            storageBucket: "leavesystem-ab5bd.firebasestorage.app",
            messagingSenderId: "1037446729152",
            appId: "1:1037446729152:web:a534362d4d3e7e67bd4c25",
            measurementId: "G-7R61R118TN"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // You can add this function to run when the page loads
        function initializeApplicationTable() {
            const table = document.getElementById('application-status-table');
            if (!table) return;

            // Create thead and move the header row into it
            const thead = document.createElement('thead');
            const tbody = document.createElement('tbody');
            
            // Move the existing header row to thead
            const headerRow = table.rows[0];
            thead.appendChild(headerRow.cloneNode(true));
            table.removeChild(headerRow);
            
            // Add thead and tbody to table
            table.appendChild(thead);
            table.appendChild(tbody);
        }

        // Global variables
        let currentUser = null;
        let isAdmin = false;
        let employeeData = {};
        let penaltyData = {};
        let selectedYear = null;

        // Event Listeners
        document.getElementById('login-form').addEventListener('submit', handleLogin);

        document.getElementById('add-employee-btn').addEventListener('click', function(e) {
            e.preventDefault();
            addEmployee();
        });

        document.getElementById('penalty-form').addEventListener('submit', function(e) {
            e.preventDefault();
            addPenalty();
        });

        document.getElementById('apply-leave-form')?.addEventListener('submit', function(e) {
            e.preventDefault();
            applyLeave();
        });

        // Show/hide force majeure options based on leave type
        document.getElementById('leave-type')?.addEventListener('change', function() {
            const forceMajeureOptions = document.getElementById('force-majeure-options');
            const proofContainer = document.getElementById('proof-container');
            
            forceMajeureOptions.style.display = 
                this.value === '不可抗力因素' ? 'block' : 'none';
            
            proofContainer.style.display = 
                ['Sick Leave', '不可抗力因素'].includes(this.value) ? 'block' : 'none';
        });

        // Initialize Firebase Auth
        const auth = firebase.auth();

        // Login Function
        async function handleLogin(event) {
            if (event) {
                event.preventDefault();
            }
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (!username || !password) {
                alert('Please enter both username and password');
                return;
            }

            try {
                // Admin login
                if (username === 'admin@snext.com') {
                    try {
                        const userCredential = await auth.signInWithEmailAndPassword(username, password);
                        const user = userCredential.user;
                        
                        // Check if user is admin
                        const adminSnapshot = await database.ref(`users/${user.uid}/isAdmin`).once('value');
                        if (adminSnapshot.val() === true) {
                            isAdmin = true;
                            currentUser = { 
                                uid: user.uid,
                                username: 'admin',
                                email: username
                            };
                            
                            // Update last login timestamp
                            await database.ref(`users/${user.uid}`).update({
                                lastLogin: new Date().toISOString()
                            });

                            // Show admin interface and load all data
                            showAdminInterface();
                            loadEmployees();
                            loadAllApplications();
                            loadAllPenalties();
                            
                            // Explicitly load and initialize attendance records
                            await updateAttendanceTable(); // Initial fetch
                            initializeAttendanceTable();   // Set up real-time listener
                            
                            // Show success message
                            showSyncStatus('Admin login successful');
                        } else {
                            await auth.signOut();
                            throw new Error('Not authorized as admin');
                        }
                    } catch (error) {
                        console.error('Admin login error:', error);
                        if (error.code === 'auth/user-not-found') {
                            // If admin doesn't exist, create it
                            await initializeAdmin();
                            // Try login again
                            await handleLogin();
                        } else {
                            throw error;
                        }
                    }
                } else {
                    // Employee login logic (unchanged for brevity)
                    try {
                        console.log("Attempting employee login for:", username);
                        
                        // First, find the employee in the database by name
                        const employeeRef = database.ref('employees');
                        const snapshot = await employeeRef.once('value');
                        const employees = snapshot.val() || {};
                        
                        let employeeData = null;
                        let employeeId = null;

                        // Find the employee by name
                        Object.entries(employees).forEach(([id, data]) => {
                            if (data.name === username) {
                                employeeData = data;
                                employeeId = id;
                            }
                        });

                        if (!employeeData) {
                            throw new Error('Employee not found');
                        }

                        // Verify the password matches the current code
                        if (password !== employeeData.code) {
                            throw new Error('Invalid password');
                        }

                        // Format email
                        const employeeEmail = `${username.replace(/[^a-zA-Z0-9]/g, '')}@snext.com`.toLowerCase();

                        try {
                            // Attempt to sign in
                            const userCredential = await auth.signInWithEmailAndPassword(employeeEmail, password);
                            currentUser = {
                                ...employeeData,
                                id: employeeId,
                                uid: userCredential.user.uid
                            };
                        } catch (authError) {
                            // If authentication fails, create new account
                            console.log('Auth error, creating new account:', authError);
                            const newUserCredential = await auth.createUserWithEmailAndPassword(employeeEmail, password);
                            currentUser = {
                                ...employeeData,
                                id: employeeId,
                                uid: newUserCredential.user.uid
                            };
                        }

                        // Update employee record with UID if needed
                        if (currentUser.uid && (!employeeData.uid || employeeData.uid !== currentUser.uid)) {
                            await employeeRef.child(employeeId).update({
                                uid: currentUser.uid
                            });
                        }

                        console.log("Login successful, showing employee interface");
                        showEmployeeInterface();
                        loadEmployeeData(currentUser);
                        showSyncStatus('Login successful');

                    } catch (error) {
                        console.error('Employee login error:', error);
                        throw new Error('Login failed: ' + error.message);
                    }
                }

                // Clear login form
                document.getElementById('login-form').reset();

            } catch (error) {
                console.error('Login error:', error);
                alert(error.message);
                document.getElementById('password').value = '';
            }
        }

        // Add this right after the login attempt in handleLogin function
        console.log("Auth state:", auth.currentUser);
        console.log("User ID:", auth.currentUser?.uid);

        // Logout function
        async function logout() {
            try {
                await auth.signOut();
                isAdmin = false;
                currentUser = null;
                
                // Clear any sensitive data
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                
                // Reset display of pages
                const homePage = document.getElementById('home-page');
                const adminPage = document.getElementById('admin-page');
                const employeePage = document.getElementById('employee-page');

                if (homePage) homePage.style.display = 'block';
                if (adminPage) adminPage.style.display = 'none';
                if (employeePage) employeePage.style.display = 'none';

                showSyncStatus('Logged out successfully');
            } catch (error) {
                console.error('Logout error:', error);
                alert('Error logging out: ' + error.message);
            }
        }

        function isMonday(date) {
            return new Date(date).getDay() === 1; // 0 is Sunday, 1 is Monday
        }

        function countMondaysInDateRange(startDate, endDate) {
            let count = 0;
            let currentDate = new Date(startDate);
            const end = new Date(endDate);
            
            while (currentDate <= end) {
                if (isMonday(currentDate)) {
                    count++;
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }
            return count;
        }

        // Auth state observer
        auth.onAuthStateChanged(async (user) => {
            try {
                if (user) {
                    // User is signed in
                    console.log('User is signed in:', user.email);
                    
                    try {
                        // Check if admin
                        const adminSnapshot = await database.ref(`users/${user.uid}/isAdmin`).once('value');
                        if (adminSnapshot.val() === true) {
                            isAdmin = true;
                            showAdminInterface();
                        }
                    } catch (error) {
                        console.error('Error checking admin status:', error);
                    }
                } else {
                    // User is signed out
                    console.log('User is signed out');
                    currentUser = null;
                    isAdmin = false;
                    showLoginInterface();
                }
            } catch (error) {
                console.error('Auth state change error:', error);
                showSyncStatus('Authentication error occurred', 'error');
            }
        });
        
        // Utility function to show status messages
        function showSyncStatus(message, type = 'success') {
            const syncStatus = document.getElementById('sync-status');
            syncStatus.textContent = message;
            syncStatus.className = `sync-status ${type}`;
            syncStatus.style.display = 'block';
            setTimeout(() => {
                syncStatus.style.display = 'none';
            }, 3000);
        }

        // Add necessary event listeners
        document.addEventListener('DOMContentLoaded', () => {
            const loginForm = document.getElementById('login-form');
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
            }

            const logoutButtons = document.querySelectorAll('.logout-btn');
            logoutButtons.forEach(button => {
                button.addEventListener('click', logout);
            });

            // Add this line
            initializeApplicationTable();            

            // Initialize admin if needed
            if (!auth.currentUser) {
                initializeAdmin().catch(console.error);
            }
        });

        // Add event listeners for logout buttons
        document.addEventListener('DOMContentLoaded', () => {
            // Add event listeners for logout buttons
            const adminLogoutBtn = document.getElementById('logout-btn');
            const employeeLogoutBtn = document.getElementById('logout-btn-employee');

            if (adminLogoutBtn) {
                adminLogoutBtn.addEventListener('click', logout);
            }

            if (employeeLogoutBtn) {
                employeeLogoutBtn.addEventListener('click', logout);
            }

            // Existing login form listener
            const loginForm = document.getElementById('login-form');
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
            }
        });

        document.getElementById('logout-btn').addEventListener('click', async () => {
            if (attendanceListener) {
                database.ref('attendance').off('value', attendanceListener);
                attendanceListener = null;
            }
            await auth.signOut();
            currentUser = null;
            isAdmin = false;
            document.getElementById('admin-page').style.display = 'none';
            document.getElementById('home-page').style.display = 'block';
            showSyncStatus('Logged out successfully');
        });

        // Call this when the admin page loads
        document.addEventListener('DOMContentLoaded', () => {
            initializeAttendanceSystem();
        });

        // Call this when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            initializeAttendanceTable();
        });

        function loadEmployeeDetails() {
            // Show the reminder
            const reminder = document.getElementById("reminderText");
            reminder.classList.remove("hidden");

            // Simulate delay before loading data
            setTimeout(() => {
                // Load employee-specific data
                loadEmployeeApplications(currentUser.id);
                loadEmployeePenalties(currentUser.id);

                // Dynamically get the teams visible to the current user
                const visibleTeams = getVisibleTeamsForLeader(currentUser);

                // If there are visible teams, load the leave records
                if (visibleTeams.length > 0) {
                    loadTeamLeaveRecords(visibleTeams);
                }

                // Update the UI to reflect completion
                reminder.textContent = "Data loaded successfully!";
                setTimeout(() => {
                    reminder.classList.add("hidden");
                    reminder.textContent = "This may take a few minutes...";
                }, 3000);
            }, 2000); // You can adjust this delay time as needed
        }

        // Function to change admin password
        async function changeAdminPassword(currentPassword, newPassword) {
            try {
                // Get current user
                const user = auth.currentUser;
                if (!user) {
                    throw new Error('No user is currently logged in');
                }

                // Verify current password by reauthenticating
                const credential = firebase.auth.EmailAuthProvider.credential(
                    user.email,
                    currentPassword
                );
                
                await user.reauthenticateWithCredential(credential);

                // Change password
                await user.updatePassword(newPassword);

                // Clear the form
                document.getElementById('change-password-form').reset();
                
                // Show success message
                showSyncStatus('Password changed successfully');
                alert('Password has been changed successfully. Please login again.');
                
                // Log out the user
                await logout();

            } catch (error) {
                console.error('Error changing password:', error);
                if (error.code === 'auth/wrong-password') {
                    alert('Current password is incorrect');
                } else {
                    alert('Error changing password: ' + error.message);
                }
            }
        }

        // Add event listener for password change form
        document.getElementById('change-password-form')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;

            // Validate password length
            if (newPassword.length < 6) {
                alert('New password must be at least 6 characters long');
                return;
            }

            // Check if passwords match
            if (newPassword !== confirmPassword) {
                alert('New passwords do not match');
                return;
            }

            // Confirm password change
            if (confirm('Are you sure you want to change your password?')) {
                await changeAdminPassword(currentPassword, newPassword);
            }
        });

        // Load employee data
        async function loadEmployeeData(employeeData) {
            try {
                document.getElementById('employee-name').textContent = employeeData.name;
                document.getElementById('employee-id').textContent = employeeData.id;
                document.getElementById('employee-role').textContent = employeeData.role || 'N/A';
            } catch (error) {
                console.error('Error loading employee data:', error);
                showSyncStatus('Error loading employee data', 'error');
            }
        }

        // Update loadEmployeePenalties function
        async function loadEmployeePenalties(employeeId) {
            if (!employeeId) {
                console.error('No employee ID provided');
                return;
            }

            try {
                const penaltiesRef = database.ref('penalties');
                // Remove any existing listeners
                penaltiesRef.off('value');
                
                // Set up a new real-time listener for penalties
                penaltiesRef.on('value', (snapshot) => {
                    const allPenalties = snapshot.val() || {};
                    
                    // Filter penalties for this employee
                    const employeePenalties = Object.entries(allPenalties)
                        .filter(([_, penalty]) => penalty.employeeId === employeeId)
                        .reduce((acc, [key, value]) => ({...acc, [key]: value}), {});
                    
                    // Update the employee's penalty table
                    updateEmployeePenaltyTable(employeePenalties);
                });
            } catch (error) {
                console.error('Error loading penalties:', error);
                showSyncStatus('Error loading penalties', 'error');
            }
        }

        // Add updateEmployeePenaltyTable function
        function updateEmployeePenaltyTable(penalties) {
            const tableBody = document.getElementById('employee-penalty-list');
            if (!tableBody) {
                console.error('Employee penalty table body not found');
                return;
            }

            tableBody.innerHTML = '';
            let totalUnsubmitted = 0;

            // Sort penalties by date (newest first)
            const sortedPenalties = Object.entries(penalties)
                .sort(([, a], [, b]) => new Date(b.date) - new Date(a.date));

            for (const [id, penalty] of sortedPenalties) {
                const row = document.createElement('tr');
                const isOverdue = new Date() > new Date(penalty.deadline) && penalty.status !== 'Submitted';
                const displayAmount = isOverdue && !penalty.doubleAmountCancelled ? penalty.amount * 2 : penalty.amount;

                // Add to total if not submitted
                if (penalty.status !== 'Submitted') {
                    totalUnsubmitted += displayAmount;
                }

                // Add overdue class if penalty is overdue and double amount is not cancelled
                if (isOverdue && !penalty.doubleAmountCancelled) {
                    row.classList.add('overdue-row');
                }

                row.innerHTML = `
                    <td>${penalty.date}</td>
                    <td>${penalty.reason}</td>
                    <td>${penalty.minutes}</td>
                    <td>$${displayAmount}${isOverdue && !penalty.doubleAmountCancelled ? ' (Doubled)' : ''}
                        ${penalty.doubleAmountCancelled ? ' (Double Cancelled)' : ''}</td>
                    <td>${penalty.deadline}${isOverdue && !penalty.doubleAmountCancelled ? ' (Overdue)' : ''}</td>
                    <td>
                        <div class="d-flex flex-column">
                            <span class="${penalty.status === 'Submitted' ? 'status-submitted' : 'status-not-submitted'}">
                                ${penalty.status}
                            </span>
                            ${penalty.status !== 'Submitted' ? `
                                <button onclick="submitPenalty('${id}')" 
                                        class="submit-proof-btn">
                                    Submit Proof
                                </button>
                            ` : ''}
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            }

            // Update total penalties display
            const penaltySum = document.getElementById('penalty-sum');
            if (penaltySum) {
                penaltySum.textContent = totalUnsubmitted.toFixed(2);
            }
        }

        function showPenaltyProof(penaltyId) {
            const modal = document.getElementById('proof-modal');
            const proofContent = document.getElementById('proof-content');
            
            // Show loading state
            proofContent.innerHTML = 'Loading proof...';
            modal.style.display = 'flex';
            
            // Add animation
            setTimeout(() => {
                modal.classList.add('show');
            }, 10);

            // Fetch the proof from Firebase
            database.ref(`penalties/${penaltyId}/proof`).once('value')
                .then((snapshot) => {
                    const proofData = snapshot.val();
                    if (proofData) {
                        proofContent.innerHTML = `
                            <img src="${proofData}" 
                                style="max-width: 100%; max-height: 60vh; object-fit: contain;"
                                alt="Submitted Proof">
                        `;
                    } else {
                        proofContent.innerHTML = 'No proof available';
                    }
                })
                .catch(error => {
                    console.error('Error loading proof:', error);
                    proofContent.innerHTML = 'Error loading proof';
                });
        }

        function closeProofModal() {
            const modal = document.getElementById('proof-modal');
            modal.classList.remove('show');
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('proof-modal');
            if (event.target === modal) {
                closeProofModal();
            }
        }

        // Load employee applications
        async function loadEmployeeApplications(employeeId) {
            console.log("Loading applications for employee:", employeeId);
            try {
                const applicationsRef = database.ref('applications');
                const snapshot = await applicationsRef
                    .orderByChild('employeeId')
                    .equalTo(employeeId)
                    .once('value');

                const applications = snapshot.val() || {};
                
                const table = document.getElementById('application-status-table');
                // Clear existing rows except header
                while (table.rows.length > 1) {
                    table.deleteRow(1);
                }

                // Sort applications by date (newest first)
                const sortedApplications = Object.entries(applications)
                    .sort(([, a], [, b]) => new Date(b.applyDate) - new Date(a.applyDate));

                for (const [id, application] of sortedApplications) {
                    const row = table.insertRow(-1);
                    
                    // Format the dates for display
                    const applyDate = new Date(application.applyDate);
                    const startDate = new Date(application.leaveStartDate);
                    const endDate = new Date(application.leaveEndDate);

                    const formattedApplyDate = formatDate(applyDate);
                    const formattedStartDate = formatDate(startDate);
                    const formattedEndDate = formatDate(endDate);

                    row.innerHTML = `
                        <td>${formattedApplyDate}</td>
                        <td>${formattedStartDate}</td>
                        <td>${formattedEndDate}</td>
                        <td>${application.leaveType || 'N/A'}</td>
                        <td><span class="status-${application.status.toLowerCase()}">${application.status || 'Pending'}</span></td>
                    `;
                }

                // Calculate and update used days
                const usedDays = await calculateUsedDays(employeeId);
                updateDisplayedUsedDays(
                    usedDays.sickLeaveDays,
                    usedDays.forceMajeureDays,
                    usedDays.overseasDays
                );

            } catch (error) {
                console.error("Error loading applications:", error);
                showSyncStatus('Error loading applications', 'error');
            }
        }

        // Add this to your event listeners section
        document.getElementById('apply-leave-form')?.addEventListener('DOMContentLoaded', function() {
            const today = new Date();
            const formattedToday = formatDate(today);
            document.getElementById('apply-date').value = formattedToday;
        });

        async function submitPenalty(penaltyId) {
            try {
                const user = auth.currentUser;
                if (!user) {
                    throw new Error('You must be logged in to submit proof');
                }

                // Get the file input
                const fileInput = document.getElementById('proof-upload');
                
                // Trigger file selection
                fileInput.click();

                // Handle file selection
                fileInput.onchange = async function(e) {
                    const file = e.target.files[0];
                    if (!file) {
                        return;
                    }

                    try {
                        // Convert file to base64
                        const base64 = await convertFileToBase64(file);

                        // Update penalty status in Firebase
                        await database.ref(`penalties/${penaltyId}`).update({
                            status: 'Submitted',
                            proofSubmitted: true,
                            proofDate: new Date().toISOString(),
                            proof: base64
                        });

                        showSyncStatus('Proof submitted successfully');
                        
                        // Clear the file input
                        fileInput.value = '';
                        
                    } catch (error) {
                        console.error('Error submitting proof:', error);
                        alert('Error submitting proof: ' + error.message);
                    }
                };

            } catch (error) {
                console.error('Error in submit penalty:', error);
                alert('Error: ' + error.message);
            }
        }

        // Helper function to convert file to base64
        function convertFileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        // Show/Hide interfaces
        function showLoginInterface() {
            const homePage = document.getElementById('home-page');
            const adminPage = document.getElementById('admin-page');
            const employeePage = document.getElementById('employee-page');

            if (homePage) homePage.style.display = 'block';
            if (adminPage) adminPage.style.display = 'none';
            if (employeePage) employeePage.style.display = 'none';
        }

        function showAdminInterface() {
            const homePage = document.getElementById('home-page');
            const adminPage = document.getElementById('admin-page');
            const employeePage = document.getElementById('employee-page');

            if (homePage) homePage.style.display = 'none';
            if (adminPage) adminPage.style.display = 'block';
            if (employeePage) employeePage.style.display = 'none';
        }

        // Update addEmployee function
        async function addEmployee() {
            try {
                // Check if user is authenticated and is admin
                const user = auth.currentUser;
                if (!user) {
                    throw new Error('You must be logged in to add employees');
                }

                const adminSnapshot = await database.ref(`users/${user.uid}/isAdmin`).once('value');
                if (!adminSnapshot.val()) {
                    throw new Error('Only administrators can add employees');
                }

                // Get form values
                const name = document.getElementById('emp-name').value;
                const code = document.getElementById('emp-code').value;
                const role = document.getElementById('emp-role').value;
                const mdrt = document.getElementById('emp-mdrt').value;
                const team = document.getElementById('emp-team').value;
                const isTeamLeader = document.getElementById('emp-team-leader').checked;

                // Validation
                if (!name || !code || !role || !mdrt || !team) {
                    throw new Error('Please fill in all fields');
                }

                // Check if employee code already exists
                const existingEmployeeSnapshot = await database.ref('employees')
                    .orderByChild('code')
                    .equalTo(code)
                    .once('value');
                
                if (existingEmployeeSnapshot.exists()) {
                    throw new Error('An employee with this code already exists');
                }

                // Initialize leave values
                let normalLeaves, goldenLeaves;

                // Calculate leaves based on Clubs & Awards (MDRT status)
                switch(mdrt) {
                    case 'no':
                        normalLeaves = 10;
                        goldenLeaves = 3;
                        break;
                    case 'mdrt':
                        normalLeaves = 13;
                        goldenLeaves = 3;
                        break;
                    case 'cot or above':
                        normalLeaves = 999; // Using 999 to represent infinity
                        goldenLeaves = 999; // Using 999 to represent infinity
                        break;
                    default:
                        normalLeaves = 10;
                        goldenLeaves = 3;
                }

                // Create employee data object
                const newEmployee = {
                    name: name,
                    code: code,
                    role: role,
                    mdrt: mdrt,
                    team: team,
                    isTeamLeader: isTeamLeader,
                    normalLeaves: normalLeaves,
                    goldenLeaves: goldenLeaves,
                    remainingNormalLeaves: normalLeaves,
                    remainingGoldenLeaves: goldenLeaves,
                    dateAdded: new Date().toISOString(),
                    createdBy: user.uid,
                    lastModified: new Date().toISOString(),
                    sickLeaveDays: 0,
                    forceMajeureDays: 0,
                    overseasDays: 0
                };

                // Add to Firebase
                console.log('Attempting to add employee:', newEmployee);
                
                const employeesRef = database.ref('employees');
                const newEmployeeRef = await employeesRef.push();
                await newEmployeeRef.set(newEmployee);

                console.log('Employee added successfully');

                // Create auth account for the new employee
                try {
                    const employeeEmail = `${name.replace(/\s+/g, '')}@snext.com`.toLowerCase();
                    await auth.createUserWithEmailAndPassword(employeeEmail, code);
                    
                    // Set employee role in users collection
                    await database.ref(`users/${auth.currentUser.uid}/role`).set('employee');
                    
                    console.log('Employee auth account created');
                } catch (authError) {
                    console.log('Auth account creation skipped:', authError.message);
                    // Continue even if auth account creation fails
                }

                // Update local data
                employeeData[newEmployeeRef.key] = newEmployee;
                
                // Update the table
                updateEmployeeTable();
                
                // Clear the form
                document.getElementById('add-employee-form').reset();
                
                // Show success message
                showSyncStatus('Agent added successfully');

                // Refresh the penalty employee select
                updatePenaltyEmployeeSelect();

            } catch (error) {
                console.error('Error details:', error);
                alert('Error adding agent: ' + error.message);
            }
        }

        async function addPenalty() {
            try {
                // First check if user is authenticated and is admin
                const user = auth.currentUser;
                if (!user) {
                    throw new Error('You must be logged in to add penalties');
                }

                // Check admin status
                const adminSnapshot = await database.ref(`users/${user.uid}/isAdmin`).once('value');
                if (!adminSnapshot.val()) {
                    throw new Error('Only administrators can add penalties');
                }

                const employeeId = document.getElementById('penalty-employee').value;
                const date = document.getElementById('penalty-date').value;
                const reason = document.getElementById('penalty-reason').value;
                const lateMinutes = parseInt(document.getElementById('penalty-minutes').value);

                if (!employeeId || !date || !reason || !lateMinutes) {
                    throw new Error('Please fill in all fields');
                }

                // Get the employee data from Firebase
                const employeeSnapshot = await database.ref(`employees/${employeeId}`).once('value');
                const employeeData = employeeSnapshot.val();

                if (!employeeData) {
                    throw new Error('Employee not found');
                }

                const employeeRole = employeeData.role;
                const employeeName = employeeData.name;

                // Calculate base amount based on minutes
                let amount;
                if (reason === 'Meeting') {
                    if (lateMinutes >= 480) { // No show
                        amount = 200;
                    } else if (lateMinutes <= 5) {
                        amount = 20;
                    } else if (5 < lateMinutes && lateMinutes <= 10) {
                        amount = 40;
                    } else if (10 < lateMinutes && lateMinutes <= 15) {
                        amount = 60;
                    } else {
                        amount = 100;
                    }

                    // Apply role multiplier
                    switch (employeeRole) {
                        case 'AUM/UM':
                            amount *= 1.5;
                            break;
                        case 'SUM':
                            amount *= 2;
                            break;
                        case 'BM':
                            amount *= 3;
                            break;
                        case 'DM':
                            amount *= 4;
                            break;
                        case 'DD':
                            amount *= 6;
                            break;
                        default:
                            // No multiplier for other roles
                            break;
                    }
                }

                // Round amount to nearest integer
                amount = Math.round(amount);

                // Calculate deadline (7 days from penalty date)
                const deadlineDate = new Date(date);
                deadlineDate.setDate(deadlineDate.getDate() + 7);
                const deadline = deadlineDate.toISOString().split('T')[0];

                // Calculate current date
                const currentDate = new Date();
                const penaltyDate = new Date(date);
                const daysPassed = Math.floor((currentDate - penaltyDate + 1) / (1000 * 60 * 60 * 24));

                // Double the amount if past deadline
                const finalAmount = daysPassed > 8 ? amount * 2 : amount;

                const newPenalty = {
                    employeeId: employeeId,  // Make sure this is the correct Firebase key
                    employeeName: employeeName,
                    employeeRole: employeeRole,
                    date: date,
                    reason: reason,
                    minutes: lateMinutes,
                    baseAmount: amount,
                    amount: finalAmount,
                    deadline: deadline,
                    isOverdue: daysPassed > 8,
                    status: 'Not Submitted',
                    createdAt: new Date().toISOString(),
                    lastModified: new Date().toISOString(),
                    createdBy: user.uid
                };

                // Add to Firebase
                const penaltyRef = database.ref('penalties');
                const newPenaltyRef = await penaltyRef.push();
                await newPenaltyRef.set(newPenalty);

                // Clear form
                document.getElementById('penalty-form').reset();
                
                // Show success message
                showSyncStatus('賀金 added successfully');

            } catch (error) {
                console.error('Error adding penalty:', error);
                alert('Error adding 賀金: ' + error.message);
            }
        }

        // Update the penalty table display function
        function updatePenaltyTable() {
            const tableBody = document.getElementById('penalty-list');
            if (!tableBody) return;

            tableBody.innerHTML = '';

            // Sort penalties by date (newest first)
            const sortedPenalties = Object.entries(penaltyData || {})
                .sort(([, a], [, b]) => new Date(b.date) - new Date(a.date));

            for (const [id, penalty] of sortedPenalties) {
                const row = document.createElement('tr');
                const isOverdue = new Date() > new Date(penalty.deadline) && penalty.status !== 'Submitted';
                const displayAmount = isOverdue ? penalty.amount * 2 : penalty.amount;

                row.innerHTML = `
                    <td>${penalty.employeeName}</td>
                    <td>${penalty.date}</td>
                    <td>${penalty.reason}</td>
                    <td>${penalty.minutes}</td>
                    <td>$${displayAmount}${isOverdue ? ' (Doubled)' : ''}</td>
                    <td>${penalty.deadline}${isOverdue ? ' (Overdue)' : ''}</td>
                    <td class="${penalty.status === 'Submitted' ? 'status-submitted' : 'status-not-submitted'}">
                        ${penalty.status}
                    </td>
                `;
                tableBody.appendChild(row);
            }
        }

        // Helper function to show sync status
        function showSyncStatus(message) {
            const syncStatus = document.getElementById('sync-status');
            syncStatus.textContent = message;
            syncStatus.style.display = 'block';
            setTimeout(() => {
                syncStatus.style.display = 'none';
            }, 3000);
        }

        // Helper function to update penalty employee select
        function updatePenaltyEmployeeSelect() {
            const penaltySelect = document.getElementById('penalty-employee');
            penaltySelect.innerHTML = '<option value="">Select Employee</option>';
            
            const sortedEmployees = Object.entries(employeeData)
                .sort(([, a], [, b]) => a.name.localeCompare(b.name));

            for (const [id, employee] of sortedEmployees) {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = employee.name;
                penaltySelect.appendChild(option);
            }
        }

        // Update the event listener for leave type dropdown
        document.getElementById('leave-type')?.addEventListener('change', function() {
            const proofContainer = document.getElementById('proof-container');
            const proofFileInput = document.getElementById('proof-file');
            const forceMajeureOptions = document.getElementById('force-majeure-options');
            const forceMajeureReasonSelect = document.getElementById('force-majeure-reason');
            const startDateInput = document.getElementById('leave-start-date');
            const endDateInput = document.getElementById('leave-end-date');
            const applyDateInput = document.getElementById('apply-date');

            // Add Special Approve to the types requiring proof
            if (this.value === 'Sick Leave' || 
                this.value === '不可抗力因素' || 
                this.value === '離港' ||
                this.value === 'Special Approve') {
                proofContainer.style.display = 'block';
                proofFileInput.disabled = false;
                proofFileInput.required = true;

                // Special handling for Special Approve
                if (this.value === 'Special Approve') {
                    // Set today's date
                    const today = new Date().toISOString().split('T')[0];
                    applyDateInput.value = today;
                    startDateInput.value = today;
                    endDateInput.value = today;
                    
                    // Disable date inputs for Special Approve
                    applyDateInput.disabled = true;
                    startDateInput.disabled = true;
                    endDateInput.disabled = true;
                } else {
                    // Re-enable date inputs for other types
                    applyDateInput.disabled = false;
                    startDateInput.disabled = false;
                    endDateInput.disabled = false;
                }

                if (this.value === '不可抗力因素') {
                    forceMajeureOptions.style.display = 'block';
                    forceMajeureReasonSelect.required = true;
                } else {
                    forceMajeureOptions.style.display = 'none';
                    forceMajeureReasonSelect.required = false;
                }
            } else {
                proofContainer.style.display = 'none';
                proofFileInput.disabled = true;
                proofFileInput.required = false;
                forceMajeureOptions.style.display = 'none';
                forceMajeureReasonSelect.required = false;
                
                // Re-enable date inputs
                applyDateInput.disabled = false;
                startDateInput.disabled = false;
                endDateInput.disabled = false;
            }
        });

        // Update the event listener for leave application form submission
        document.getElementById('apply-leave-form')?.addEventListener('submit', async function(event) {
            event.preventDefault();
            const applyDate = new Date();
            const leaveStartDate = new Date(document.getElementById('leave-start-date').value);
            const leaveEndDate = new Date(document.getElementById('leave-end-date').value);
            const leaveType = document.getElementById('leave-type').value;

            // Add this line at the beginning
            const updates = {};

            if (leaveType === 'Annual Leave (Normal)') {
                // Calculate the minimum allowed Leave Start Date (2 days after Apply Date)
                const minLeaveStartDate = new Date(applyDate);
                minLeaveStartDate.setDate(minLeaveStartDate.getDate() + 2);

                if (leaveStartDate < minLeaveStartDate) {
                    alert("Leave Start Date must be at least 3 days after Apply Date for Annual Leave (Normal). (Include Apply Date)");
                    return;
                }
            } else if (leaveType === 'Annual Leave (黃金事假)' || leaveType === 'Sick Leave' || leaveType === '不可抗力因素') {
                // Allow immediate application for these leave types
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const startDate = new Date(leaveStartDate);
                startDate.setHours(0, 0, 0, 0);
                
                // Allow start date to be today or future date
                if (startDate < today) {
                    alert("Leave Start Date cannot be earlier than today.");
                    return;
                }
            }

            if (leaveEndDate < leaveStartDate) {
                alert("Leave End Date must be on or after Leave Start Date.");
                return;
            }

            // Check Monday leaves for Annual Leaves
            if (leaveType.includes('Annual Leave')) {
                const mondayCount = countMondaysInDateRange(leaveStartDate, leaveEndDate);
                
                if (mondayCount > 0) {
                    // Get current employee data
                    const employeeRef = database.ref(`employees/${currentUser.id}`);
                    const employeeSnapshot = await employeeRef.once('value');
                    const employeeData = employeeSnapshot.val();

                    const currentMondayLeaves = employeeData.usedMondayLeaves || 0;
                    const newMondayTotal = currentMondayLeaves + mondayCount;
                    
                    // Check Monday limits and show alerts
                    if (currentMondayLeaves >= 3) {
                        alert('You have already used 3 Monday leaves. Please apply for "活動請假" instead.');
                        return; // Stop the application process
                    } else if (newMondayTotal > 3) {
                        alert(`This leave would exceed your 3-Monday limit. Please apply for "活動請假" for the additional ${newMondayTotal - 3} Monday(s).`);
                        return; // Stop the application process
                    }

                    // If within limits, update the Monday leave count
                    updates.usedMondayLeaves = newMondayTotal;
                }
            }

            // Process leave application based on type
            if (leaveType === 'Sick Leave' || leaveType === '不可抗力因素' || leaveType === '離港' || leaveType === 'Special Approve') {
                const proofFile = document.getElementById('proof-file').files[0];
                if (!proofFile) {
                    alert(`Please submit proof for ${leaveType}.`);
                    return;
                }

                // Convert proof file to base64 and process application
                const reader = new FileReader();
                reader.onloadend = function() {
                    const proofDataUrl = reader.result;
                    processLeaveApplication(applyDate, leaveStartDate, leaveEndDate, leaveType, proofDataUrl);
                };
                reader.readAsDataURL(proofFile);
            } else {
                processLeaveApplication(applyDate, leaveStartDate, leaveEndDate, leaveType, null);
            }
        });

        function formatDate(date) {
            // If date is a string, convert it to Date object
            if (typeof date === 'string') {
                date = new Date(date);
            }
            
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatTime(date) {
            return new Date(date).toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: true
            });
        }

        async function processLeaveApplication(applyDate, leaveStartDate, leaveEndDate, leaveType, proofDataUrl) {
            const applyButton = document.getElementById('apply-button');
            const successNotice = document.getElementById('success-notice');

            // Disable the Apply button to prevent multiple clicks
            applyButton.disabled = true;
            applyButton.textContent = 'Submitting...'; // Optional: Change button text to indicate processing

            try {
                // Calculate leave days
                const leaveDays = Math.ceil((leaveEndDate - leaveStartDate) / (1000 * 60 * 60 * 24)) + 1;
                
                // Get current employee data
                const employeeRef = database.ref(`employees/${currentUser.id}`);
                const employeeSnapshot = await employeeRef.once('value');
                const employeeData = employeeSnapshot.val();

                if (!employeeData) {
                    throw new Error('Employee data not found');
                }

                // Check remaining leaves based on leave type
                if (leaveType === 'Annual Leave (Normal)' || leaveType === 'Annual Leave (黃金事假)') {
                    if (employeeData.remainingNormalLeaves <= 0) {
                        alert('You have no remaining Annual Leaves (Normal).');
                        applyButton.disabled = false;
                        applyButton.textContent = 'Apply';
                        return;
                    }
                    if (leaveDays > employeeData.remainingNormalLeaves) {
                        alert(`You have only ${employeeData.remainingNormalLeaves} Annual Leaves (Normal) remaining. Cannot apply for ${leaveDays} days.`);
                        return;
                    }
                    if (leaveType === 'Annual Leave (黃金事假)') {
                        if (employeeData.remainingGoldenLeaves <= 0) {
                            alert('You have no remaining Annual Leaves (黃金事假).');
                            return;
                        }
                        if (leaveDays > employeeData.remainingGoldenLeaves) {
                            alert(`You have only ${employeeData.remainingGoldenLeaves} Annual Leaves (黃金事假) remaining. Cannot apply for ${leaveDays} days.`);
                            return;
                        }
                    }
                }

                // Create updates object for the employee
                const updates = {};

                // Format dates for application
                const formattedApplyDate = formatDate(applyDate);
                const formattedStartDate = formatDate(leaveStartDate);
                const formattedEndDate = formatDate(leaveEndDate);

                // Handle '活動請假' type
                if (leaveType === '活動請假') {
                    let amount = 100; // Base amount

                    // Apply role multiplier
                    switch (currentUser.role) {
                        case 'AUM/UM':
                            amount *= 1.5;
                            break;
                        case 'SUM':
                            amount *= 2;
                            break;
                        case 'BM':
                            amount *= 3;
                            break;
                        case 'DM':
                            amount *= 4;
                            break;
                        case 'DD':
                            amount *= 6;
                            break;
                        default:
                            // No multiplier for regular agents
                            break;
                    }

                    // Round amount to nearest integer
                    amount = Math.round(amount);

                    // Calculate deadline (7 days from application date)
                    const deadlineDate = new Date(formattedStartDate);
                    deadlineDate.setDate(deadlineDate.getDate() + 7);
                    
                    // Create penalty record
                    const penaltyData = {
                        employeeId: currentUser.id,
                        employeeName: currentUser.name,
                        employeeRole: currentUser.role,
                        date: formattedStartDate,
                        reason: '活動請假',
                        minutes: 0,
                        amount: amount,
                        baseAmount: amount,
                        deadline: formatDate(deadlineDate),
                        status: 'Not Submitted',
                        createdAt: new Date().toISOString(),
                        lastModified: new Date().toISOString()
                    };

                    // Add penalty to Firebase
                    const penaltyRef = database.ref('penalties');
                    await penaltyRef.push(penaltyData);
                }
                // Handle Annual Leave types
                else if (leaveType.includes('Annual Leave')) {
                    const mondayCount = countMondaysInDateRange(leaveStartDate, leaveEndDate);
    
                    if (mondayCount > 0) {
                        // Get current employee data
                        const employeeRef = database.ref(`employees/${currentUser.id}`);
                        const employeeSnapshot = await employeeRef.once('value');
                        const employeeData = employeeSnapshot.val();

                        const currentMondayLeaves = employeeData.usedMondayLeaves || 0;
                        const newMondayTotal = currentMondayLeaves + mondayCount;
                        
                        // Check Monday limits and show alerts
                        if (currentMondayLeaves >= 3) {
                            alert('You have already used 3 Monday leaves. Please apply for "活動請假" instead.');
                            return; // Stop the application process
                        } else if (newMondayTotal > 3) {
                            alert(`This leave would exceed your 3-Monday limit. Please apply for "活動請假" for the additional ${newMondayTotal - 3} Monday(s).`);
                            return; // Stop the application process
                        }

                        // If within limits, update the Monday leave count
                        updates.usedMondayLeaves = newMondayTotal;
                    }
                    // Update leave counts for Annual Leave types
                    if (leaveType === 'Annual Leave (Normal)' && employeeData.remainingNormalLeaves !== 999) {
                        updates.remainingNormalLeaves = employeeData.remainingNormalLeaves - leaveDays;
                    } else if (leaveType === 'Annual Leave (黃金事假)') {
                        if (employeeData.remainingGoldenLeaves !== 999) {
                            updates.remainingGoldenLeaves = employeeData.remainingGoldenLeaves - leaveDays;
                        }
                        if (employeeData.remainingNormalLeaves !== 999) {
                            updates.remainingNormalLeaves = employeeData.remainingNormalLeaves - leaveDays;
                        }
                    }
                }

                // Handle other leave types
                else {
                    switch (leaveType) {
                        case 'Sick Leave':
                            updates.usedSickLeaveDays = (employeeData.usedSickLeaveDays || 0) + leaveDays;
                            break;
                        case '不可抗力因素':
                            updates.usedForceMajeureDays = (employeeData.usedForceMajeureDays || 0) + leaveDays;
                            break;
                        case '離港':
                            updates.usedOverseasDays = (employeeData.usedOverseasDays || 0) + leaveDays;
                            break;
                    }
                }

                // Create single application record
                const newApplication = {
                    employeeId: currentUser.id,
                    employeeName: currentUser.name,
                    applyDate: formattedApplyDate,
                    leaveStartDate: formattedStartDate,
                    leaveEndDate: formattedEndDate,
                    leaveType: leaveType,
                    leaveDays: leaveDays,
                    status: 'Approved',
                    proof: proofDataUrl,
                    createdAt: new Date().toISOString() // This will store the exact timestamp
                };

                // Add application to Firebase
                const applicationsRef = database.ref('applications');
                await applicationsRef.push(newApplication);

                // Update employee data if there are any updates
                if (Object.keys(updates).length > 0) {
                    await employeeRef.update(updates);

                    // Update displayed values
                    updateDisplayedRemainingLeaves(
                        (updates.remainingNormalLeaves !== undefined ? updates.remainingNormalLeaves : employeeData.remainingNormalLeaves),
                        (updates.remainingGoldenLeaves !== undefined ? updates.remainingGoldenLeaves : employeeData.remainingGoldenLeaves)
                    );

                    updateDisplayedUsedDays(
                        (updates.usedSickLeaveDays || employeeData.usedSickLeaveDays || 0),
                        (updates.usedForceMajeureDays || employeeData.usedForceMajeureDays || 0),
                        (updates.usedOverseasDays || employeeData.usedOverseasDays || 0)
                    );

                    const mondayLeavesElement = document.getElementById('used-monday-leaves');
                    if (mondayLeavesElement) {
                        mondayLeavesElement.textContent = updates.usedMondayLeaves || 0;
                    }
                }

                // Clear form and reset UI
                document.getElementById('apply-leave-form').reset();
                const proofContainer = document.getElementById('proof-container');
                const forceMajeureOptions = document.getElementById('force-majeure-options');
                if (proofContainer) proofContainer.style.display = 'none';
                if (forceMajeureOptions) forceMajeureOptions.style.display = 'none';

                // Show success notice
                successNotice.style.display = 'block';
                setTimeout(() => {
                    successNotice.style.display = 'none'; // Hide notice after 5 seconds
                }, 5000);

                // Refresh the application status table
                await loadEmployeeApplications(currentUser.id);
                
                showSyncStatus('Leave application submitted successfully');

            } catch (error) {
                console.error('Error processing leave application:', error);
                alert('Error submitting leave application: ' + error.message);

            } finally {
                setTimeout(() => {
                    applyButton.disabled = false;
                    applyButton.textContent = 'Apply';
                }, 1000); // Wait 1 second before re-enabling
            }
        }

        async function updateRemainingLeaves(employeeId, leaveType, leaveDays) {
            const employeeRef = database.ref(`employees/${employeeId}`);
            const snapshot = await employeeRef.once('value');
            const employeeData = snapshot.val();

            if (!employeeData) return;

            const updates = {};
            
            if (leaveType === 'Annual Leave (Normal)') {
                if (employeeData.remainingNormalLeaves !== 999) { // Don't update if unlimited
                    updates.remainingNormalLeaves = employeeData.remainingNormalLeaves - leaveDays;
                }
            } else if (leaveType === 'Annual Leave (黃金事假)') {
                if (employeeData.remainingGoldenLeaves !== 999) { // Don't update if unlimited
                    updates.remainingGoldenLeaves = employeeData.remainingGoldenLeaves - leaveDays;
                }
                if (employeeData.remainingNormalLeaves !== 999) { // Don't update if unlimited
                    updates.remainingNormalLeaves = employeeData.remainingNormalLeaves - leaveDays;
                }
            }

            if (Object.keys(updates).length > 0) {
                await employeeRef.update(updates);
            }
        }        

        // Update the calculateLateStatus function to ensure consistent penalty amounts
        function calculateLateStatus(timestamp, role, cutoffTimeArray, earlyRoles = []) {
            const recordTime = new Date(timestamp);

            // Default fallback
            if (!Array.isArray(cutoffTimeArray) || cutoffTimeArray.length < 2) {
                cutoffTimeArray = [9, 30, 0, 0];
            }

            let [hour, minute, second = 0, ms = 0] = cutoffTimeArray;

            // Apply early arrival rule
            if (earlyRoles.includes(role)) {
                const totalMinutes = hour * 60 + minute - 10;
                hour = Math.floor(totalMinutes / 60);
                minute = totalMinutes % 60;
            }

            const deadline = new Date(recordTime);
            deadline.setHours(hour, minute, second, ms);

            const lateMinutes = Math.floor((recordTime - deadline) / (1000 * 60));

            let status = '';
            let amount = 0;

            if (lateMinutes <= 0) {
                status = 'Punctual';
                amount = 0;
            } else {
                if (lateMinutes >= 60) {
                    status = 'No Show';
                    amount = 200;
                } else if (lateMinutes <= 5) {
                    status = 'Late ≤ 5 mins';
                    amount = 20;
                } else if (lateMinutes <= 10) {
                    status = 'Late 6-10 mins';
                    amount = 40;
                } else if (lateMinutes <= 15) {
                    status = 'Late 11-15 mins';
                    amount = 60;
                } else {
                    status = 'Late > 15 mins';
                    amount = 100;
                }

                switch (role) {
                    case 'AUM/UM': amount *= 1.5; break;
                    case 'SUM': amount *= 2; break;
                    case 'BM': amount *= 3; break;
                    case 'DM': amount *= 4; break;
                    case 'DD': amount *= 6; break;
                }
            }

            amount = Math.round(amount);

            return {
                status,
                amount,
                lateMinutes: Math.max(0, lateMinutes),
                deadline: deadline.toTimeString().substring(0, 5)
            };
        }


        async function updateAttendanceTable() {
            try {
                // Update agent's personal attendance table (today's record only)
                const agentTableBody = document.getElementById('attendanceTableBody');
                if (agentTableBody && currentUser) {
                    // Get today's date in YYYY-MM-DD format
                    const today = new Date().toISOString().split('T')[0];
                    
                    // Clear existing records
                    agentTableBody.innerHTML = '';

                    // Fetch today's records for current user
                    const attendanceRef = database.ref('attendance');
                    const snapshot = await attendanceRef.once('value');
                    
                    // Get a Set of already processed record IDs to prevent duplicates
                    const processedRecordIds = new Set();
                    const records = [];
                    
                    snapshot.forEach(childSnapshot => {
                        const record = childSnapshot.val();
                        // Only include records for the current user and from today
                        if (record && record.employeeId === currentUser.id) {
                            const recordDate = new Date(record.timestamp).toISOString().split('T')[0];
                            if (recordDate === today) {
                                // Use record ID to prevent duplicates
                                const recordId = childSnapshot.key;
                                if (!processedRecordIds.has(recordId)) {
                                    processedRecordIds.add(recordId);
                                    records.push({
                                        id: recordId,
                                        ...record
                                    });
                                }
                            }
                        }
                    });

                    if (records.length > 0) {
                        // Sort by time (earliest first)
                        records.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                        
                        // Only show the first record for the day
                        const todayRecord = records[0];
                        const recordTime = new Date(todayRecord.timestamp);

                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900">
                                    ${currentUser.name}
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900">
                                    ${formatDate(recordTime)} ${formatTime(recordTime)}
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="status-badge ${todayRecord.status.toLowerCase()}">
                                    ${todayRecord.status}
                                    ${todayRecord.amount > 0 ? ` (-$${todayRecord.amount})` : ''}
                                </span>
                            </td>
                        `;
                        agentTableBody.appendChild(row);
                    } else {
                        // Show "No record for today" message
                        agentTableBody.innerHTML = `
                            <tr>
                                <td colspan="3" class="px-6 py-4 text-center text-gray-500">
                                    No attendance record for today
                                </td>
                            </tr>
                        `;
                    }
                }

                // Update admin's all attendance records table
                const adminTableBody = document.getElementById('allAttendanceTableBody');
                if (adminTableBody && isAdmin) {
                    // Clear existing records
                    adminTableBody.innerHTML = '';

                    // Fetch all attendance records
                    const attendanceRef = database.ref('attendance');
                    const snapshot = await attendanceRef.once('value');
                    
                    // Use a Map with composite key to track unique records
                    // Create key using employeeId + date to handle duplicates
                    const uniqueRecords = new Map();

                    snapshot.forEach(childSnapshot => {
                        const record = childSnapshot.val();
                        if (record && record.employeeName && record.timestamp) {
                            // Create a composite key using employeeId and the date part of timestamp
                            const recordDate = new Date(record.timestamp).toISOString().split('T')[0];
                            const compositeKey = `${record.employeeId || record.employeeName}_${recordDate}`;
                            
                            // For records on the same day, keep only the earliest one
                            if (!uniqueRecords.has(compositeKey) || 
                                new Date(record.timestamp) < new Date(uniqueRecords.get(compositeKey).timestamp)) {
                                uniqueRecords.set(compositeKey, {
                                    id: childSnapshot.key,
                                    ...record
                                });
                            }
                        }
                    });

                    // Convert to array
                    const records = Array.from(uniqueRecords.values());

                    // Sort records by timestamp (newest first)
                    records.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                    if (records.length === 0) {
                        adminTableBody.innerHTML = `
                            <tr>
                                <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                                    No attendance records found
                                </td>
                            </tr>
                        `;
                    } else {
                        // Apply any active filters
                        let filteredRecords = records;
                        const dateFilter = document.getElementById('dateFilter')?.value;
                        const statusFilter = document.getElementById('statusFilter')?.value;
                        const employeeFilter = document.getElementById('attendanceEmployeeFilter')?.value;
                        
                        if (dateFilter) {
                            filteredRecords = filteredRecords.filter(record => {
                                const recordDate = new Date(record.timestamp).toISOString().split('T')[0];
                                return recordDate === dateFilter;
                            });
                        }
                        
                        if (statusFilter) {
                            filteredRecords = filteredRecords.filter(record => 
                                record.status === statusFilter
                            );
                        }
                        
                        if (employeeFilter) {
                            filteredRecords = filteredRecords.filter(record => 
                                record.employeeId === employeeFilter
                            );
                        }
                        
                        // Display filtered records
                        filteredRecords.forEach(record => {
                            const row = document.createElement('tr');
                            const recordDate = new Date(record.timestamp);
                            
                            row.innerHTML = `
                                <td class="px-6 py-4">${record.employeeName || 'N/A'}</td>
                                <td class="px-6 py-4">${record.role || 'N/A'}</td>
                                <td class="px-6 py-4">
                                    ${formatDate(recordDate)} ${formatTime(recordDate)}
                                </td>
                                <td class="px-6 py-4">
                                    <span class="status-badge ${record.status?.toLowerCase() || 'unknown'}">
                                        ${record.status || 'N/A'}
                                        ${record.amount > 0 ? ` (-$${record.amount})` : ''}
                                    </span>
                                </td>
                                <td class="px-6 py-4">${record.ipAddress || 'N/A'}</td>
                                <td class="px-6 py-4">
                                    <button class="remove-btn-small" onclick="removeAttendanceRecord('${record.id}')">
                                        Remove
                                    </button>
                                </td>
                            `;
                            adminTableBody.appendChild(row);
                        });
                    }
                }

            } catch (error) {
                console.error('Error updating attendance tables:', error);
                showSyncStatus('Error updating attendance records', 'error');
            }
        }

        // Modify your onScanSuccess function to update the table
        async function onScanSuccess(decodedText, decodedResult) {
            try {
                const user = auth.currentUser;
                if (!user) {
                    throw new Error('You must be logged in to take attendance');
                }

                // Find employee by UID
                const employeesRef = database.ref('employees');
                const employeesSnapshot = await employeesRef.orderByChild('uid').equalTo(user.uid).once('value');
                
                let employeeData = null;
                let employeeId = null;

                employeesSnapshot.forEach((childSnapshot) => {
                    employeeData = childSnapshot.val();
                    employeeId = childSnapshot.key;
                });

                if (!employeeData) {
                    throw new Error('Employee not found');
                }

                // Get current date and time
                const now = new Date();
                const currentDate = formatDate(now);

                // Check for existing attendance record for today
                const attendanceRef = database.ref('attendance');
                const todaySnapshot = await attendanceRef.once('value');
                
                let existingRecord = false;
                
                // Check if there's already a record for this employee on this date
                todaySnapshot.forEach(childSnapshot => {
                    const record = childSnapshot.val();
                    if (record.employeeId === employeeId) {
                        const recordDate = new Date(record.timestamp).toISOString().split('T')[0];
                        if (recordDate === currentDate) {
                            existingRecord = true;
                        }
                    }
                });

                if (existingRecord) {
                    showScanResult('Attendance already recorded for today', false);
                    stopScanner();
                    return;
                }

                // Get user's IP address
                const ipResponse = await fetch('https://api.ipify.org?format=json');
                const ipData = await ipResponse.json();
                const ipAddress = ipData.ip;

                // Decode QR pattern
                const parts = decodedText.split('-');
                const configEncoded = parts[3];

                const config = JSON.parse(atob(configEncoded));
                const cutoffTimeArray = config.cutoffTime || [9, 30, 0, 0];
                const earlyRoles = config.earlyRoles || [];


                // Calculate late status
                
                const lateInfo = calculateLateStatus(now.toISOString(), employeeData.role, cutoffTimeArray, earlyRoles);


                // Create attendance record
                const attendanceData = {
                    employeeId: employeeId,
                    employeeName: employeeData.name,
                    role: employeeData.role,
                    date: currentDate,
                    time: formatTime(now),
                    timestamp: now.toISOString(),
                    status: lateInfo.status,
                    lateMinutes: lateInfo.lateMinutes,
                    amount: lateInfo.amount,
                    ipAddress: ipAddress
                };

                // Save to Firebase
                const newRecord = await attendanceRef.push(attendanceData);

                // Show success message
                showScanResult('Attendance recorded successfully', true);

                // Stop the scanner
                stopScanner();
                
                // Important: Manually update the UI once without relying on listeners
                // This avoids duplicate rendering
                setTimeout(() => {
                    // Force a manual update of the attendance table to show the new record
                    updateAttendanceTable();
                }, 1000);

            } catch (error) {
                console.error('Error recording attendance:', error);
                showScanResult('Error recording attendance: ' + error.message, false);
                stopScanner();
            }
        }

        async function removeAttendanceRecord(recordId) {
            try {
                // Check if user is admin
                const currentUser = auth.currentUser;
                if (!currentUser) {
                    throw new Error('You must be logged in to remove records');
                }

                const adminSnapshot = await database.ref(`users/${currentUser.uid}/isAdmin`).once('value');
                if (!adminSnapshot.val()) {
                    throw new Error('Only administrators can remove attendance records');
                }

                // Confirm deletion
                if (!confirm('Are you sure you want to remove this attendance record?')) {
                    return;
                }

                console.log('Attempting to remove record with ID:', recordId);
                
                // Get a direct reference to the attendance node
                const attendanceRef = database.ref('attendance');
                const snapshot = await attendanceRef.once('value');
                
                let foundRecord = false;
                
                // Search through the entire attendance tree to find the record
                // This handles nested records in any structure
                const updateObject = {};
                
                // A recursive function to search through the entire tree
                const searchAndMarkForDeletion = (obj, path) => {
                    Object.entries(obj).forEach(([key, value]) => {
                        const currentPath = path ? `${path}/${key}` : key;
                        
                        if (key === recordId) {
                            // Found the record to delete
                            updateObject[`attendance/${currentPath}`] = null;
                            foundRecord = true;
                            console.log(`Found record to delete at path: attendance/${currentPath}`);
                        } else if (typeof value === 'object' && value !== null) {
                            // If this is an object, recursively search it
                            searchAndMarkForDeletion(value, currentPath);
                        }
                    });
                };
                
                // Start the recursive search from the root of attendance
                searchAndMarkForDeletion(snapshot.val() || {}, '');
                
                if (foundRecord) {
                    // Apply all deletions in a batch update
                    await database.ref().update(updateObject);
                    console.log('Record deleted successfully');
                    
                    // Force UI update
                    await updateAttendanceTable();
                    
                    showSyncStatus('Attendance record removed successfully');
                } else {
                    // Try a direct approach as a fallback
                    await database.ref(`attendance/${recordId}`).remove();
                    console.log('Attempted direct removal at attendance/' + recordId);
                    
                    // Force UI update
                    await updateAttendanceTable();
                    
                    showSyncStatus('Attendance record removal attempted');
                }
            } catch (error) {
                console.error('Error removing attendance record:', error);
                alert('Error: ' + error.message);
            }
        }

        //Get the IP address
        async function getIPAddress() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                console.error('Error getting IP address:', error);
                return null;
            }
        }

        // Add this to your initialization code (where you check user authentication)
        document.addEventListener('DOMContentLoaded', function() {
            firebase.auth().onAuthStateChanged(function(user) {
                if (user) {
                    // Initialize the attendance table
                    updateAttendanceTable();
                }
            });
        });

        // Helper function to update employee table
        function updateEmployeeTable() {
            const tableBody = document.getElementById('employee-list');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';

            // Get the current order from localStorage or create default order
            let employeeOrder;
            try {
                employeeOrder = JSON.parse(localStorage.getItem('employeeOrder')) || [];
            } catch (e) {
                employeeOrder = [];
            }

            // Get all employees and sort them
            let employees = Object.entries(employeeData || {});
            
            // If we have a stored order, use it to sort the employees
            if (employeeOrder.length > 0) {
                employees.sort((a, b) => {
                    const indexA = employeeOrder.indexOf(a[0]);
                    const indexB = employeeOrder.indexOf(b[0]);
                    if (indexA === -1) return 1;
                    if (indexB === -1) return -1;
                    return indexA - indexB;
                });
            } else {
                // Default sort by name if no stored order
                employees.sort(([, a], [, b]) => a.name.localeCompare(b.name));
            }

            employees.forEach(([id, employee]) => {
                const row = document.createElement('tr');
                row.draggable = true;
                row.dataset.id = id;
                row.className = 'draggable';
                
                // Format leave display - show "∞" for 999 (infinity)
                const normalLeavesDisplay = employee.remainingNormalLeaves === 999 ? "∞" : employee.remainingNormalLeaves;
                const goldenLeavesDisplay = employee.remainingGoldenLeaves === 999 ? "∞" : employee.remainingGoldenLeaves;
                
                row.innerHTML = `
                    <td class="drag-handle">
                        <div class="drag-handle-inner">${employee.name}</div>
                    </td>
                    <td>${employee.code}</td>
                    <td>${employee.role}</td>
                    <td>${employee.mdrt}</td>
                    <td>${normalLeavesDisplay}</td>
                    <td>${goldenLeavesDisplay}</td>
                    <td>
                        <button class="remove-btn" onclick="removeAgent('${id}', this.parentElement.parentElement)">Remove</button>
                    </td>
                `;

                // Add drag and drop event listeners
                row.addEventListener('dragstart', handleDragStart);
                row.addEventListener('dragend', handleDragEnd);
                row.addEventListener('dragover', handleDragOver);
                row.addEventListener('drop', handleDrop);
                row.addEventListener('dragenter', handleDragEnter);
                row.addEventListener('dragleave', handleDragLeave);

                tableBody.appendChild(row);
            });
        }

        // Drag and drop handler functions
        let draggedRow = null;

        function handleDragStart(e) {
            draggedRow = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', this.dataset.id);
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            const rows = document.querySelectorAll('#employee-list tr');
            rows.forEach(row => row.classList.remove('drag-over'));
            draggedRow = null;
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDragEnter(e) {
            this.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.stopPropagation();
            e.preventDefault();
            
            if (draggedRow !== this) {
                const rows = Array.from(document.querySelectorAll('#employee-list tr'));
                const draggedIndex = rows.indexOf(draggedRow);
                const droppedIndex = rows.indexOf(this);

                if (draggedIndex !== -1 && droppedIndex !== -1) {
                    this.parentNode.insertBefore(draggedRow, droppedIndex > draggedIndex ? this.nextSibling : this);
                    
                    // Save the new order
                    const newOrder = Array.from(document.querySelectorAll('#employee-list tr')).map(row => row.dataset.id);
                    localStorage.setItem('employeeOrder', JSON.stringify(newOrder));
                }
            }
            
            this.classList.remove('drag-over');
            return false;
        }

        // Add these at the start of your JavaScript file
        let qrWindow = null;
        let qrInterval = null;

        // Function to generate a random pattern
        function generateRandomPattern() {
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < 20; i++) {
                result += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            return result;
        }

        // Function to create QR code window content
        function createQRWindowContent() {
            return `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Attendance QR Code</title>
                    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"><\/script>
                    <style>
                        body {
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                            justify-content: center;
                            min-height: 100vh;
                            margin: 0;
                            background-color: #f0f0f0;
                            font-family: Arial, sans-serif;
                        }
                        #qr-container {
                            background: white;
                            padding: 40px;
                            border-radius: 20px;
                            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
                            text-align: center;
                        }
                        #qr-code {
                            margin-bottom: 30px;
                        }
                        #qr-code img {
                            width: 400px;
                            height: 400px;
                        }
                        #current-time {
                            font-size: 48px;
                            color: #333;
                            margin-top: 20px;
                            font-weight: bold;
                        }
                        .title {
                            font-size: 36px;
                            color: #333;
                            margin-bottom: 30px;
                            font-weight: bold;
                        }
                        #config-form {
                            margin-bottom: 30px;
                            display: flex;
                            flex-direction: column;
                            gap: 15px;
                        }
                        #config-form label {
                            font-size: 18px;
                            color: #333;
                        }
                        #config-form input[type="time"],
                        #config-form select {
                            padding: 8px;
                            font-size: 16px;
                            border: 1px solid #ccc;
                            border-radius: 4px;
                        }
                        #config-form .checkbox-group {
                            display: flex;
                            flex-direction: column;
                            gap: 10px;
                        }
                        #config-form button {
                            padding: 10px 20px;
                            background-color: #4CAF50;
                            color: white;
                            border: none;
                            border-radius: 4px;
                            cursor: pointer;
                            font-size: 16px;
                        }
                        #config-form button:hover {
                            background-color: #45a049;
                        }
                    </style>
                </head>
                <body>
                    <div id="qr-container">
                        <h1 class="title">Attendance QR Code</h1>
                        <div id="config-form">
                            <label for="cutoff-time">Set Cutoff Time:</label>
                            <input type="time" id="cutoff-time" value="09:30">
                            <label for="early-roles">Roles Requiring Early Arrival (10 mins):</label>
                            <div class="checkbox-group">
                                <label><input type="checkbox" name="early-roles" value="AUM/UM"> AUM/UM</label>
                                <label><input type="checkbox" name="early-roles" value="SUM"> SUM</label>
                                <label><input type="checkbox" name="early-roles" value="BM"> BM</label>
                                <label><input type="checkbox" name="early-roles" value="DM"> DM</label>
                                <label><input type="checkbox" name="early-roles" value="DD"> DD</label>
                            </div>
                            <button onclick="generateQRCode()">Generate QR Code</button>
                        </div>
                        <div id="qr-code" style="display: none;"></div>
                        <div id="current-time"></div>
                    </div>
                    <script>
                        let previousPatterns = new Set();
                        const timeDisplay = document.getElementById('current-time');
                        
                        function updateTime() {
                            const now = new Date();
                            const hours = String(now.getHours()).padStart(2, '0');
                            const minutes = String(now.getMinutes()).padStart(2, '0');
                            const seconds = String(now.getSeconds()).padStart(2, '0');
                            timeDisplay.textContent = \`\${hours}:\${minutes}:\${seconds}\`;
                        }

                        function generateUUID() {
                            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                                const r = Math.random() * 16 | 0;
                                const v = c == 'x' ? r : (r & 0x3 | 0x8);
                                return v.toString(16);
                            });
                        }


                        function generateRandomPattern() {
                            const timestamp = new Date().getTime();
                            const uuid = generateUUID();
                            const random = Math.random().toString(36).substring(2);

                            
                            const earlyRoles = Array.from(document.querySelectorAll('input[name="early-roles"]:checked'))
                                .map(input => input.value);

                            
                            const cutoffTimeStr = document.getElementById('cutoff-time').value || '09:30';
                            const [hour, minute] = cutoffTimeStr.split(':').map(Number);
                            const cutoffTime = [hour, minute, 0, 0]; // [hour, minute, second, ms]

                            const configData = JSON.stringify({ cutoffTime, earlyRoles });

                            return \`\${timestamp}-\${uuid}-\${random}-\${btoa(configData)}\`;
                        }

                        function updateQRCode() {
                            const pattern = generateRandomPattern();
                            if (previousPatterns.has(pattern)) {
                                console.log('Pattern collision detected, generating new pattern');
                                return updateQRCode();
                            }
                            previousPatterns.add(pattern);
                            if (previousPatterns.size > 1000) {
                                const iterator = previousPatterns.values();
                                previousPatterns.delete(iterator.next().value);
                            }
                            const qr = qrcode(0, 'L');
                            qr.addData(pattern);
                            qr.make();
                            const qrContainer = document.getElementById('qr-code');
                            qrContainer.innerHTML = qr.createImgTag(12);
                            qrContainer.style.display = 'block';
                            console.log('Generated new pattern:', pattern);
                        }

                        window.generateQRCode = function() {
                            updateQRCode();
                            // Update QR code every 7 seconds
                            clearInterval(window.qrInterval);
                            window.qrInterval = setInterval(updateQRCode, 7000);
                        };

                        // Update time every second
                        setInterval(updateTime, 1000);

                        // Prevent window from being closed accidentally
                        window.onbeforeunload = function(e) {
                            e.preventDefault();
                            e.returnValue = '';
                        };
                    <\/script>
                </body>
                </html>
            `;
        }

        // Update the window opening function to create a larger window
        function openQRCodeWindow() {
            // Close existing window if open
            if (qrWindow && !qrWindow.closed) {
                qrWindow.close();
            }

            // Open new window with larger dimensions
            qrWindow = window.open('', 'QRCodeWindow', 'width=1500,height=800');
            qrWindow.document.write(createQRWindowContent());
        }

        // Add event listener to the button
        document.addEventListener('DOMContentLoaded', function() {
            const qrButton = document.getElementById('show-qr-code');
            if (qrButton) {
                qrButton.addEventListener('click', openQRCodeWindow);
            }
        });

        // Clean up when the main window is closed
        window.addEventListener('beforeunload', function() {
            if (qrWindow && !qrWindow.closed) {
                qrWindow.close();
            }
        });

        // Initialize admin user (Run this once to set up admin)
        async function initializeAdmin() {
            try {
                const adminEmail = 'admin@snext.com';
                const adminPassword = 'admin123'; // Default admin password
                
                // Create admin user
                const userCredential = await auth.createUserWithEmailAndPassword(adminEmail, adminPassword);
                const user = userCredential.user;
                
                // Set admin privileges
                await database.ref(`users/${user.uid}`).set({
                    isAdmin: true,
                    email: adminEmail,
                    createdAt: new Date().toISOString(),
                    lastModified: new Date().toISOString()
                });
                
                console.log('Admin user created successfully');
                alert('Admin account created successfully. Please login with admin@snext.com and admin123');
            } catch (error) {
                console.error('Error creating admin:', error);
                if (error.code !== 'auth/email-already-in-use') {
                    throw error;
                }
            }
        }

        // Update the loadAllApplications function
        async function loadAllApplications(filterEmployeeId = null) {
            try {
                const applicationsRef = database.ref('applications');
                applicationsRef.on('value', (snapshot) => {
                    const applications = snapshot.val() || {};
                    const selectedYear = window.getSelectedYear ? window.getSelectedYear() : null; // Get selected year
                    // Update calendar regardless of filter
                    updateCalendarEvents(applications);

                    const tableBody = document.getElementById('application-list-body');
                    if (!tableBody) return;

                    tableBody.innerHTML = '';

                    // Filter applications if employeeId is provided and not empty
                    let filteredApplications = Object.entries(applications);
                    if (filterEmployeeId && filterEmployeeId.trim() !== '') {
                        filteredApplications = filteredApplications.filter(([, app]) => 
                            app.employeeId === filterEmployeeId
                        );
                    }

                    if (selectedYear) {
                        filteredApplications = filteredApplications.filter(([, app]) => 
                            new Date(app.applyDate).getFullYear().toString() === selectedYear
                        );
                    }

                    // Sort applications by date (newest first)
                    const sortedApplications = filteredApplications
                        .sort(([, a], [, b]) => new Date(b.applyDate) - new Date(a.applyDate));

                    if (sortedApplications.length === 0) {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td colspan="8" class="text-center py-4 text-gray-500">
                                No records found
                            </td>
                        `;
                        tableBody.appendChild(row);
                        return;
                    }

                    for (const [id, application] of sortedApplications) {
                        const row = document.createElement('tr');
                        
                        // Format dates with time for apply date
                        const applyDateTime = new Date(application.createdAt || application.applyDate);
                        const startDate = new Date(application.leaveStartDate);
                        const endDate = new Date(application.leaveEndDate);

                        const formattedApplyDateTime = `${formatDate(applyDateTime)} ${formatTime(applyDateTime)}`;
                        const formattedStartDate = formatDate(startDate);
                        const formattedEndDate = formatDate(endDate);

                        row.innerHTML = `
                            <td>${application.employeeName}</td>
                            <td>${formattedApplyDateTime}</td>
                            <td>${formattedStartDate}</td>
                            <td>${formattedEndDate}</td>
                            <td>${application.leaveType}</td>
                            <td>
                                <span class="status-${application.status.toLowerCase()}">${application.status}</span>
                                ${application.status === 'Approved' ? `
                                    <button type="button" class="reject-btn" onclick="rejectApplication('${id}', '${application.employeeId}', '${application.leaveType}')">
                                        Reject
                                    </button>
                                ` : ''}
                            </td>
                            <td>
                                ${(application.leaveType === 'Sick Leave' || 
                                application.leaveType === '不可抗力因素' || 
                                application.leaveType === '離港') && application.proof ? 
                                    `<button type="button" class="show-proof-btn" onclick="showProof('${id}')">View Proof</button>` : 
                                    'N/A'}
                            </td>
                            <td>
                                <button type="button" 
                                        class="remove-btn-small" 
                                        onclick="handleRemoveSingleApplication(event, '${id}', '${application.employeeId}', '${application.leaveType}', ${application.leaveDays}, '${application.status}')">
                                    Remove
                                </button>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    }
                });
            } catch (error) {
                console.error('Error loading applications:', error);
                showSyncStatus('Error loading applications', 'error');
            }
        }

        // Initialize year filter buttons
        document.addEventListener('DOMContentLoaded', function() {
            const year2028Btn = document.getElementById('filter-year-2028');
            const year2027Btn = document.getElementById('filter-year-2027');
            const year2026Btn = document.getElementById('filter-year-2026');
            const year2025Btn = document.getElementById('filter-year-2025');

            if (year2028Btn) {
                year2028Btn.addEventListener('click', function() {
                    selectedYear = selectedYear === '2028' ? null : '2028';
                    loadAllApplications(document.getElementById('application-employee-filter').value);
                });
            }

            if (year2027Btn) {
                year2027Btn.addEventListener('click', function() {
                    selectedYear = selectedYear === '2027' ? null : '2027';
                    loadAllApplications(document.getElementById('application-employee-filter').value);
                });
            }

            if (year2026Btn) {
                year2026Btn.addEventListener('click', function() {
                    selectedYear = selectedYear === '2026' ? null : '2026';
                    loadAllApplications(document.getElementById('application-employee-filter').value);
                });
            }

            if (year2025Btn) {
                year2025Btn.addEventListener('click', function() {
                    selectedYear = selectedYear === '2025' ? null : '2025';
                    loadAllApplications(document.getElementById('application-employee-filter').value);
                });
            }
        });

        // Add this new handler function
        function handleRemoveSingleApplication(event, ...args) {
            event.preventDefault();
            event.stopPropagation();
            removeSingleApplication(...args);
        }

        function showScanResult(message, isSuccess) {
            const resultDiv = document.getElementById('scan-result');
            resultDiv.style.display = 'block';
            
            if (isSuccess) {
                resultDiv.innerHTML = `
                    <div class="success-animation">
                        <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                            <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none"/>
                            <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
                        </svg>
                        <p style="margin-top: 20px; color: #4CAF50; text-align: center; font-weight: bold;">
                            ${message}
                        </p>
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div class="success-animation">
                        <p style="color: #f44336; text-align: center; font-weight: bold;">
                            ${message}
                        </p>
                    </div>
                `;
            }

            setTimeout(() => {
                resultDiv.style.display = 'none';
                resultDiv.innerHTML = '';
            }, 3000);
        }

        // Add the rejectApplication function to handle rejection
        async function rejectApplication(applicationId, employeeId, leaveType) {
            try {
                if (!confirm('Are you sure you want to reject this application?')) {
                    return;
                }

                // Get the application data
                const applicationSnapshot = await database.ref(`applications/${applicationId}`).once('value');
                const application = applicationSnapshot.val();

                if (!application) {
                    throw new Error('Application not found');
                }

                // Get employee data
                const employeeRef = database.ref(`employees/${employeeId}`);
                const employeeSnapshot = await employeeRef.once('value');
                const employeeData = employeeSnapshot.val();

                if (!employeeData) {
                    throw new Error('Employee not found');
                }

                const updates = {};

                // Check for Mondays if it's an Annual Leave
                if (leaveType.includes('Annual Leave')) {
                    const startDate = new Date(application.leaveStartDate);
                    const endDate = new Date(application.leaveEndDate);
                    const mondayCount = countMondaysInDateRange(startDate, endDate);
                    
                    if (mondayCount > 0) {
                        // Subtract the Mondays from the used Monday leaves count
                        const newMondayCount = Math.max(0, (employeeData.usedMondayLeaves || 0) - mondayCount);
                        updates.usedMondayLeaves = newMondayCount;
                    }
                }

                // Update application status
                await database.ref(`applications/${applicationId}`).update({
                    status: 'Rejected',
                    rejectedAt: new Date().toISOString(),
                    rejectedBy: auth.currentUser.uid
                });

                // Restore the leave days for annual leaves
                if (leaveType.includes('Annual Leave')) {
                    const startDate = new Date(application.leaveStartDate);
                    const endDate = new Date(application.leaveEndDate);
                    const leaveDays = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;

                    if (leaveType === 'Annual Leave (Normal)' && employeeData.remainingNormalLeaves !== 999) {
                        updates.remainingNormalLeaves = employeeData.remainingNormalLeaves + leaveDays;
                    } else if (leaveType === 'Annual Leave (黃金事假)') {
                        if (employeeData.remainingGoldenLeaves !== 999) {
                            updates.remainingGoldenLeaves = employeeData.remainingGoldenLeaves + leaveDays;
                        }
                        if (employeeData.remainingNormalLeaves !== 999) {
                            updates.remainingNormalLeaves = employeeData.remainingNormalLeaves + leaveDays;
                        }
                    }
                }

                // Update employee data if there are any updates
                if (Object.keys(updates).length > 0) {
                    await employeeRef.update(updates);
                }

                // Recalculate used days
                const usedDays = await calculateUsedDays(employeeId);
                updateDisplayedUsedDays(
                    usedDays.sickLeaveDays,
                    usedDays.forceMajeureDays,
                    usedDays.overseasDays
                );

                showSyncStatus('Application rejected successfully');
            } catch (error) {
                console.error('Error rejecting application:', error);
                alert('Error rejecting application: ' + error.message);
            }
        }

        async function updateUsedLeaveDays(employeeId, leaveType, daysToAdd) {
            try {
                // Get current employee data
                const employeeRef = database.ref(`employees/${employeeId}`);
                const snapshot = await employeeRef.once('value');
                const employeeData = snapshot.val();

                if (!employeeData) {
                    throw new Error('Employee not found');
                }

                // Initialize used days fields if they don't exist
                if (!employeeData.usedSickLeaveDays) employeeData.usedSickLeaveDays = 0;
                if (!employeeData.usedForceLeavesDays) employeeData.usedForceLeavesDays = 0;
                if (!employeeData.usedTravelDays) employeeData.usedTravelDays = 0;

                // Update the appropriate field based on leave type
                const updates = {};
                switch (leaveType) {
                    case 'Sick Leave':
                        updates.usedSickLeaveDays = employeeData.usedSickLeaveDays + daysToAdd;
                        break;
                    case '不可抗力因素':
                        updates.usedForceLeavesDays = employeeData.usedForceLeavesDays + daysToAdd;
                        break;
                    case '離港':
                        updates.usedTravelDays = employeeData.usedTravelDays + daysToAdd;
                        break;
                }

                // Update the database
                if (Object.keys(updates).length > 0) {
                    await employeeRef.update(updates);
                    console.log(`Updated ${leaveType} days for employee ${employeeId}`);
                }

            } catch (error) {
                console.error('Error updating used leave days:', error);
                throw error;
            }
        }

        // Update the removeSingleApplication function
        async function removeSingleApplication(applicationId, employeeId, leaveType, leaveDays, status) {
            try {
                // Check if user is admin
                const user = auth.currentUser;
                if (!user) {
                    throw new Error('You must be logged in to remove applications');
                }

                const adminSnapshot = await database.ref(`users/${user.uid}/isAdmin`).once('value');
                if (!adminSnapshot.val()) {
                    throw new Error('Only administrators can remove applications');
                }

                if (!confirm('Are you sure you want to remove this leave application?')) {
                    return;
                }

                // Get the application details first
                const applicationRef = database.ref(`applications/${applicationId}`);
                const applicationSnapshot = await applicationRef.once('value');
                const application = applicationSnapshot.val();

                if (!application) {
                    throw new Error('Application not found');
                }

                // Get employee data
                const employeeRef = database.ref(`employees/${employeeId}`);
                const employeeSnapshot = await employeeRef.once('value');
                const employeeData = employeeSnapshot.val();

                if (!employeeData) {
                    throw new Error('Employee data not found');
                }

                const updates = {};

                // Only process if the application was approved
                if (status === 'Approved') {
                    // Check if there are any Mondays in the leave period
                    if (leaveType.includes('Annual Leave')) {
                        const startDate = new Date(application.leaveStartDate);
                        const endDate = new Date(application.leaveEndDate);
                        const mondayCount = countMondaysInDateRange(startDate, endDate);
                        
                        if (mondayCount > 0) {
                            // Subtract the Mondays from the used Monday leaves count
                            const newMondayCount = Math.max(0, (employeeData.usedMondayLeaves || 0) - mondayCount);
                            updates.usedMondayLeaves = newMondayCount;
                        }
                    }

                    // Return leave days
                    if (leaveType === 'Annual Leave (Normal)') {
                        if (employeeData.remainingNormalLeaves !== 999) {
                            updates.remainingNormalLeaves = employeeData.remainingNormalLeaves + leaveDays;
                            // Ensure it doesn't exceed original allocation
                            if (updates.remainingNormalLeaves > employeeData.normalLeaves) {
                                updates.remainingNormalLeaves = employeeData.normalLeaves;
                            }
                        }
                    } else if (leaveType === 'Annual Leave (黃金事假)') {
                        if (employeeData.remainingGoldenLeaves !== 999) {
                            updates.remainingGoldenLeaves = employeeData.remainingGoldenLeaves + leaveDays;
                            // Ensure it doesn't exceed original allocation
                            if (updates.remainingGoldenLeaves > employeeData.goldenLeaves) {
                                updates.remainingGoldenLeaves = employeeData.goldenLeaves;
                            }
                        }
                        if (employeeData.remainingNormalLeaves !== 999) {
                            updates.remainingNormalLeaves = employeeData.remainingNormalLeaves + leaveDays;
                            // Ensure it doesn't exceed original allocation
                            if (updates.remainingNormalLeaves > employeeData.normalLeaves) {
                                updates.remainingNormalLeaves = employeeData.normalLeaves;
                            }
                        }
                    }
                }

                // Update employee data if there are changes
                if (Object.keys(updates).length > 0) {
                    await employeeRef.update(updates);

                    // If Monday count was updated, update the display
                    if (updates.usedMondayLeaves !== undefined) {
                        const mondayLeavesElement = document.getElementById('used-monday-leaves');
                        if (mondayLeavesElement) {
                            mondayLeavesElement.textContent = updates.usedMondayLeaves;
                        }
                    }
                }

                // Remove the application
                await applicationRef.remove();

                // Refresh the data displays
                await loadEmployees();
                await loadAllApplications();

                showSyncStatus('Leave application removed successfully');
            } catch (error) {
                console.error('Error removing application:', error);
                alert('Error removing application: ' + error.message);
            }
        }

        function updateDisplayedUsedDays(sickDays, forceDays, travelDays) {
            const sickLeaveElement = document.getElementById('used-sick-leave');
            const forceMajeureElement = document.getElementById('used-force-majeure');
            const overseasElement = document.getElementById('used-overseas');

            if (sickLeaveElement) sickLeaveElement.textContent = sickDays;
            if (forceMajeureElement) forceMajeureElement.textContent = forceDays;
            if (overseasElement) overseasElement.textContent = travelDays;
        }

        async function updateLeaveStatus(applicationId, newStatus, rejectionReason = '') {
            try {
                const user = auth.currentUser;
                if (!user) {
                    throw new Error('You must be logged in to update leave status');
                }

                // Get the application data first
                const applicationRef = database.ref(`applications/${applicationId}`);
                const snapshot = await applicationRef.once('value');
                const application = snapshot.val();

                if (!application) {
                    throw new Error('Application not found');
                }

                // Calculate the number of days
                const startDate = new Date(application.leaveStartDate);
                const endDate = new Date(application.leaveEndDate);
                const daysDifference = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;

                // Prepare updates object
                const updates = {
                    status: newStatus,
                    updatedAt: new Date().toISOString(),
                    updatedBy: user.uid
                };

                if (rejectionReason) {
                    updates.rejectionReason = rejectionReason;
                }

                // Update the application status
                await applicationRef.update(updates);

                // If the application is approved, update the used days count
                if (newStatus === 'Approved') {
                    await updateUsedLeaveDays(
                        application.employeeId,
                        application.leaveType,
                        daysDifference
                    );
                }

                // Show success message
                showSyncStatus(`Leave application ${newStatus.toLowerCase()} successfully`);

                // Refresh the applications table
                loadAllApplications();

            } catch (error) {
                console.error('Error updating leave status:', error);
                showSyncStatus(`Error updating leave status: ${error.message}`, 'error');
            }
        }

        // Function to show admin interface
        function showAdminInterface() {
            document.getElementById('home-page').style.display = 'none';
            document.getElementById('admin-page').style.display = 'block';
            document.getElementById('employee-page').style.display = 'none';
            
            window.employeeData = {};
            window.penaltyData = {};

            loadEmployees();
            loadAllPenalties();
            loadAllApplications();
            updateAllEmployeeSelects();
            initializeFilters(); // Initialize the simplified filter

            // Explicitly fetch the latest attendance data directly from Firebase
            fetchLatestAttendanceData().then(() => {
                console.log('Latest attendance data fetched successfully');
            }).catch(error => {
                console.error('Error fetching latest attendance data:', error);
                showSyncStatus('Error loading attendance data', 'error');
            });            
            
            // Then set up real-time listeners for ongoing updates
            initializeAttendanceTable();

            // Add event listeners for logout buttons
            document.getElementById('logout-btn').addEventListener('click', logout);
            document.getElementById('export-applications-btn').addEventListener('click', exportApplicationsToExcel);
            document.getElementById('export-penalties-btn').addEventListener('click', exportPenaltiesToExcel);

            // Initialize the collapse state
            const container = document.getElementById('agentListContainer');
            const toggleButton = document.getElementById('toggleAgentList');
            const isCollapsed = localStorage.getItem('agentListCollapsed') === 'true';
            
            if (container && toggleButton) {
                if (isCollapsed) {
                    container.classList.remove('expanded');
                    container.classList.add('collapsed');
                    toggleButton.classList.add('collapsed');
                    toggleButton.innerHTML = '<span class="collapse-icon">▼</span> Expand Agent List';
                } else {
                    container.classList.add('expanded');
                    container.classList.remove('collapsed');
                    toggleButton.classList.remove('collapsed');
                    toggleButton.innerHTML = '<span class="collapse-icon">▼</span> Collapse Agent List';
                }
            }
            // Initialize attendance records table and filters
            loadAllAttendanceRecords();
            setupAttendanceFilters();

            // Show success message
            showSyncStatus('Admin interface loaded with latest data');            
        }

        //Directly fetch the latest attendance data from Firebase
        async function fetchLatestAttendanceData() {
            try {
                const tableBody = document.getElementById('allAttendanceTableBody');
                if (!tableBody) return;
                
                // Show loading state
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-4 text-center">
                            <div class="flex justify-center items-center">
                                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                                <span class="ml-2">Loading latest attendance data...</span>
                            </div>
                        </td>
                    </tr>
                `;
                
                // Get a fresh reference to the attendance data
                const attendanceRef = database.ref('attendance');
                const snapshot = await attendanceRef.get();
                
                // Use a Map to track unique records by ID
                const uniqueRecords = new Map();
                
                snapshot.forEach(childSnapshot => {
                    const record = childSnapshot.val();
                    if (record && record.employeeName && record.timestamp) {
                        // Store in map using record ID as key to prevent duplicates
                        uniqueRecords.set(childSnapshot.key, {
                            id: childSnapshot.key,
                            ...record
                        });
                    }
                });
                
                // Convert map to array
                const records = Array.from(uniqueRecords.values());
                
                // Clear loading state
                tableBody.innerHTML = '';
                
                // Handle empty records case
                if (records.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                                No attendance records found
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                // Sort records by timestamp (newest first)
                records.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                // Apply any filters from filter inputs (if present)
                const dateFilter = document.getElementById('dateFilter')?.value;
                const statusFilter = document.getElementById('statusFilter')?.value;
                const employeeFilter = document.getElementById('attendanceEmployeeFilter')?.value;
                
                let filteredRecords = records;
                
                if (dateFilter) {
                    filteredRecords = filteredRecords.filter(record => {
                        const recordDate = new Date(record.timestamp).toISOString().split('T')[0];
                        return recordDate === dateFilter;
                    });
                }
                
                if (statusFilter) {
                    filteredRecords = filteredRecords.filter(record => 
                        record.status === statusFilter
                    );
                }
                
                if (employeeFilter) {
                    filteredRecords = filteredRecords.filter(record => 
                        record.employeeId === employeeFilter
                    );
                }
                
                // Populate table with filtered records
                filteredRecords.forEach(record => {
                    const row = document.createElement('tr');
                    const recordTime = new Date(record.timestamp);
                    
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">
                                ${record.employeeName || 'N/A'}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">
                                ${record.role || 'N/A'}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">
                                ${formatDate(recordTime)} ${formatTime(recordTime)}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="status-badge ${record.status?.toLowerCase() === 'punctual' ? 'punctual' : 'late'}">
                                ${record.status}
                                ${record.amount > 0 ? `<span class="penalty-amount">(-$${record.amount})</span>` : ''}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">
                                ${record.ipAddress || 'N/A'}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <button onclick="removeAttendanceRecord('${record.id}')" 
                                    class="remove-btn-small">
                                Remove
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
                
                console.log(`Loaded ${filteredRecords.length} attendance records successfully`);
                
            } catch (error) {
                console.error('Error fetching latest attendance data:', error);
                throw error;
            }
        }

        // Handle agent filter changes
        function handleAgentFilterChange() {
            const agentFilter = document.getElementById('application-employee-filter');
            const yearFilter = document.getElementById('yearFilter');
            const monthFilter = document.getElementById('monthFilter');
            const dayFilter = document.getElementById('dayFilter');

            agentFilter.addEventListener('change', function() {
                const selectedAgentId = this.value;
                
                // Reset date filters when agent changes
                yearFilter.value = '';
                monthFilter.value = '';
                dayFilter.value = '';

                // Reload applications with the selected agent filter
                loadAllApplications(selectedAgentId);
            });
        }

        // Function to show proof for leave applications
        function showProof(applicationId) {
            const modal = document.getElementById('proof-modal');
            const proofContent = document.getElementById('proof-content');
            
            // Show loading state
            proofContent.innerHTML = '<div style="text-align: center; padding: 20px;">Loading proof...</div>';
            modal.style.display = 'flex'; // Changed from 'block' to 'flex'
            
            // Add animation
            requestAnimationFrame(() => {
                modal.classList.add('show');
            });

            // Fetch the proof from Firebase
            database.ref(`applications/${applicationId}/proof`).once('value')
                .then((snapshot) => {
                    const proofData = snapshot.val();
                    if (proofData) {
                        const img = new Image();
                        img.onload = function() {
                            proofContent.innerHTML = `
                                <img src="${proofData}" 
                                    alt="Submitted Proof"
                                    style="max-width: 100%; max-height: 70vh; object-fit: contain;">
                            `;
                        };
                        img.src = proofData;
                    } else {
                        proofContent.innerHTML = '<div style="text-align: center; padding: 20px;">No proof available</div>';
                    }
                })
                .catch(error => {
                    console.error('Error loading proof:', error);
                    proofContent.innerHTML = '<div style="text-align: center; padding: 20px; color: red;">Error loading proof</div>';
                });
        }

        // Add this function to synchronize all employee select dropdowns
        function updateAllEmployeeSelects() {
            const penaltySelect = document.getElementById('penalty-employee');
            const leaveSelect = document.getElementById('admin-leave-employee');
            const applicationFilter = document.getElementById('application-employee-filter');
            
            // Get employees from database
            const employeeRef = database.ref('employees');
            employeeRef.once('value', (snapshot) => {
                const employees = snapshot.val() || {};
                
                // Sort employees by name
                const sortedEmployees = Object.entries(employees)
                    .sort(([, a], [, b]) => a.name.localeCompare(b.name));

                // Create the HTML options
                const optionsHTML = sortedEmployees.map(([id, employee]) => 
                    `<option value="${id}">${employee.name}</option>`
                ).join('');

                // Set different default options for different selects
                if (penaltySelect) {
                    penaltySelect.innerHTML = '<option value="">Select Agent</option>' + optionsHTML;
                }
                if (leaveSelect) {
                    leaveSelect.innerHTML = '<option value="">Select Agent</option>' + optionsHTML;
                }
                if (applicationFilter) {
                    // Make sure "All Agents" is always the first option for the filter
                    applicationFilter.innerHTML = '<option value="">All Agents</option>' + optionsHTML;
                }
            });
        }

        // Function to export applications to Excel
        function exportApplicationsToExcel() {
            try {
                // Get the applications data
                const table = document.getElementById('application-list-table');
                if (!table) {
                    throw new Error('Table not found');
                }

                // Create CSV content
                let csvContent = '\uFEFF'; // Add BOM for Excel to handle Chinese characters correctly
                
                // Add headers
                const headers = [];
                table.querySelectorAll('thead th').forEach(header => {
                    headers.push(header.innerText);
                });
                csvContent += headers.join(',') + '\n';

                // Add data rows
                table.querySelectorAll('tbody tr').forEach(row => {
                    const rowData = [];
                    row.querySelectorAll('td').forEach(cell => {
                        // Get only the text content, remove any HTML
                        let cellText = cell.innerText.replace(/,/g, '，'); // Replace commas with Chinese comma
                        // Remove any new lines
                        cellText = cellText.replace(/\n/g, ' ');
                        rowData.push('"' + cellText + '"');
                    });
                    csvContent += rowData.join(',') + '\n';
                });

                // Create blob and download
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                // Get current date for filename
                const date = new Date().toISOString().slice(0,10);
                
                link.setAttribute('href', url);
                link.setAttribute('download', `Leave_Applications_${date}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showSyncStatus('Applications exported successfully');
            } catch (error) {
                console.error('Error exporting applications:', error);
                alert('Error exporting applications: ' + error.message);
            }
        }

        // Function to load all attendance records
        function loadAllAttendanceRecords() {
            const attendanceRef = database.ref('attendance');
            const tableBody = document.getElementById('allAttendanceTableBody');

            if (!tableBody) return;

            attendanceRef.once('value', (snapshot) => {
                // Use a Map to prevent duplicates by ID
                const uniqueRecords = new Map();
                
                snapshot.forEach(childSnapshot => {
                    const record = childSnapshot.val();
                    if (record && record.employeeName && record.timestamp) {
                        uniqueRecords.set(childSnapshot.key, {
                            id: childSnapshot.key,
                            ...record
                        });
                    }
                });
                
                // Convert Map to array
                const records = Array.from(uniqueRecords.values());

                // Sort records by timestamp (newest first)
                records.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                // Clear existing table
                tableBody.innerHTML = '';

                if (records.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                                No attendance records found
                            </td>
                        </tr>
                    `;
                    return;
                }

                // Apply filters
                const dateFilter = document.getElementById('dateFilter')?.value;
                const statusFilter = document.getElementById('statusFilter')?.value;
                const employeeFilter = document.getElementById('attendanceEmployeeFilter')?.value;
                
                let filteredRecords = records;
                
                if (dateFilter) {
                    filteredRecords = filteredRecords.filter(record => {
                        const recordDate = new Date(record.timestamp).toISOString().split('T')[0];
                        return recordDate === dateFilter;
                    });
                }
                
                if (statusFilter) {
                    filteredRecords = filteredRecords.filter(record => 
                        record.status === statusFilter
                    );
                }
                
                if (employeeFilter) {
                    filteredRecords = filteredRecords.filter(record => 
                        record.employeeId === employeeFilter
                    );
                }

                // Populate table with records
                filteredRecords.forEach(record => {
                    const recordTime = new Date(record.timestamp);
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4">${record.employeeName || 'N/A'}</td>
                        <td class="px-6 py-4">${record.role || 'N/A'}</td>
                        <td class="px-6 py-4">${formatDate(recordTime)} ${formatTime(recordTime)}</td>
                        <td class="px-6 py-4">
                            <span class="status-badge ${record.status?.toLowerCase() === 'punctual' ? 'punctual' : 'late'}">
                                ${record.status}
                                ${record.amount > 0 ? `<span class="penalty-amount">(-$${record.amount})</span>` : ''}
                            </span>
                        </td>
                        <td class="px-6 py-4">${record.ipAddress || 'N/A'}</td>
                        <td class="px-6 py-4">
                            <button onclick="removeAttendanceRecord('${record.id}')" 
                                    class="remove-btn-small">
                                Remove
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            });
        }

        async function removeAttendanceRecord(userId, recordId) {
            try {
                // Check if user is admin
                const currentUser = auth.currentUser;
                if (!currentUser) {
                    throw new Error('You must be logged in to remove records');
                }

                const adminSnapshot = await database.ref(`users/${currentUser.uid}/isAdmin`).once('value');
                if (!adminSnapshot.val()) {
                    throw new Error('Only administrators can remove attendance records');
                }

                // Confirm deletion
                if (!confirm('Are you sure you want to remove this attendance record?')) {
                    return;
                }

                // Remove the record
                await database.ref(`attendance/${userId}/${recordId}`).remove();

                // Show success message
                showSyncStatus('Attendance record removed successfully');

                // Records will automatically update due to the real-time listener
            } catch (error) {
                console.error('Error removing attendance record:', error);
                alert('Error removing attendance record: ' + error.message);
            }
        }

        function filterPenaltyTable() {
            const statusFilterValue = document.getElementById('penaltyStatusFilter').value;
            const dateFilterValue = document.getElementById('penaltyDateFilter').value;
            const tbody = document.getElementById('penalty-list');
            const rows = tbody.getElementsByTagName('tr');

            console.log(`Status Filter: ${statusFilterValue}, Date Filter: ${dateFilterValue}`); // Debug
            for (let i = 0; i < rows.length; i++) {
                const statusCell = rows[i].getElementsByTagName('td')[6]; // Status/Action (index 6)
                const dateCell = rows[i].getElementsByTagName('td')[1]; // Date (index 1)
                let showRow = true;

                // Status filter
                if (statusCell) {
                    const statusSpan = statusCell.querySelector('.status-submitted, .status-not-submitted');
                    let statusText = '';
                    if (statusSpan) {
                        statusText = statusSpan.textContent.trim().toLowerCase();
                    } else {
                        statusText = statusCell.textContent.trim().toLowerCase();
                    }
                    console.log(`Row ${i}: Status = "${statusText}"`); // Debug
                    const statusMatches = statusFilterValue === 'All' ||
                                        (statusFilterValue === 'Submitted' && statusText === 'submitted') ||
                                        (statusFilterValue === 'Not Submitted' && statusText === 'not submitted');
                    showRow = showRow && statusMatches;
                } else {
                    showRow = false; // Hide rows without status
                    console.log(`Row ${i}: No status cell`);
                }

                // Date filter
                if (dateCell && dateFilterValue) {
                    let dateText = dateCell.textContent.trim();
                    // Normalize date format (assume input is DD/MM/YYYY, convert to YYYY-MM-DD for comparison)
                    if (dateText.includes('/')) {
                        const [day, month, year] = dateText.split('/');
                        dateText = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                    }
                    console.log(`Row ${i}: Date = "${dateText}"`); // Debug
                    showRow = showRow && (dateText === dateFilterValue);
                }

                rows[i].style.display = showRow ? '' : 'none';
            }
        }

        function resetPenaltyFilter() {
            const filter = document.getElementById('penaltyStatusFilter');
            const dfilter = document.getElementById('penaltyDateFilter');
            filter.value = 'All';
            dfilter.value = '';
            filterPenaltyTable();
        }

        // Apply filter on page load
        document.addEventListener('DOMContentLoaded', () => {
            filterPenaltyTable();
            // Observe changes to tbody for dynamic updates
            const tbody = document.getElementById('penalty-list');
            const observer = new MutationObserver(filterPenaltyTable);
            observer.observe(tbody, { childList: true, subtree: true });
        });

        // Add event listeners for filters
        function setupAttendanceFilters() {
            const dateFilter = document.getElementById('dateFilter');
            const statusFilter = document.getElementById('statusFilter');
            const employeeFilter = document.getElementById('attendanceEmployeeFilter');
            const resetFilters = document.getElementById('resetFilters');

            // Update employee filter options when employees are loaded
            const employeeRef = database.ref('employees');
            employeeRef.on('value', (snapshot) => {
                const employees = snapshot.val() || {};
                
                // Sort employees by name
                const sortedEmployees = Object.entries(employees)
                    .sort(([, a], [, b]) => a.name.localeCompare(b.name));

                // Keep the "All Agents" option and add sorted employees
                employeeFilter.innerHTML = '<option value="">All Agents</option>';
                sortedEmployees.forEach(([id, employee]) => {
                    employeeFilter.innerHTML += `<option value="${id}">${employee.name}</option>`;
                });
            });

            // Modify the loadAllAttendanceRecords function to use the new filter
            function filterAttendanceRecords() {
                const attendanceRef = database.ref('attendance');
                const tableBody = document.getElementById('allAttendanceTableBody');

                attendanceRef.once('value', (snapshot) => {
                    const records = [];
                    snapshot.forEach(userSnapshot => {
                        const userId = userSnapshot.key;
                        userSnapshot.forEach(recordSnapshot => {
                            const record = recordSnapshot.val();
                            records.push({
                                ...record,
                                userId: userId,
                                recordId: recordSnapshot.key
                            });
                        });
                    });

                    // Sort records by timestamp (most recent first)
                    records.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                    // Apply filters
                    let filteredRecords = records;

                    if (dateFilter.value) {
                        filteredRecords = filteredRecords.filter(record => {
                            const recordDate = new Date(record.timestamp).toISOString().split('T')[0];
                            return recordDate === dateFilter.value;
                        });
                    }

                    if (statusFilter.value) {
                        filteredRecords = filteredRecords.filter(record => 
                            record.status === statusFilter.value
                        );
                    }

                    if (employeeFilter.value) {
                        filteredRecords = filteredRecords.filter(record => 
                            record.userId === employeeFilter.value
                        );
                    }

                    // Clear existing table
                    tableBody.innerHTML = '';

                    if (filteredRecords.length === 0) {
                        tableBody.innerHTML = `
                            <tr>
                                <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                                    No attendance records found
                                </td>
                            </tr>
                        `;
                        return;
                    }

                    // Populate table with filtered records
                    filteredRecords.forEach(record => {
                        const row = document.createElement('tr');
                        const recordTime = new Date(record.timestamp);
                        
                        row.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900">
                                    ${record.employeeName || 'N/A'}
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900">
                                    ${record.employeeRole || 'N/A'}
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900">
                                    ${recordTime.toLocaleDateString()} ${recordTime.toLocaleTimeString()}
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="status-badge ${record.status === 'Punctual' ? 'punctual' : 'late'}">
                                    ${record.status}
                                    ${record.amount > 0 ? `<span class="penalty-amount">(-$${record.amount})</span>` : ''}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900">
                                    ${record.ipAddress || 'N/A'}
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <button onclick="removeAttendanceRecord('${record.userId}', '${record.recordId}')" 
                                        class="remove-btn-small">
                                    Remove
                                </button>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                });
            }

            // Add event listeners
            dateFilter.addEventListener('change', filterAttendanceRecords);
            statusFilter.addEventListener('change', filterAttendanceRecords);
            employeeFilter.addEventListener('change', filterAttendanceRecords);

            resetFilters.addEventListener('click', () => {
                dateFilter.value = '';
                statusFilter.value = '';
                employeeFilter.value = '';
                filterAttendanceRecords();
            });

            // Initial load
            filterAttendanceRecords();
        }

        // Function to export penalties to Excel
        function exportPenaltiesToExcel() {
            try {
                // Get the penalties data
                const table = document.getElementById('penalty-table');
                if (!table) {
                    throw new Error('Table not found');
                }

                // Create CSV content
                let csvContent = '\uFEFF'; // Add BOM for Excel to handle Chinese characters correctly
                
                // Add headers
                const headers = [];
                table.querySelectorAll('thead th').forEach(header => {
                    headers.push(header.innerText);
                });
                csvContent += headers.join(',') + '\n';

                // Add data rows
                table.querySelectorAll('tbody tr').forEach(row => {
                    const rowData = [];
                    row.querySelectorAll('td').forEach(cell => {
                        // Get text content and handle special cases
                        let cellText = cell.innerText;
                        
                        // Handle amount column (remove currency symbol and 'Doubled' text)
                        if (cellText.includes('$')) {
                            cellText = cellText.replace('$', '')
                                            .replace(' (Doubled)', '')
                                            .replace(' (Double Cancelled)', '');
                        }
                        
                        // Clean up the text
                        cellText = cellText.replace(/,/g, '，') // Replace commas with Chinese comma
                                        .replace(/\n/g, ' ') // Remove new lines
                                        .trim();
                        
                        rowData.push('"' + cellText + '"');
                    });
                    csvContent += rowData.join(',') + '\n';
                });

                // Create blob and download
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                // Get current date for filename
                const date = new Date().toISOString().slice(0,10);
                
                link.setAttribute('href', url);
                link.setAttribute('download', `Penalties_${date}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showSyncStatus('Penalties exported successfully');
            } catch (error) {
                console.error('Error exporting penalties:', error);
                alert('Error exporting penalties: ' + error.message);
            }
        }

        function getVisibleTeamsForLeader(user) {
            if (!user || !user.team) return [];

            if (user.team === 'Honour') {
                return ['*']; // Can view all teams
            } else if (user.team === 'Ride') {
                return ['Ride', 'Ark', 'Belong']; // Special rule
            } else {
                return [user.team]; // Default case
            }
        }

        // Function to show/hide team leader section based on current user
        function toggleTeamLeaderSection() {
            const teamLeaderSection = document.getElementById('team-leader-section');
            if (!teamLeaderSection) return;

            // Only proceed if current user is a team leader
            if (!currentUser || !currentUser.isTeamLeader) {
                teamLeaderSection.style.display = 'none';
                return;
            }

            const visibleTeams = getVisibleTeamsForLeader(currentUser);

            if (visibleTeams.length > 0) {
                teamLeaderSection.style.display = 'block';
            } else {
                teamLeaderSection.style.display = 'none';
            }
        }

        // Function to load team leave records
        async function loadTeamLeaveRecords(teamList) {
            try {
                if (!teamList || teamList.length === 0) {
                    console.error('No team list provided');
                    return;
                }

                const tableBody = document.getElementById('team-leave-list');
                const agentFilter = document.getElementById('agent-filter');
                if (!tableBody || !agentFilter) return;

                tableBody.innerHTML = '';
                agentFilter.innerHTML = '<option value="">All Agents</option>';

                const employeesRef = database.ref('employees');
                const employeesSnapshot = await employeesRef.once('value');

                const teamMembers = {};
                const uniqueAgentNames = new Set();

                employeesSnapshot.forEach(childSnapshot => {
                    const employee = childSnapshot.val();
                    const belongsToTeam = teamList.includes('*') || teamList.includes(employee.team);
                    if (belongsToTeam) {
                        teamMembers[childSnapshot.key] = employee;

                        if (employee.name && typeof employee.name === 'string') {
                            uniqueAgentNames.add(employee.name.trim());
                        }
                    }
                });

                // Populate agent filter dropdown
                agentFilter.innerHTML = '<option value="">All Agents</option>';
                Array.from(uniqueAgentNames)
                    .sort((a, b) => a.localeCompare(b))
                    .forEach(name => {
                        const option = document.createElement('option');
                        option.value = name;
                        option.textContent = name;
                        agentFilter.appendChild(option);
                    });

                // Fetch and filter applications
                const applicationsRef = database.ref('applications');
                const applicationsSnapshot = await applicationsRef.once('value');

                const applications = [];
                applicationsSnapshot.forEach(childSnapshot => {
                    const application = childSnapshot.val();
                    const applicationId = childSnapshot.key;

                    if (application.employeeId in teamMembers) {
                        applications.push({
                            id: applicationId,
                            ...application
                        });
                    }
                });

                applyFilters(applications);

                // Add event listeners
                document.getElementById('date-filter').addEventListener('change', () => applyFilters(applications));
                document.getElementById('agent-filter').addEventListener('change', () => applyFilters(applications));

            } catch (error) {
                console.error('Error loading team leave records:', error);
                showSyncStatus('Error loading team leave records', 'error');
            }
        }

        // Function to apply date and agent filters
        function applyFilters(applications) {
            const tableBody = document.getElementById('team-leave-list');
            const dateFilter = document.getElementById('date-filter').value;
            const agentFilter = document.getElementById('agent-filter').value;

            // Clear the table
            tableBody.innerHTML = '';

            // Filter applications
            const filteredApplications = applications.filter(application => {
                let dateMatch = true;
                let agentMatch = true;

                // Date filter: check if selected date is within leave start and end dates
                if (dateFilter) {
                    const selectedDate = new Date(dateFilter);
                    const startDate = new Date(application.leaveStartDate);
                    const endDate = new Date(application.leaveEndDate);
                    // Ensure dates are at start of day for comparison
                    selectedDate.setHours(0, 0, 0, 0);
                    startDate.setHours(0, 0, 0, 0);
                    endDate.setHours(0, 0, 0, 0);
                    dateMatch = selectedDate >= startDate && selectedDate <= endDate;
                }

                // Agent filter
                if (agentFilter) {
                    agentMatch = application.employeeName === agentFilter;
                }

                return dateMatch && agentMatch;
            });

            // Display applications or "No records" message
            if (filteredApplications.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="6" class="text-center py-4 text-gray-500">
                        No leave records found
                    </td>
                `;
                tableBody.appendChild(row);
                return;
            }

            // Sort applications by date (newest first) and then by employee name
            filteredApplications.sort((a, b) => {
                const dateA = new Date(a.createdAt || a.applyDate);
                const dateB = new Date(b.createdAt || b.applyDate);
                if (dateB - dateA !== 0) {
                    return dateB - dateA;
                }
                return a.employeeName.localeCompare(b.employeeName);
            });

            // Create table rows
            filteredApplications.forEach(application => {
                const row = document.createElement('tr');
                
                // Format dates
                const applyDateTime = new Date(application.createdAt || application.applyDate);
                const startDate = new Date(application.leaveStartDate);
                const endDate = new Date(application.leaveEndDate);

                const formattedApplyDateTime = `${formatDate(applyDateTime)}`;
                const formattedStartDate = formatDate(startDate);
                const formattedEndDate = formatDate(endDate);

                row.innerHTML = `
                    <td>${application.employeeName}</td>
                    <td>${formattedApplyDateTime}</td>
                    <td>${formattedStartDate}</td>
                    <td>${formattedEndDate}</td>
                    <td>${application.leaveType}</td>
                    <td><span class="status-${application.status.toLowerCase()}">${application.status}</span></td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Function to reset filters
        function resetFilters() {
            document.getElementById('date-filter').value = '';
            document.getElementById('agent-filter').value = 'All Agents';
            const teamList = getVisibleTeamsForLeader(currentUser);
            loadTeamLeaveRecords(teamList);
        }
        
        // Function to show employee interface
        function showEmployeeInterface() {
            // Hide/show appropriate pages
            document.getElementById('home-page').style.display = 'none';
            document.getElementById('admin-page').style.display = 'none';
            document.getElementById('employee-page').style.display = 'block';

            // Only load data if we have a current user
            if (currentUser && currentUser.id) {
                console.log('Current user:', currentUser);
                
                // Load employee data
                loadEmployeeData(currentUser);
                
                // Remove any existing listeners
                database.ref('penalties').off('value');
                database.ref(`attendance/${currentUser.uid}`).off('value');
                
                // Load penalties and attendance
                updateAttendanceTable(); // Add this line to load attendance records

                // Initialize real-time attendance updates
                const attendanceRef = database.ref(`attendance/${currentUser.uid}`);
                attendanceRef.on('value', (snapshot) => {
                    updateAttendanceTable();
                });

            } else {
                console.error('No current user data available');
            }

            // Initialize the application status table if needed
            const applicationTable = document.getElementById('application-status-table');
            if (applicationTable && !applicationTable.getElementsByTagName('tbody').length) {
                const tbody = document.createElement('tbody');
                applicationTable.appendChild(tbody);
            }

            // Initialize the attendance table if needed
            const attendanceTable = document.getElementById('attendanceTableBody');
            if (!attendanceTable.children.length) {
                const noRecordsRow = document.createElement('tr');
                noRecordsRow.innerHTML = `
                    <td colspan="3" class="px-6 py-4 text-center text-gray-500">
                        No attendance records found
                    </td>
                `;
                attendanceTable.appendChild(noRecordsRow);
            }

            // Add event listener for logout
            const logoutBtn = document.getElementById('logout-btn-employee');
            if (logoutBtn) {
                // Remove existing listeners to prevent duplicates
                const newLogoutBtn = logoutBtn.cloneNode(true);
                logoutBtn.parentNode.replaceChild(newLogoutBtn, logoutBtn);
                newLogoutBtn.addEventListener('click', logout);
            }
            toggleTeamLeaderSection();
        }

        async function calculateUsedDays(employeeId) {
            try {
                const applicationsRef = database.ref('applications');
                const snapshot = await applicationsRef
                    .orderByChild('employeeId')
                    .equalTo(employeeId)
                    .once('value');

                const applications = snapshot.val() || {};

                let sickLeaveDays = 0;
                let forceMajeureDays = 0;
                let overseasDays = 0;

                // Calculate days for each approved application
                Object.values(applications).forEach(application => {
                    if (application.status === 'Approved') {
                        const startDate = new Date(application.leaveStartDate);
                        const endDate = new Date(application.leaveEndDate);
                        const days = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;

                        switch (application.leaveType) {
                            case 'Sick Leave':
                                sickLeaveDays += days;
                                break;
                            case '不可抗力因素':
                                forceMajeureDays += days;
                                break;
                            case '離港':
                                overseasDays += days;
                                break;
                        }
                    }
                });

                return { sickLeaveDays, forceMajeureDays, overseasDays };
            } catch (error) {
                console.error('Error calculating used days:', error);
                throw error;
            }
        }

        // Function to load employee data
        function loadEmployeeData(employee) {
            console.log("Loading employee data:", employee);
            console.log("Team:", employee.team);
            console.log("Is Team Leader:", employee.isTeamLeader);
            try {
                if (employee) {
                    document.getElementById('employee-name').textContent = employee.name || 'N/A';
                    document.getElementById('employee-code').textContent = employee.code || 'N/A';
                    document.getElementById('employee-role').textContent = employee.role || 'N/A';
                    document.getElementById('employee-mdrt').textContent = employee.mdrt || 'N/A';
                    document.getElementById('emp-team').textContent = employee.team || 'N/A';
                    document.getElementById('emp-team-leader').textContent = employee.isTeamLeader ? 'Yes' : 'No';
                    
                    // Format leave displays
                    const normalLeaves = employee.normalLeaves === 999 ? "∞" : (employee.normalLeaves || '0');
                    const goldenLeaves = employee.goldenLeaves === 999 ? "∞" : (employee.goldenLeaves || '0');
                    const remainingNormal = employee.remainingNormalLeaves === 999 ? "∞" : (employee.remainingNormalLeaves || '0');
                    const remainingGolden = employee.remainingGoldenLeaves === 999 ? "∞" : (employee.remainingGoldenLeaves || '0');
                    
                    document.getElementById('employee-leave-normal').textContent = normalLeaves;
                    document.getElementById('employee-leave-golden').textContent = goldenLeaves;
                    document.getElementById('remaining-leave-normal').textContent = remainingNormal;
                    document.getElementById('remaining-leave-golden').textContent = remainingGolden;

                    // Update used days display
                    updateDisplayedUsedDays(
                        employee.usedSickLeaveDays || 0,
                        employee.usedForceMajeureDays || 0,
                        employee.usedOverseasDays || 0
                    );

                    // Update Monday leaves display
                    const mondayLeavesElement = document.getElementById('used-monday-leaves');
                    if (mondayLeavesElement) {
                        mondayLeavesElement.textContent = employee.usedMondayLeaves || 0;
                    }
                } else {
                    console.error("No employee data provided");
                }
            } catch (error) {
                console.error("Error loading employee data:", error);
            }
            // Update the currentUser object with team and isTeamLeader info
            if (currentUser) {
                currentUser.team = employee.team || '';
                currentUser.isTeamLeader = employee.isTeamLeader || false;
                
                // Toggle team leader section
                toggleTeamLeaderSection();
            }            
        }

        // Update loadAllPenalties function to use the new updatePenaltyTable
        function loadAllPenalties() {
            const penaltyRef = database.ref('penalties');
            penaltyRef.on('value', (snapshot) => {
                const penalties = snapshot.val() || {};
                updatePenaltyTable(penalties);
            });
        }

        // Update the penalty table display function
        function updatePenaltyTable(penalties) {
            const tableBody = document.getElementById('penalty-list');
            if (!tableBody) return;

            tableBody.innerHTML = '';

            // Sort penalties by date (newest first)
            const sortedPenalties = Object.entries(penalties || {})
                .sort(([, a], [, b]) => new Date(b.date) - new Date(a.date));

            for (const [id, penalty] of sortedPenalties) {
                const row = document.createElement('tr');
                const isOverdue = new Date() > new Date(penalty.deadline) && penalty.status !== 'Submitted';
                const displayAmount = isOverdue && !penalty.doubleAmountCancelled ? penalty.amount * 2 : penalty.amount;

                // Add overdue class to row if penalty is overdue and double amount is not cancelled
                if (isOverdue && !penalty.doubleAmountCancelled) {
                    row.classList.add('overdue-row');
                }

                row.innerHTML = `
                    <td>${penalty.employeeName}</td>
                    <td>${penalty.date}</td>
                    <td>${penalty.reason}</td>
                    <td>${penalty.minutes}</td>
                    <td>$${displayAmount}${isOverdue && !penalty.doubleAmountCancelled ? ' (Doubled)' : ''}
                        ${penalty.doubleAmountCancelled ? ' (Double Cancelled)' : ''}</td>
                    <td>${penalty.deadline}${isOverdue && !penalty.doubleAmountCancelled ? ' (Overdue)' : ''}</td>
                    <td>
                        <div class="d-flex flex-column">
                            <span class="${penalty.status === 'Submitted' ? 'status-submitted' : 'status-not-submitted'}">
                                ${penalty.status}
                            </span>
                            <div style="display: flex; gap: 5px; margin-top: 5px;">
                                ${penalty.status === 'Submitted' ? `
                                    <button onclick="showPenaltyProof('${id}')" 
                                            class="show-proof-btn">
                                        Show Proof
                                    </button>
                                    <button onclick="rejectPenalty('${id}')" 
                                            class="reject-btn">
                                        Reject
                                    </button>
                                ` : ''}
                                ${isOverdue && !penalty.doubleAmountCancelled && penalty.status !== 'Submitted' ? `
                                    <button onclick="cancelDoublePenalty('${id}')" 
                                            class="cancel-double-btn">
                                        Cancel Double
                                    </button>
                                ` : ''}
                                <button onclick="removePenalty('${id}')" 
                                        class="remove-btn-small">
                                    Remove
                                </button>
                                <button onclick="adjustPenaltyAmount('${id}')" 
                                        class="adjust-amount-btn">
                                    Adjust Amount
                                </button>
                            </div>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            }
        }

        // cancelDoublePenalty function
        async function cancelDoublePenalty(penaltyId) {
            try {
                // Check if user is authenticated and is admin
                const user = auth.currentUser;
                if (!user) {
                    throw new Error('You must be logged in to cancel double penalties');
                }

                // Check admin status
                const adminSnapshot = await database.ref(`users/${user.uid}/isAdmin`).once('value');
                if (!adminSnapshot.val()) {
                    throw new Error('Only administrators can cancel double penalties');
                }

                // Confirm cancellation
                if (confirm('Are you sure you want to cancel the double amount for this penalty?')) {
                    // Get the current penalty data
                    const penaltySnapshot = await database.ref(`penalties/${penaltyId}`).once('value');
                    const penaltyData = penaltySnapshot.val();

                    if (!penaltyData) {
                        throw new Error('Penalty not found');
                    }

                    // Update the penalty to mark double amount as cancelled
                    const updates = {
                        doubleAmountCancelled: true,
                        doubleAmountCancelledAt: new Date().toISOString(),
                        doubleAmountCancelledBy: user.uid,
                        lastModified: new Date().toISOString()
                    };

                    await database.ref(`penalties/${penaltyId}`).update(updates);
                    
                    // Show success message
                    showSyncStatus('Double penalty cancelled successfully');
                }
            } catch (error) {
                console.error('Error cancelling double penalty:', error);
                alert('Error cancelling double penalty: ' + error.message);
            }
        }

        // Add this in your script section
        let html5QrcodeScanner = null;
        let scannerActive = false;

        async function startScanning() {
            if (scannerActive) {
                console.log("Scanner already active, ignoring request");
                return;
            }
            
            scannerActive = true;
            
            try {
                // Clean up any previous scanner
                if (html5QrcodeScanner) {
                    await html5QrcodeScanner.stop();
                    html5QrcodeScanner = null;
                }
                
                const readerDiv = document.getElementById('reader');
                readerDiv.style.display = 'block';
                
                const html5QrCode = new Html5Qrcode("reader");
                html5QrcodeScanner = html5QrCode;
                
                console.log("Starting QR code scanner...");
                
                html5QrCode.start(
                    { facingMode: "environment" },
                    { fps: 10, qrbox: { width: 550, height: 550 } },
                    async (decodedText) => {
                        console.log("QR code detected:", decodedText);
                        
                        // Immediately stop scanner and mark as inactive
                        scannerActive = false;
                        await html5QrCode.stop();
                        html5QrcodeScanner = null;
                        readerDiv.style.display = 'none';
                        
                        console.log("Scanner stopped after successful detection");
                        
                        // Process the attendance record
                        processAttendanceRecord()
                            .then(() => {
                                // Show success animation
                                showSuccessAnimation();
                            })
                            .catch(error => {
                                // Show error animation
                                showErrorAnimation(error.message);
                            });
                    },
                    (errorMessage) => {
                        // Ignore expected scanning errors
                        if (errorMessage && !errorMessage.includes("QR code found")) {
                            console.warn("QR Code scanning error:", errorMessage);
                        }
                    }
                ).catch(err => {
                    console.error("Error starting scanner:", err);
                    scannerActive = false;
                    showErrorAnimation("Could not start camera: " + err.message);
                });
                
            } catch (error) {
                console.error("Error in startScanning:", error);
                scannerActive = false;
                showErrorAnimation(error.message);
            }
        }

        // Helper function to stop the scanner
        function stopScanner() {
            if (html5QrcodeScanner) {
                html5QrcodeScanner.stop().then(() => {
                    console.log("Scanner stopped manually");
                    html5QrcodeScanner = null;
                    scannerActive = false;
                    
                    const readerDiv = document.getElementById('reader');
                    readerDiv.style.display = 'none';
                }).catch(err => {
                    console.error("Error stopping scanner:", err);
                });
            } else {
                console.log("No active scanner to stop");
            }
        }

        function onScanFailure(error) {
            // Only log actual errors, ignore empty scans
            if (error && !error.includes("No QR code found")) {
                console.warn(`QR code scan failed: ${error}`);
            }
        }

        // Process attendance record after QR scan
        async function processAttendanceRecord() {
            try {
                // Get current user's employee data
                const employeeSnapshot = await database.ref('employees')
                    .orderByChild('uid')
                    .equalTo(auth.currentUser.uid)
                    .once('value');

                let employeeData = null;
                employeeSnapshot.forEach((child) => {
                    employeeData = { id: child.key, ...child.val() };
                });

                if (!employeeData) {
                    throw new Error('Employee data not found');
                }

                // Get current time and date
                const now = new Date();
                const today = formatDate(now);

                // IMPORTANT: Check if the agent already has an attendance record for today
                const attendanceRef = database.ref('attendance');
                const existingRecordSnapshot = await attendanceRef
                    .orderByChild('date')
                    .equalTo(today)
                    .once('value');
                
                let existingRecord = false;
                existingRecordSnapshot.forEach(childSnapshot => {
                    const record = childSnapshot.val();
                    // Check if this record belongs to the current employee
                    if (record.employeeId === employeeData.id) {
                        existingRecord = true;
                    }
                });

                // If an attendance record already exists for today, don't create a new one
                if (existingRecord) {
                    throw new Error('You have already recorded your attendance for today');
                }

                // Get IP address
                const ipResponse = await fetch('https://api.ipify.org?format=json');
                const ipData = await ipResponse.json();

                // Calculate late status
                const lateInfo = calculateLateStatus(now.toISOString(), employeeData.role);

                // Create attendance record
                const attendanceData = {
                    employeeId: employeeData.id,
                    employeeName: employeeData.name,
                    role: employeeData.role,
                    date: today,
                    time: formatTime(now),
                    timestamp: now.toISOString(),
                    status: lateInfo.status,
                    lateMinutes: lateInfo.lateMinutes,
                    amount: lateInfo.amount,
                    ipAddress: ipData.ip
                };

                // Save attendance record to Firebase
                await attendanceRef.push(attendanceData);

                // If there's a penalty amount, add a penalty record
                if (lateInfo.amount > 0) {
                    // Check for existing penalty record for today
                    const penaltiesRef = database.ref('penalties');
                    const existingPenaltySnapshot = await penaltiesRef
                        .orderByChild('employeeId')
                        .equalTo(employeeData.id)
                        .once('value');

                    let existingPenaltyForToday = false;
                    existingPenaltySnapshot.forEach(childSnapshot => {
                        const penalty = childSnapshot.val();
                        if (penalty.date === today) {
                            existingPenaltyForToday = true;
                        }
                    });

                    if (!existingPenaltyForToday) {
                        // Calculate deadline (7 days from now)
                        const deadline = new Date(now);
                        deadline.setDate(deadline.getDate() + 7);

                        const penaltyData = {
                            employeeId: employeeData.id,
                            employeeName: employeeData.name,
                            employeeRole: employeeData.role,
                            date: today,
                            reason: 'Meeting',
                            minutes: lateInfo.lateMinutes,
                            amount: lateInfo.amount,
                            baseAmount: lateInfo.amount,
                            deadline: formatDate(deadline),
                            status: 'Not Submitted',
                            createdAt: now.toISOString(),
                            lastModified: now.toISOString()
                        };

                        // Save penalty record to Firebase
                        await database.ref('penalties').push(penaltyData);
                    }
                }

                // Update both attendance and penalty tables
                await updateAttendanceTable();
                await loadEmployeePenalties(employeeData.id);
                
                return true;
            } catch (error) {
                console.error("Error processing attendance record:", error);
                throw error;
            }
        }

        // Function to update year button states
        function updateYearButtonStates() {
            const year2028Btn = document.getElementById('filter-year-2028');
            const year2027Btn = document.getElementById('filter-year-2027');
            const year2026Btn = document.getElementById('filter-year-2026');
            const year2025Btn = document.getElementById('filter-year-2025');

            if (year2028Btn && year2027Btn && year2026Btn && year2025Btn) {
                year2028Btn.classList.toggle('active', selectedYear === '2028');
                year2027Btn.classList.toggle('active', selectedYear === '2027');
                year2026Btn.classList.toggle('active', selectedYear === '2026');
                year2025Btn.classList.toggle('active', selectedYear === '2025');
            }
        }

        // Show success animation
        function showSuccessAnimation() {
            const resultDiv = document.getElementById('scan-result');
            resultDiv.style.display = 'block';
            
            resultDiv.innerHTML = `
                <div class="success-animation">
                    <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                        <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none"/>
                        <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
                    </svg>
                    <p style="margin-top: 20px; color: #4CAF50; text-align: center; font-weight: bold;">
                        Attendance recorded successfully
                    </p>
                </div>
            `;

            setTimeout(() => {
                resultDiv.style.display = 'none';
            }, 3000);
        }

        // Show error animation
        function showErrorAnimation(errorMessage) {
            const resultDiv = document.getElementById('scan-result');
            resultDiv.style.display = 'block';
            
            resultDiv.innerHTML = `
                <div class="error-animation">
                    <svg class="error-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                        <circle class="error-circle" cx="26" cy="26" r="25" fill="none" stroke="#F44336" stroke-width="2"/>
                        <path class="error-x" fill="none" stroke="#F44336" stroke-width="2" d="M16,16 L36,36 M36,16 L16,36"/>
                    </svg>
                    <p style="margin-top: 20px; color: #F44336; text-align: center; font-weight: bold;">
                        Error: ${errorMessage}
                    </p>
                </div>
            `;

            setTimeout(() => {
                resultDiv.style.display = 'none';
            }, 3000);
        }

        // Add this CSS for the success animation
        const style = document.createElement('style');
        style.textContent = `
            .success-checkmark {
                width: 80px;
                height: 80px;
                margin: 0 auto;
            }
            .success-checkmark .check-icon {
                width: 80px;
                height: 80px;
                position: relative;
                border-radius: 50%;
                box-sizing: content-box;
                border: 4px solid #4CAF50;
            }
            .success-checkmark .check-icon::before {
                top: 3px;
                left: -2px;
                width: 30px;
                transform-origin: 100% 50%;
                border-radius: 100px 0 0 100px;
            }
            .success-checkmark .check-icon::after {
                top: 0;
                left: 30px;
                width: 60px;
                transform-origin: 0 50%;
                border-radius: 0 100px 100px 0;
                animation: rotate-circle 4.25s ease-in;
            }
            .success-checkmark .check-icon::before, .success-checkmark .check-icon::after {
                content: '';
                height: 100px;
                position: absolute;
                background: #FFFFFF;
                transform: rotate(-45deg);
            }
            .success-checkmark .check-icon .icon-line {
                height: 5px;
                background-color: #4CAF50;
                display: block;
                border-radius: 2px;
                position: absolute;
                z-index: 10;
            }
            .success-checkmark .check-icon .icon-line.line-tip {
                top: 46px;
                left: 14px;
                width: 25px;
                transform: rotate(45deg);
                animation: icon-line-tip 0.75s;
            }
            .success-checkmark .check-icon .icon-line.line-long {
                top: 38px;
                right: 8px;
                width: 47px;
                transform: rotate(-45deg);
                animation: icon-line-long 0.75s;
            }
            .success-checkmark .check-icon .icon-circle {
                top: -4px;
                left: -4px;
                z-index: 10;
                width: 80px;
                height: 80px;
                border-radius: 50%;
                position: absolute;
                box-sizing: content-box;
                border: 4px solid rgba(76, 175, 80, .5);
            }
            .success-checkmark .check-icon .icon-fix {
                top: 8px;
                width: 5px;
                left: 26px;
                z-index: 1;
                height: 85px;
                position: absolute;
                transform: rotate(-45deg);
                background-color: #FFFFFF;
            }
            @keyframes rotate-circle {
                0% { transform: rotate(-45deg); }
                5% { transform: rotate(-45deg); }
                12% { transform: rotate(-405deg); }
                100% { transform: rotate(-405deg); }
            }
            @keyframes icon-line-tip {
                0% { width: 0; left: 1px; top: 19px; }
                54% { width: 0; left: 1px; top: 19px; }
                70% { width: 50px; left: -8px; top: 37px; }
                84% { width: 17px; left: 21px; top: 48px; }
                100% { width: 25px; left: 14px; top: 45px; }
            }
            @keyframes icon-line-long {
                0% { width: 0; right: 46px; top: 54px; }
                65% { width: 0; right: 46px; top: 54px; }
                84% { width: 55px; right: 0px; top: 35px; }
                100% { width: 47px; right: 8px; top: 38px; }
            }
        `;
        document.head.appendChild(style);

        // Function to remove a penalty
        async function removePenalty(penaltyId) {
            try {
                // Check if user is authenticated and is admin
                const user = auth.currentUser;
                if (!user) {
                    throw new Error('You must be logged in to remove penalties');
                }

                // Check admin status
                const adminSnapshot = await database.ref(`users/${user.uid}/isAdmin`).once('value');
                if (!adminSnapshot.val()) {
                    throw new Error('Only administrators can remove penalties');
                }

                // Confirm deletion
                if (confirm('Are you sure you want to remove this penalty?')) {
                    // Remove from Firebase
                    await database.ref(`penalties/${penaltyId}`).remove();
                    
                    // Show success message
                    showSyncStatus('Penalty removed successfully');
                }
            } catch (error) {
                console.error('Error removing penalty:', error);
                alert('Error removing penalty: ' + error.message);
            }
        }

        async function rejectPenalty(penaltyId) {
            try {
                // Check if user is authenticated and is admin
                const user = auth.currentUser;
                if (!user) {
                    throw new Error('You must be logged in to reject penalties');
                }

                // Check admin status
                const adminSnapshot = await database.ref(`users/${user.uid}/isAdmin`).once('value');
                if (!adminSnapshot.val()) {
                    throw new Error('Only administrators can reject penalties');
                }

                // Confirm rejection
                if (confirm('Are you sure you want to reject this penalty submission?')) {
                    // Get the current penalty data
                    const penaltySnapshot = await database.ref(`penalties/${penaltyId}`).once('value');
                    const penaltyData = penaltySnapshot.val();

                    if (!penaltyData) {
                        throw new Error('Penalty not found');
                    }

                    // Update the penalty status and remove the proof
                    const updates = {
                        status: 'Not Submitted',
                        proof: null,
                        proofSubmitted: false,
                        rejectedAt: new Date().toISOString(),
                        rejectedBy: user.uid,
                        lastModified: new Date().toISOString()
                    };

                    await database.ref(`penalties/${penaltyId}`).update(updates);
                    
                    // Show success message
                    showSyncStatus('Penalty submission rejected successfully');
                }
            } catch (error) {
                console.error('Error rejecting penalty:', error);
                alert('Error rejecting penalty: ' + error.message);
            }
        }

        // Add event listener to MDRT select to show alert for COT or above selection
        document.getElementById('emp-mdrt').addEventListener('change', function() {
            if (this.value === 'cot or above') {
                alert('Note: COT or above members have unlimited (∞) leaves for both Normal and 黃金事假.');
            }
        });

        // Update the loadEmployees function to use updateAllEmployeeSelects
        async function loadEmployees() {
            const employeeRef = database.ref('employees');
            employeeRef.on('value', (snapshot) => {
                const employees = snapshot.val();
                const employeeList = document.getElementById('employee-list');
                if (!employeeList) return;
                
                employeeList.innerHTML = ''; // Clear existing list

                let employeeOrder;
                try {
                    employeeOrder = JSON.parse(localStorage.getItem('employeeOrder')) || [];
                } catch (e) {
                    employeeOrder = [];
                }

                // Convert to array and sort
                let employeesArray = Object.entries(employees || {});
                
                // Apply sorting
                if (employeeOrder.length > 0) {
                    employeesArray.sort((a, b) => {
                        const indexA = employeeOrder.indexOf(a[0]);
                        const indexB = employeeOrder.indexOf(b[0]);
                        if (indexA === -1) return 1;
                        if (indexB === -1) return -1;
                        return indexA - indexB;
                    });
                } else {
                    employeesArray.sort(([, a], [, b]) => a.name.localeCompare(b.name));
                }

                // Check if there are any employees
                if (employeesArray.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td colspan="7" class="text-center py-4 text-gray-500">
                            No agents found
                        </td>
                    `;
                    employeeList.appendChild(row);
                    return;
                }

                // Create and append rows for each employee
                employeesArray.forEach(([id, emp]) => {
                    const row = document.createElement('tr');
                    row.draggable = true;
                    row.dataset.id = id;
                    row.className = 'draggable';

                    // Format leave displays
                    const normalLeavesDisplay = emp.remainingNormalLeaves === 999 ? "∞" : emp.remainingNormalLeaves;
                    const goldenLeavesDisplay = emp.remainingGoldenLeaves === 999 ? "∞" : emp.remainingGoldenLeaves;

                    // Create editable fields
                    const codeInput = `
                        <input type="text" class="edit-input" 
                            value="${emp.code}" 
                            style="display: none;"
                            onchange="updateEmployeeField('${id}', 'code', this.value)">
                        <span class="display-text">${emp.code}</span>
                    `;

                    const roleSelect = `
                        <select class="edit-select" style="display: none;" 
                                onchange="updateEmployeeField('${id}', 'role', this.value)">
                            ${['Agent', 'AUM/UM', 'SUM', 'BM', 'DM', 'DD']
                                .map(role => `<option value="${role}" ${emp.role === role ? 'selected' : ''}>${role}</option>`)
                                .join('')}
                        </select>
                        <span class="display-text">${emp.role}</span>
                    `;

                    const mdrtSelect = `
                        <select class="edit-select" style="display: none;" 
                                onchange="updateEmployeeField('${id}', 'mdrt', this.value)">
                            ${['no', 'mdrt', 'cot or above']
                                .map(status => `<option value="${status.toLowerCase()}" ${emp.mdrt?.toLowerCase() === status ? 'selected' : ''}>${status}</option>`)
                                .join('')}
                        </select>
                        <span class="display-text">${emp.mdrt}</span>
                    `;

                    const teamOptions = ['', 'Honour', 'Bee', 'Novas', 'Define', 'Belong', 'Ride', 'Ark', 'Giant'];
                    const teamSelect = `
                        <select class="edit-select" style="display: none;" 
                                onchange="updateEmployeeField('${id}', 'team', this.value)">
                            ${teamOptions
                                .map(team => `<option value="${team}" ${emp.team === team ? 'selected' : ''}>${team || 'None'}</option>`)
                                .join('')}
                        </select>
                        <span class="display-text">${emp.team || 'N/A'}</span>
                    `;

                    const teamLeaderCheckbox = `
                        <input type="checkbox" class="edit-checkbox" style="display: none;" 
                            ${emp.isTeamLeader ? 'checked' : ''} 
                            onchange="updateEmployeeField('${id}', 'isTeamLeader', this.checked)">
                        <span class="display-text">${emp.isTeamLeader ? 'Yes' : 'No'}</span>
                    `;

                    row.innerHTML = `
                        <td class="drag-handle">
                            <div class="drag-handle-inner">${emp.name}</div>
                        </td>
                        <td class="editable-cell">${codeInput}</td>
                        <td class="editable-cell">${roleSelect}</td>
                        <td class="editable-cell">${mdrtSelect}</td>
                        <td>${normalLeavesDisplay}</td>
                        <td>${goldenLeavesDisplay}</td>
                        <td class="editable-cell">${teamSelect}</td>
                        <td class="editable-cell">${teamLeaderCheckbox}</td>
                        <td class="action-column">
                            <div class="button-stack">
                                <button class="adjust-btn action-btn" onclick="toggleAdjustMode(this)">Adjust</button>
                                <button class="remove-btn action-btn" onclick="removeAgent('${id}', this.parentElement.parentElement.parentElement)">Remove</button>
                                <button class="compensate-btn action-btn" onclick="addCompensationLeave('${id}')">補假</button>
                                <button class="reduce-btn action-btn" onclick="reduceLeave('${id}')">扣假</button>
                            </div>
                        </td>
                    `;

                    // Add drag and drop event listeners
                    row.addEventListener('dragstart', handleDragStart);
                    row.addEventListener('dragend', handleDragEnd);
                    row.addEventListener('dragover', handleDragOver);
                    row.addEventListener('drop', handleDrop);
                    row.addEventListener('dragenter', handleDragEnter);
                    row.addEventListener('dragleave', handleDragLeave);

                    employeeList.appendChild(row);
                });

                // Update all employee selects
                updateAllEmployeeSelects();
            });
        }

        // Add this new function to handle adjust mode
        function toggleAdjustMode(button) {
            const row = button.closest('tr');
            const editableFields = row.querySelectorAll('.editable-cell');
            const isAdjusting = button.classList.toggle('adjusting');
            
            editableFields.forEach(cell => {
                const input = cell.querySelector('.edit-input');
                const select = cell.querySelector('.edit-select');
                const checkbox = cell.querySelector('.edit-checkbox');
                const displayText = cell.querySelector('.display-text');
                
                if (isAdjusting) {
                    if (input) input.style.display = 'block';
                    if (select) select.style.display = 'block';
                    if (checkbox) {
                        checkbox.style.display = 'block';
                        // Add onchange event for checkbox
                        checkbox.onchange = function() {
                            const employeeId = row.dataset.id;
                            updateEmployeeField(employeeId, 'isTeamLeader', this.checked);
                        };
                    }
                    if (displayText) displayText.style.display = 'none';
                    button.textContent = 'Save';
                    button.classList.add('save-btn');
                } else {
                    if (input) {
                        input.style.display = 'none';
                        displayText.textContent = input.value;
                    }
                    if (select) {
                        select.style.display = 'none';
                        displayText.textContent = select.value;
                    }
                    if (checkbox) {
                        checkbox.style.display = 'none';
                        displayText.textContent = checkbox.checked ? 'Yes' : 'No';
                    }
                    button.textContent = 'Adjust';
                    button.classList.remove('save-btn');
                }
            });
        }

        // Add this new function to handle updates
        async function updateEmployeeField(employeeId, field, value) {
            try {
                // Get current employee data first
                const employeeSnapshot = await database.ref(`employees/${employeeId}`).once('value');
                const employeeData = employeeSnapshot.val();
                
                if (!employeeData) {
                    throw new Error('Employee not found');
                }

                const updates = {};
                updates[`employees/${employeeId}/${field}`] = value;

                // If updating code, handle authentication updates
                if (field === 'code') {
                    try {
                        // Store admin credentials
                        const adminUser = auth.currentUser;
                        const adminEmail = 'admin@snext.com';

                        // Format the employee email
                        const employeeEmail = `${employeeData.name.replace(/[^a-zA-Z0-9]/g, '')}@snext.com`.toLowerCase();
                        console.log('Updating code for:', employeeEmail);

                        // First update the database
                        await database.ref().update(updates);

                        // Now handle authentication update
                        try {
                            // Sign out any current user
                            await auth.signOut();

                            // Try to sign in with existing credentials
                            await auth.signInWithEmailAndPassword(employeeEmail, employeeData.code);
                            const user = auth.currentUser;
                            
                            // Update the password
                            await user.updatePassword(value);
                            console.log('Password updated successfully');

                        } catch (authError) {
                            console.log('Auth update error:', authError);
                            // If sign-in fails, try to create new account
                            if (authError.code === 'auth/user-not-found') {
                                await auth.createUserWithEmailAndPassword(employeeEmail, value);
                                console.log('New user account created');
                            }
                        }

                        // Sign back in as admin
                        await auth.signInWithEmailAndPassword(adminEmail, 'admin123');

                        showSyncStatus('Employee code updated successfully');
                        alert(`Employee code updated successfully.\nNew login credentials:\nUsername: ${employeeData.name}\nPassword: ${value}`);

                    } catch (error) {
                        console.error('Error in authentication update:', error);
                        // Database was already updated, so just show a message
                        alert(`Code updated in database. New password is: ${value}`);
                    }
                } else {
                    // For non-code field updates
                    await database.ref().update(updates);
                    showSyncStatus(`Employee ${field} updated successfully`);
                }

            } catch (error) {
                console.error('Error updating employee:', error);
                alert('Error updating employee information: ' + error.message);
            }
        }

        // Function to clear all leave application records
        async function clearAllLeaveRecords() {
            try {
                // Check if user is admin
                const user = auth.currentUser;
                if (!user) {
                    throw new Error('You must be logged in to clear records');
                }

                const adminSnapshot = await database.ref(`users/${user.uid}/isAdmin`).once('value');
                if (!adminSnapshot.val()) {
                    throw new Error('Only administrators can clear records');
                }

                if (!confirm('Are you sure you want to clear all leave application records? This action cannot be undone.')) {
                    return;
                }

                // Get all applications first
                const applicationsRef = database.ref('applications');
                const applicationsSnapshot = await applicationsRef.once('value');
                const applications = applicationsSnapshot.val() || {};

                // Get all employees
                const employeesRef = database.ref('employees');
                const employeesSnapshot = await employeesRef.once('value');
                const employees = employeesSnapshot.val() || {};

                // Create a map to store leave updates for each employee
                const employeeUpdates = {};

                // Calculate leaves to return for each employee
                Object.values(applications).forEach(application => {
                    if (application.status === 'Approved') {
                        const employeeId = application.employeeId;
                        const employee = employees[employeeId];
                        
                        if (employee) {
                            if (!employeeUpdates[employeeId]) {
                                employeeUpdates[employeeId] = {
                                    remainingNormalLeaves: employee.remainingNormalLeaves,
                                    remainingGoldenLeaves: employee.remainingGoldenLeaves,
                                    usedMondayLeaves: 0  // Reset Monday leave count
                                };
                            }

                            // Calculate days between start and end dates
                            const startDate = new Date(application.leaveStartDate);
                            const endDate = new Date(application.leaveEndDate);
                            const leaveDays = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;

                            // Handle Annual Leaves
                            if (application.leaveType === 'Annual Leave (Normal)' || 
                                application.leaveType === 'Annual Leave (黃金事假)') {
                                
                                // Return normal leaves if not infinite
                                if (application.leaveType === 'Annual Leave (Normal)' && 
                                    employee.remainingNormalLeaves !== 999) {
                                    employeeUpdates[employeeId].remainingNormalLeaves += leaveDays;
                                } else if (application.leaveType === 'Annual Leave (黃金事假)') {
                                    if (employee.remainingGoldenLeaves !== 999) {
                                        employeeUpdates[employeeId].remainingGoldenLeaves += leaveDays;
                                    }
                                    if (employee.remainingNormalLeaves !== 999) {
                                        employeeUpdates[employeeId].remainingNormalLeaves += leaveDays;
                                    }
                                }

                                // Ensure leaves don't exceed original allocation
                                if (employeeUpdates[employeeId].remainingNormalLeaves > employee.normalLeaves && 
                                    employee.normalLeaves !== 999) {
                                    employeeUpdates[employeeId].remainingNormalLeaves = employee.normalLeaves;
                                }
                                if (employeeUpdates[employeeId].remainingGoldenLeaves > employee.goldenLeaves && 
                                    employee.goldenLeaves !== 999) {
                                    employeeUpdates[employeeId].remainingGoldenLeaves = employee.goldenLeaves;
                                }
                            }
                        }
                    }
                });

                // Create batch updates
                const updates = {};

                // Add employee updates to batch
                Object.entries(employeeUpdates).forEach(([employeeId, leaveUpdates]) => {
                    updates[`employees/${employeeId}/remainingNormalLeaves`] = leaveUpdates.remainingNormalLeaves;
                    updates[`employees/${employeeId}/remainingGoldenLeaves`] = leaveUpdates.remainingGoldenLeaves;
                    updates[`employees/${employeeId}/usedMondayLeaves`] = 0; // Reset Monday leave count
                });

                // Add application deletion to batch
                updates['applications'] = null;

                // Execute all updates in one batch
                await database.ref().update(updates);

                // Clear the table in the UI
                const tableBody = document.getElementById('application-list-body');
                if (tableBody) {
                    tableBody.innerHTML = '';
                }

                // Refresh the employee data to update leave counts
                await loadEmployees();

                showSyncStatus('All leave application records have been cleared and leaves have been returned successfully');
            } catch (error) {
                console.error('Error clearing leave records:', error);
                alert('Error clearing leave records: ' + error.message);
            }
        }

        // Add event listener when the document is loaded
        document.addEventListener('DOMContentLoaded', function() {
            const exportApplicationsBtn = document.getElementById('export-applications-btn');
            const exportPenaltiesBtn = document.getElementById('export-penalties-btn');

            if (exportApplicationsBtn) {
                exportApplicationsBtn.addEventListener('click', exportApplicationsToExcel);
            }

            if (exportPenaltiesBtn) {
                exportPenaltiesBtn.addEventListener('click', exportPenaltiesToExcel);
            }
        });

        // Add event listener for clear records button
        document.addEventListener('DOMContentLoaded', function() {
            const clearRecordsBtn = document.getElementById('clearRecordsBtn');
            if (clearRecordsBtn) {
                clearRecordsBtn.addEventListener('click', function(e) {
                    e.preventDefault(); // Prevent form submission
                    e.stopPropagation(); // Stop event propagation
                    clearAllLeaveRecords();
                });
            }
        });

        function updateDisplayedRemainingLeaves(normalLeaves, goldenLeaves) {
            const remainingNormalElement = document.getElementById('remaining-leave-normal');
            const remainingGoldenElement = document.getElementById('remaining-leave-golden');

            if (remainingNormalElement) {
                remainingNormalElement.textContent = normalLeaves === 999 ? "∞" : normalLeaves;
            }
            if (remainingGoldenElement) {
                remainingGoldenElement.textContent = goldenLeaves === 999 ? "∞" : goldenLeaves;
            }
        }

        // Function to handle admin leave submission
        async function handleAdminLeaveSubmission() {
            try {
                const employeeId = document.getElementById('admin-leave-employee').value;
                const applyDate = document.getElementById('admin-apply-date').value;
                const leaveStartDate = document.getElementById('admin-leave-start-date').value;
                const leaveEndDate = document.getElementById('admin-leave-end-date').value;
                const leaveType = document.getElementById('admin-leave-type').value;
                
                if (!employeeId || !applyDate || !leaveStartDate || !leaveEndDate || !leaveType) {
                    throw new Error('Please fill in all required fields');
                }

                // Get employee data
                const employeeSnapshot = await database.ref(`employees/${employeeId}`).once('value');
                const employeeData = employeeSnapshot.val();

                if (!employeeData) {
                    throw new Error('Employee not found');
                }

                // Calculate leave days
                const start = new Date(leaveStartDate);
                const end = new Date(leaveEndDate);
                const leaveDays = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;

                let adjustedLeaveDays = leaveDays; // Days that count against quota

                // Special handling for 活動請假
                if (leaveType === '活動請假') {
                    let amount = 100; // Base amount

                    // Apply role multiplier
                    switch (employeeData.role) {
                        case 'AUM/UM':
                            amount *= 1.5;
                            break;
                        case 'SUM':
                            amount *= 2;
                            break;
                        case 'BM':
                            amount *= 3;
                            break;
                        case 'DM':
                            amount *= 4;
                            break;
                        case 'DD':
                            amount *= 6;
                            break;
                        default:
                            // No multiplier for regular agents
                            break;
                    }

                    // Round amount to nearest integer
                    amount = Math.round(amount);

                    // Create penalty record
                    const penaltyData = {
                        employeeId: employeeId,
                        employeeName: employeeData.name,
                        employeeRole: employeeData.role,
                        date: formatDate(new Date(applyDate)),
                        reason: '活動請假',
                        minutes: 0,
                        amount: amount,
                        baseAmount: amount,
                        deadline: formatDate(new Date(new Date(leaveStartDate).getTime() + 7 * 24 * 60 * 60 * 1000)),
                        status: 'Not Submitted',
                        createdAt: new Date().toISOString(),
                        lastModified: new Date().toISOString(),
                        createdBy: 'admin'
                    };

                    // Add penalty to Firebase
                    const penaltyRef = database.ref('penalties');
                    await penaltyRef.push(penaltyData);
                }

                let proofDataUrl = null;
                if (leaveType === 'Sick Leave' || 
                    leaveType === '不可抗力因素' || 
                    leaveType === '離港' ||
                    leaveType === 'Special Approve') {
                    const proofFile = document.getElementById('admin-proof-file').files[0];
                    if (proofFile) {
                        proofDataUrl = await convertFileToBase64(proofFile);
                    }
                }

                // Check for Mondays in leave period for Annual Leaves
                if (leaveType.includes('Annual Leave')) {
                    const mondayCount = countMondaysInDateRange(new Date(leaveStartDate), new Date(leaveEndDate));
                    
                    if (mondayCount > 0) {
                        const currentMondayLeaves = employeeData.usedMondayLeaves || 0;
                        const newTotalMondays = currentMondayLeaves + mondayCount;

                        if (currentMondayLeaves >= 3) {
                            alert(`This agent has already used their 3 Monday leaves. Please use "活動請假" instead.`);
                            return;
                        } else if (newTotalMondays > 3) {
                            alert(`This would exceed the agent's 3-Monday limit. Please use "活動請假" for the additional ${newTotalMondays - 3} Monday(s).`);
                            return;
                        }

                        // If within limits, update the Monday leave count
                        await database.ref(`employees/${employeeId}`).update({
                            usedMondayLeaves: newTotalMondays
                        });
                    }
                }

                // Create the application object
                const newApplication = {
                    employeeId: employeeId,
                    employeeName: employeeData.name,
                    applyDate: applyDate,
                    leaveStartDate: leaveStartDate,
                    leaveEndDate: leaveEndDate,
                    leaveType: leaveType,
                    leaveDays: leaveDays, // Keep total days for record
                    status: 'Approved',
                    proof: proofDataUrl,
                    createdAt: new Date().toISOString(),
                    createdBy: 'admin'
                };

                // Add to Firebase
                const applicationsRef = database.ref('applications');
                await applicationsRef.push(newApplication);

                // Update employee's remaining leaves using adjusted days
                if (leaveType.includes('Annual Leave')) {
                    const updates = {};
                    if (leaveType === 'Annual Leave (Normal)' && employeeData.remainingNormalLeaves !== 999) {
                        updates.remainingNormalLeaves = employeeData.remainingNormalLeaves - adjustedLeaveDays;
                    } else if (leaveType === 'Annual Leave (黃金事假)') {
                        if (employeeData.remainingGoldenLeaves !== 999) {
                            updates.remainingGoldenLeaves = employeeData.remainingGoldenLeaves - adjustedLeaveDays;
                        }
                        if (employeeData.remainingNormalLeaves !== 999) {
                            updates.remainingNormalLeaves = employeeData.remainingNormalLeaves - adjustedLeaveDays;
                        }
                    }

                    if (Object.keys(updates).length > 0) {
                        await database.ref(`employees/${employeeId}`).update(updates);
                    }
                }

                // Clear form
                document.getElementById('admin-leave-form').reset();
                
                // Show success message
                showSyncStatus('Leave record added successfully');

            } catch (error) {
                console.error('Error adding leave record:', error);
                alert('Error adding leave record: ' + error.message);
            }
        }

        async function clearAllAttendanceRecords() {
            try {
                // Check if user is admin
                const user = auth.currentUser;
                if (!user) {
                    throw new Error('You must be logged in to clear records');
                }

                const adminSnapshot = await database.ref(`users/${user.uid}/isAdmin`).once('value');
                if (!adminSnapshot.val()) {
                    throw new Error('Only administrators can clear attendance records');
                }

                // Show confirmation dialog with warning
                const confirmMessage = 'WARNING: This will permanently delete ALL attendance records for ALL agents. This action cannot be undone.\n\nAre you sure you want to continue?';
                
                if (!confirm(confirmMessage)) {
                    return;
                }

                // Clear all attendance records
                await database.ref('attendance').remove();

                // Clear the table in the UI
                const tableBody = document.getElementById('allAttendanceTableBody');
                if (tableBody) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                                No attendance records found
                            </td>
                        </tr>
                    `;
                }

                // Show success message
                showSyncStatus('All attendance records have been cleared successfully');

                // Reset filters
                const dateFilter = document.getElementById('dateFilter');
                const statusFilter = document.getElementById('statusFilter');
                const employeeFilter = document.getElementById('attendanceEmployeeFilter');

                if (dateFilter) dateFilter.value = '';
                if (statusFilter) statusFilter.value = '';
                if (employeeFilter) employeeFilter.value = '';

            } catch (error) {
                console.error('Error clearing attendance records:', error);
                alert('Error clearing attendance records: ' + error.message);
            }
        }

        // Add this to your existing DOMContentLoaded event listener
        document.addEventListener('DOMContentLoaded', function() {
            const clearAttendanceBtn = document.getElementById('clearAttendanceBtn');
            if (clearAttendanceBtn) {
                clearAttendanceBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    clearAllAttendanceRecords();
                });
            }
        });
        
        // Add this after your existing event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Leave type change handler for admin form
            const adminLeaveType = document.getElementById('admin-leave-type');
            if (adminLeaveType) {
                adminLeaveType.addEventListener('change', function() {
                    const proofContainer = document.getElementById('admin-proof-container');
                    const proofFileInput = document.getElementById('admin-proof-file');
                    const forceMajeureOptions = document.getElementById('admin-force-majeure-options');
                    const forceMajeureReasonSelect = document.getElementById('admin-force-majeure-reason');

                    // Just add Special Approve to the condition, keep everything else the same
                    if (this.value === 'Sick Leave' || 
                        this.value === '不可抗力因素' || 
                        this.value === '離港' ||
                        this.value === 'Special Approve') {  // Only change is adding this condition
                        
                        proofContainer.style.display = 'block';
                        proofFileInput.disabled = false;
                        proofFileInput.required = true;

                        if (this.value === '不可抗力因素') {
                            forceMajeureOptions.style.display = 'block';
                            forceMajeureReasonSelect.required = true;
                        } else {
                            forceMajeureOptions.style.display = 'none';
                            forceMajeureReasonSelect.required = false;
                        }
                    } else {
                        proofContainer.style.display = 'none';
                        proofFileInput.disabled = true;
                        proofFileInput.required = false;
                        forceMajeureOptions.style.display = 'none';
                        forceMajeureReasonSelect.required = false;
                    }
                });
            }

            // Admin leave form submission handler
            const adminLeaveForm = document.getElementById('admin-leave-form');
            if (adminLeaveForm) {
                adminLeaveForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    await handleAdminLeaveSubmission();
                });
            }
        });

        // Add this to your existing JavaScript
        document.addEventListener('DOMContentLoaded', function() {
            const toggleButton = document.getElementById('toggleAgentList');
            const container = document.getElementById('agentListContainer');
            const icon = toggleButton.querySelector('.collapse-icon');
            
            // Set initial state
            container.classList.add('expanded');
            
            // Load the saved state from localStorage if it exists
            const isCollapsed = localStorage.getItem('agentListCollapsed') === 'true';
            if (isCollapsed) {
                container.classList.remove('expanded');
                container.classList.add('collapsed');
                toggleButton.classList.add('collapsed');
                toggleButton.innerHTML = '<span class="collapse-icon">▼</span> Expand Agent List';
            }

            toggleButton.addEventListener('click', function() {
                const isCurrentlyCollapsed = container.classList.contains('collapsed');
                
                if (isCurrentlyCollapsed) {
                    // Expand
                    container.classList.remove('collapsed');
                    container.classList.add('expanded');
                    toggleButton.classList.remove('collapsed');
                    toggleButton.innerHTML = '<span class="collapse-icon">▼</span> Collapse Agent List';
                    localStorage.setItem('agentListCollapsed', 'false');
                } else {
                    // Collapse
                    container.classList.remove('expanded');
                    container.classList.add('collapsed');
                    toggleButton.classList.add('collapsed');
                    toggleButton.innerHTML = '<span class="collapse-icon">▼</span> Expand Agent List';
                    localStorage.setItem('agentListCollapsed', 'true');
                }
            });
        });

        //Handle the toggling 賀金table
        document.addEventListener('DOMContentLoaded', function() {
            const togglePenaltyButton = document.getElementById('togglePenaltyList');
            const penaltyContainer = document.getElementById('penaltyListContainer');
            
            if (togglePenaltyButton && penaltyContainer) {
                // Load saved state
                const isCollapsed = localStorage.getItem('penaltyListCollapsed') === 'true';
                
                // Set initial state
                if (isCollapsed) {
                    penaltyContainer.classList.add('collapsed');
                    penaltyContainer.classList.remove('expanded');
                    togglePenaltyButton.classList.add('collapsed');
                    togglePenaltyButton.innerHTML = '<span class="collapse-icon">▼</span> Expand 賀金 Info';
                } else {
                    penaltyContainer.classList.add('expanded');
                    penaltyContainer.classList.remove('collapsed');
                    togglePenaltyButton.classList.remove('collapsed');
                    togglePenaltyButton.innerHTML = '<span class="collapse-icon">▼</span> Collapse 賀金 Info';
                }

                // Add click handler
                togglePenaltyButton.addEventListener('click', function() {
                    const isCurrentlyCollapsed = penaltyContainer.classList.contains('collapsed');
                    
                    if (isCurrentlyCollapsed) {
                        // Expand
                        penaltyContainer.classList.remove('collapsed');
                        penaltyContainer.classList.add('expanded');
                        togglePenaltyButton.classList.remove('collapsed');
                        togglePenaltyButton.innerHTML = '<span class="collapse-icon">▼</span> Collapse 賀金 Info';
                        localStorage.setItem('penaltyListCollapsed', 'false');
                    } else {
                        // Collapse
                        penaltyContainer.classList.remove('expanded');
                        penaltyContainer.classList.add('collapsed');
                        togglePenaltyButton.classList.add('collapsed');
                        togglePenaltyButton.innerHTML = '<span class="collapse-icon">▼</span> Expand 賀金 Info';
                        localStorage.setItem('penaltyListCollapsed', 'true');
                    }
                });
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            const scrollButton = document.getElementById('scroll-to-bottom-btn');
            let scrollTimeout = null;
            let isHovering = false;

            if (scrollButton) {
                // Initial check (from previous fix)
                checkScrollPosition();

                // Updated click handler
                scrollButton.addEventListener('click', function() {
                    // Ensure all content is rendered by forcing a layout recalculation
                    document.body.scrollHeight; // Trigger reflow
                    const maxScrollHeight = Math.max(
                        document.body.scrollHeight,
                        document.documentElement.scrollHeight,
                        document.body.offsetHeight,
                        document.documentElement.offsetHeight,
                        document.documentElement.clientHeight
                    );

                    // Scroll to the absolute bottom
                    window.scrollTo({
                        top: maxScrollHeight,
                        behavior: 'smooth'
                    });

                    // Prevent any focusable element from adjusting scroll position
                    setTimeout(() => {
                        window.scrollTo({
                            top: maxScrollHeight,
                            behavior: 'instant' // Immediate correction if needed
                        });
                        document.activeElement.blur(); // Remove focus from any element
                    }, 500); // Delay matches smooth scroll duration
                });

                // Hover handlers (from previous fix)
                scrollButton.addEventListener('mouseenter', function() {
                    isHovering = true;
                    scrollButton.classList.add('visible');
                });

                scrollButton.addEventListener('mouseleave', function() {
                    isHovering = false;
                    checkScrollPosition();
                });

                // Scroll handler (from previous fix)
                window.addEventListener('scroll', function() {
                    if (!scrollTimeout) {
                        scrollTimeout = setTimeout(function() {
                            if (!isHovering) {
                                checkScrollPosition();
                            }
                            scrollTimeout = null;
                        }, 200);
                    }
                });

                // Resize handler (from previous fix)
                window.addEventListener('resize', function() {
                    if (!scrollTimeout) {
                        scrollTimeout = setTimeout(function() {
                            if (!isHovering) {
                                checkScrollPosition();
                            }
                            scrollTimeout = null;
                        }, 200);
                    }
                });
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            const toggleApplicationButton = document.getElementById('toggleApplicationList');
            const applicationContainer = document.getElementById('applicationListContainer');
            
            if (toggleApplicationButton && applicationContainer) {
                // Load saved state
                const isCollapsed = localStorage.getItem('applicationListCollapsed') === 'true';
                
                // Set initial state
                if (isCollapsed) {
                    applicationContainer.classList.add('collapsed');
                    applicationContainer.classList.remove('expanded');
                    toggleApplicationButton.classList.add('collapsed');
                    toggleApplicationButton.innerHTML = '<span class="collapse-icon">▼</span> Expand Application List';
                } else {
                    applicationContainer.classList.add('expanded');
                    applicationContainer.classList.remove('collapsed');
                    toggleApplicationButton.classList.remove('collapsed');
                    toggleApplicationButton.innerHTML = '<span class="collapse-icon">▼</span> Collapse Application List';
                }

                // Add click handler
                toggleApplicationButton.addEventListener('click', function() {
                    const isCurrentlyCollapsed = applicationContainer.classList.contains('collapsed');
                    
                    if (isCurrentlyCollapsed) {
                        // Expand
                        applicationContainer.classList.remove('collapsed');
                        applicationContainer.classList.add('expanded');
                        toggleApplicationButton.classList.remove('collapsed');
                        toggleApplicationButton.innerHTML = '<span class="collapse-icon">▼</span> Collapse Application List';
                        localStorage.setItem('applicationListCollapsed', 'false');
                    } else {
                        // Collapse
                        applicationContainer.classList.remove('expanded');
                        applicationContainer.classList.add('collapsed');
                        toggleApplicationButton.classList.add('collapsed');
                        toggleApplicationButton.innerHTML = '<span class="collapse-icon">▼</span> Expand Application List';
                        localStorage.setItem('applicationListCollapsed', 'true');
                    }
                });
            }
        });

        // Initialize calendar when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            const calendarEl = document.getElementById('leave-calendar');
            if (!calendarEl) {
                console.error('Calendar element not found');
                return;
            }

            if (typeof FullCalendar === 'undefined') {
                console.error('FullCalendar not loaded');
                return;
            }

            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,dayGridWeek,dayGridDay'
                },
                height: '600px',
                events: function(fetchInfo, successCallback, failureCallback) {
                    database.ref('applications').once('value')
                        .then(snapshot => {
                            const applications = snapshot.val() || {};
                            console.log('Applications fetched:', applications);

                            const events = Object.entries(applications)
                                .filter(([_, app]) => app.status === 'Approved')
                                .map(([id, app]) => {
                                    const endDate = new Date(app.leaveEndDate);
                                    endDate.setDate(endDate.getDate() + 1);

                                    const className = {
                                        'Annual Leave (Normal)': 'leave-annual-normal',
                                        'Annual Leave (黃金事假)': 'leave-annual-golden',
                                        'Sick Leave': 'leave-sick',
                                        '不可抗力因素': 'leave-force-majeure',
                                        '離港': 'leave-overseas',
                                        'Special Approve': 'leave-special-approve',
                                        '活動請假': 'leave-activity'
                                    }[app.leaveType] || 'leave-default';

                                    return {
                                        id: id,
                                        title: `${app.employeeName} - ${app.leaveType}`,
                                        start: app.leaveStartDate,
                                        end: endDate.toISOString().split('T')[0],
                                        className: className
                                    };
                                });

                            console.log('Events generated:', events);
                            successCallback(events);
                        })
                        .catch(error => {
                            console.error('Error fetching applications:', error);
                            failureCallback(error);
                        });
                },
                eventDisplay: 'block',
                firstDay: 1
            });

            // Render only if container is visible
            const container = document.getElementById('calendar-container');
            if (!container.classList.contains('collapsed')) {
                calendar.render();
            }

            window.leaveCalendar = calendar;
        });

        // Add this to your existing JavaScript
        document.addEventListener('DOMContentLoaded', function() {
            initializeFilters();
        });

        document.addEventListener('DOMContentLoaded', function() {
            updateAttendanceTable(); // Initial load

            const dateFilter = document.getElementById('dateFilter');
            const statusFilter = document.getElementById('statusFilter');
            const employeeFilter = document.getElementById('attendanceEmployeeFilter');
            const resetFilters = document.getElementById('resetFilters');

            // Only apply filters on explicit user input
            if (dateFilter) dateFilter.addEventListener('change', filterAttendanceTable);
            if (statusFilter) statusFilter.addEventListener('change', filterAttendanceTable);
            if (employeeFilter) employeeFilter.addEventListener('change', filterAttendanceTable);
            if (resetFilters) resetFilters.addEventListener('click', resetAttendanceFilters);
        });   

        document.addEventListener('DOMContentLoaded', function() {
            const toggleAttendanceButton = document.getElementById('toggleAttendanceRecords');
            const attendanceContainer = document.getElementById('attendanceRecordsContainer');
            
            if (toggleAttendanceButton && attendanceContainer) {
                // Load saved state
                const isCollapsed = localStorage.getItem('attendanceRecordsCollapsed') === 'true';
                
                // Set initial state
                if (isCollapsed) {
                    attendanceContainer.classList.add('collapsed');
                    attendanceContainer.classList.remove('expanded');
                    toggleAttendanceButton.classList.add('collapsed');
                    toggleAttendanceButton.innerHTML = '<span class="collapse-icon">▼</span> Expand Attendance Records';
                } else {
                    attendanceContainer.classList.add('expanded');
                    attendanceContainer.classList.remove('collapsed');
                    toggleAttendanceButton.classList.remove('collapsed');
                    toggleAttendanceButton.innerHTML = '<span class="collapse-icon">▼</span> Collapse Attendance Records';
                }

                // Add click handler
                toggleAttendanceButton.addEventListener('click', function() {
                    const isCurrentlyCollapsed = attendanceContainer.classList.contains('collapsed');
                    
                    if (isCurrentlyCollapsed) {
                        // Expand
                        attendanceContainer.classList.remove('collapsed');
                        attendanceContainer.classList.add('expanded');
                        toggleAttendanceButton.classList.remove('collapsed');
                        toggleAttendanceButton.innerHTML = '<span class="collapse-icon">▼</span> Collapse Attendance Records';
                        localStorage.setItem('attendanceRecordsCollapsed', 'false');
                    } else {
                        // Collapse
                        attendanceContainer.classList.remove('expanded');
                        attendanceContainer.classList.add('collapsed');
                        toggleAttendanceButton.classList.add('collapsed');
                        toggleAttendanceButton.innerHTML = '<span class="collapse-icon">▼</span> Expand Attendance Records';
                        localStorage.setItem('attendanceRecordsCollapsed', 'true');
                    }
                });
            }
        });

        async function addCompensationLeave(employeeId) {
            try {
                // Check if user is authenticated
                const auth = firebase.auth();
                const currentUser = auth.currentUser;
                
                if (!currentUser || !currentUser.email) {
                    throw new Error('請先登入');
                }

                // Get employee data
                const employeeSnapshot = await database.ref(`employees/${employeeId}`).once('value');
                const employeeData = employeeSnapshot.val();

                if (!employeeData) {
                    throw new Error('Employee not found');
                }

                // Create custom dialog with adjusted size and styling
                const leaveType = await Swal.fire({
                    title: '選擇補假類型',
                    html: `
                        <div style="margin-bottom: 20px;">
                            <p style="font-size: 14px;">Agent: ${employeeData.name}</p>
                        </div>
                        <select id="leave-type-select" class="swal2-select" style="
                            width: 80%; 
                            padding: 8px; 
                            margin-bottom: 15px;
                            font-size: 14px;
                            border: 1px solid #ddd;
                            border-radius: 4px;
                        ">
                            <option value="normal">Annual Leave (Normal)</option>
                            <option value="golden">Annual Leave (黃金事假)</option>
                        </select>
                        <input type="number" id="leave-days" class="swal2-input" placeholder="輸入補假天數" min="1" step="1" style="
                            width: 80%;
                            padding: 8px;
                            font-size: 14px;
                            border: 1px solid #ddd;
                            border-radius: 4px;
                        ">
                    `,
                    showCancelButton: true,
                    confirmButtonText: '確認',
                    cancelButtonText: '取消',
                    width: '400px',
                    customClass: {
                        container: 'custom-swal-container',
                        popup: 'custom-swal-popup',
                        header: 'custom-swal-header',
                        title: 'custom-swal-title',
                        closeButton: 'custom-swal-close-button',
                        content: 'custom-swal-content',
                        input: 'custom-swal-input',
                        actions: 'custom-swal-actions',
                        confirmButton: 'custom-swal-confirm-button',
                        cancelButton: 'custom-swal-cancel-button'
                    },
                    preConfirm: () => {
                        const type = document.getElementById('leave-type-select').value;
                        const days = parseInt(document.getElementById('leave-days').value);
                        if (!days || days < 1) {
                            Swal.showValidationMessage('請輸入有效的天數');
                            return false;
                        }
                        return { type, days };
                    }
                });

                if (leaveType.isConfirmed) {
                    const { type, days } = leaveType.value;
                    const updates = {};

                    // Calculate new remaining leaves
                    if (type === 'normal') {
                        if (employeeData.remainingNormalLeaves !== 999) {
                            const newNormalLeaves = (employeeData.remainingNormalLeaves || 0) + days;
                            updates[`employees/${employeeId}/remainingNormalLeaves`] = newNormalLeaves;
                        }
                    } else if (type === 'golden') {
                        if (employeeData.remainingGoldenLeaves !== 999) {
                            const newGoldenLeaves = (employeeData.remainingGoldenLeaves || 0) + days;
                            updates[`employees/${employeeId}/remainingGoldenLeaves`] = newGoldenLeaves;
                        }
                        if (employeeData.remainingNormalLeaves !== 999) {
                            const newNormalLeaves = (employeeData.remainingNormalLeaves || 0) + days;
                            updates[`employees/${employeeId}/remainingNormalLeaves`] = newNormalLeaves;
                        }
                    }

                    // Add compensation record
                    const compensationRef = database.ref(`compensationRecords/${employeeId}`).push();
                    const timestamp = new Date().toISOString();
                    
                    const compensationRecord = {
                        type: type,
                        days: days,
                        timestamp: timestamp,
                        addedBy: currentUser.email
                    };

                    updates[`compensationRecords/${employeeId}/${compensationRef.key}`] = compensationRecord;

                    // Update the database
                    if (Object.keys(updates).length > 0) {
                        await database.ref().update(updates);

                        // Show success message
                        await Swal.fire({
                            icon: 'success',
                            title: '補假完成',
                            text: `已成功新增 ${days} 天${type === 'normal' ? 'Annual Leave (Normal)' : 'Annual Leave (黃金事假)'}`,
                            width: '400px',
                            customClass: {
                                popup: 'custom-swal-popup',
                                title: 'custom-swal-title',
                                confirmButton: 'custom-swal-confirm-button'
                            }
                        });

                        // Refresh the employee table
                        loadEmployees();
                    }
                }
            } catch (error) {
                console.error('Error adding compensation leave:', error);
                await Swal.fire({
                    icon: 'error',
                    title: '錯誤',
                    text: error.message,
                    width: '400px',
                    customClass: {
                        popup: 'custom-swal-popup',
                        title: 'custom-swal-title',
                        confirmButton: 'custom-swal-confirm-button'
                    }
                });
            }
        }

        async function reduceLeave(employeeId) {
            try {
                // Check if user is authenticated
                const auth = firebase.auth();
                const currentUser = auth.currentUser;
                
                if (!currentUser || !currentUser.email) {
                    throw new Error('請先登入');
                }

                // Get employee data
                const employeeSnapshot = await database.ref(`employees/${employeeId}`).once('value');
                const employeeData = employeeSnapshot.val();

                if (!employeeData) {
                    throw new Error('Employee not found');
                }

                // Create custom dialog with adjusted size and styling
                const leaveType = await Swal.fire({
                    title: '扣減假期',
                    html: `
                        <div style="margin-bottom: 20px;">
                            <p style="font-size: 14px;">Agent: ${employeeData.name}</p>
                        </div>
                        <select id="leave-type-select" class="swal2-select" style="
                            width: 80%; 
                            padding: 8px; 
                            margin-bottom: 15px;
                            font-size: 14px;
                            border: 1px solid #ddd;
                            border-radius: 4px;
                        ">
                            <option value="normal">Annual Leave (Normal)</option>
                            <option value="golden">Annual Leave (黃金事假)</option>
                        </select>
                        <input type="number" id="leave-days" class="swal2-input" placeholder="輸入扣減天數" min="0.5" step="0.5" style="
                            width: 80%;
                            padding: 8px;
                            font-size: 14px;
                            border: 1px solid #ddd;
                            border-radius: 4px;
                        ">
                        <textarea id="leave-reason" class="swal2-textarea" placeholder="扣減原因" style="
                            width: 80%;
                            margin-top: 15px;
                            padding: 8px;
                            font-size: 14px;
                            border: 1px solid #ddd;
                            border-radius: 4px;
                            resize: vertical;
                        "></textarea>
                    `,
                    showCancelButton: true,
                    confirmButtonText: '確認',
                    cancelButtonText: '取消',
                    width: '400px',
                    customClass: {
                        container: 'custom-swal-container',
                        popup: 'custom-swal-popup',
                        header: 'custom-swal-header',
                        title: 'custom-swal-title',
                        closeButton: 'custom-swal-close-button',
                        content: 'custom-swal-content',
                        input: 'custom-swal-input',
                        actions: 'custom-swal-actions',
                        confirmButton: 'custom-swal-confirm-button',
                        cancelButton: 'custom-swal-cancel-button'
                    },
                    preConfirm: () => {
                        const type = document.getElementById('leave-type-select').value;
                        const days = parseFloat(document.getElementById('leave-days').value);
                        const reason = document.getElementById('leave-reason').value.trim();

                        if (!days || days < 0.5) {
                            Swal.showValidationMessage('請輸入有效的天數 (最少0.5天)');
                            return false;
                        }
                        if (!reason) {
                            Swal.showValidationMessage('請輸入扣減原因');
                            return false;
                        }
                        return { type, days, reason };
                    }
                });

                if (leaveType.isConfirmed) {
                    const { type, days, reason } = leaveType.value;
                    const updates = {};

                    // Calculate new remaining leaves
                    if (type === 'normal') {
                        if (employeeData.remainingNormalLeaves !== 999) {
                            const newNormalLeaves = Math.max(0, (employeeData.remainingNormalLeaves || 0) - days);
                            updates[`employees/${employeeId}/remainingNormalLeaves`] = newNormalLeaves;
                        }
                    } else if (type === 'golden') {
                        if (employeeData.remainingGoldenLeaves !== 999) {
                            const newGoldenLeaves = Math.max(0, (employeeData.remainingGoldenLeaves || 0) - days);
                            updates[`employees/${employeeId}/remainingGoldenLeaves`] = newGoldenLeaves;
                        }
                        if (employeeData.remainingNormalLeaves !== 999) {
                            const newNormalLeaves = Math.max(0, (employeeData.remainingNormalLeaves || 0) - days);
                            updates[`employees/${employeeId}/remainingNormalLeaves`] = newNormalLeaves;
                        }
                    }

                    // Add reduction record
                    const reductionRef = database.ref(`leaveReductionRecords/${employeeId}`).push();
                    const timestamp = new Date().toISOString();
                    
                    const reductionRecord = {
                        type: type,
                        days: days,
                        reason: reason,
                        timestamp: timestamp,
                        reducedBy: currentUser.email
                    };

                    updates[`leaveReductionRecords/${employeeId}/${reductionRef.key}`] = reductionRecord;

                    // Update the database
                    if (Object.keys(updates).length > 0) {
                        await database.ref().update(updates);

                        // Show success message
                        await Swal.fire({
                            icon: 'success',
                            title: '扣減完成',
                            text: `已成功扣減 ${days} 天${type === 'normal' ? 'Annual Leave (Normal)' : 'Annual Leave (黃金事假)'}`,
                            width: '400px',
                            customClass: {
                                popup: 'custom-swal-popup',
                                title: 'custom-swal-title',
                                confirmButton: 'custom-swal-confirm-button'
                            }
                        });

                        // Refresh the employee table
                        loadEmployees();
                    }
                }
            } catch (error) {
                console.error('Error reducing leave:', error);
                await Swal.fire({
                    icon: 'error',
                    title: '錯誤',
                    text: error.message,
                    width: '400px',
                    customClass: {
                        popup: 'custom-swal-popup',
                        title: 'custom-swal-title',
                        confirmButton: 'custom-swal-confirm-button'
                    }
                });
            }
        }

        // Update your filterAttendanceTable function to be more efficient
        async function filterAttendanceTable() {
            // Prevent duplicate filtering - just call updateAttendanceTable
            // which now has filtering logic built in
            await updateAttendanceTable();
        }

        document.addEventListener('DOMContentLoaded', function() {
            updateAttendanceTable(); // Initial load

            const dateFilter = document.getElementById('dateFilter');
            const statusFilter = document.getElementById('statusFilter');
            const employeeFilter = document.getElementById('attendanceEmployeeFilter');
            const resetFilters = document.getElementById('resetFilters');

            // Explicit filter triggers only
            dateFilter?.addEventListener('change', filterAttendanceTable);
            statusFilter?.addEventListener('change', filterAttendanceTable);
            employeeFilter?.addEventListener('change', filterAttendanceTable);
            resetFilters?.addEventListener('click', () => {
                dateFilter.value = '';
                statusFilter.value = '';
                employeeFilter.value = '';
                updateAttendanceTable();
            });
        });

        document.addEventListener('DOMContentLoaded', function () {
            const filter2025Btn = document.getElementById('filter-year-2025');
            const filter2026Btn = document.getElementById('filter-year-2026');
            const filter2027Btn = document.getElementById('filter-year-2027');
            const filter2028Btn = document.getElementById('filter-year-2028');
            let selectedYear = null; // Store the currently selected year

            // Function to update button styles
            function updateYearButtonStyles(activeBtn) {
                [filter2025Btn, filter2026Btn, filter2027Btn, filter2028Btn].forEach(btn => {
                    btn.classList.remove('active');
                    btn.style.backgroundColor = '#6b7280'; // Default color
                });
                if (activeBtn) {
                    activeBtn.classList.add('active');
                    activeBtn.style.backgroundColor = 'var(--accent-color)'; // Active color
                }
            }

            // Year filter button handlers
            if (filter2025Btn) {
                filter2025Btn.addEventListener('click', function () {
                    selectedYear = selectedYear === '2025' ? null : '2025';
                    updateYearButtonStyles(selectedYear ? filter2025Btn : null);
                    const employeeFilter = document.getElementById('application-employee-filter');
                    loadAllApplications(employeeFilter ? employeeFilter.value : null);
                });
            }

            if (filter2026Btn) {
                filter2026Btn.addEventListener('click', function () {
                    selectedYear = selectedYear === '2026' ? null : '2026';
                    updateYearButtonStyles(selectedYear ? filter2026Btn : null);
                    const employeeFilter = document.getElementById('application-employee-filter');
                    loadAllApplications(employeeFilter ? employeeFilter.value : null);
                });
            }

            if (filter2027Btn) {
                filter2027Btn.addEventListener('click', function () {
                    selectedYear = selectedYear === '2027' ? null : '2027';
                    updateYearButtonStyles(selectedYear ? filter2027Btn : null);
                    const employeeFilter = document.getElementById('application-employee-filter');
                    loadAllApplications(employeeFilter ? employeeFilter.value : null);
                });
            }

            if (filter2028Btn) {
                filter2028Btn.addEventListener('click', function () {
                    selectedYear = selectedYear === '2028' ? null : '2028';
                    updateYearButtonStyles(selectedYear ? filter2028Btn : null);
                    const employeeFilter = document.getElementById('application-employee-filter');
                    loadAllApplications(employeeFilter ? employeeFilter.value : null);
                });
            }

            // Expose selectedYear to other functions
            window.getSelectedYear = function () {
                return selectedYear;
            };

            // --- Date Filter Functionality ---
            const dateFilter = document.getElementById('applicationdateFilter');
            if (dateFilter) {
                dateFilter.addEventListener('change', function () {
                    const selectedDate = this.value;
                    if (!selectedDate) return;

                    const tableBody = document.getElementById('application-list-body');
                    const rows = tableBody.querySelectorAll('tr');

                    rows.forEach(row => {
                        const startDate = row.cells[2]?.textContent?.trim();
                        const endDate = row.cells[3]?.textContent?.trim();

                        const showRow = isDateInRange(selectedDate, startDate, endDate);
                        row.style.display = showRow ? '' : 'none';
                    });
                });
            }
        });

        // --- Date range checker ---
        function isDateInRange(target, start, end) {
            const targetDate = new Date(target);
            const startDate = new Date(start);
            const endDate = new Date(end);

            return (
                !isNaN(targetDate) &&
                !isNaN(startDate) &&
                !isNaN(endDate) &&
                targetDate >= startDate &&
                targetDate <= endDate
            );
        }

        function resetAttendanceFilters() {
            document.getElementById('dateFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('attendanceEmployeeFilter').value = '';
            updateAttendanceTable(); // Show all records
        }

        // Modify the initializeFilters function
        function initializeFilters() {
            const applicationFilter = document.getElementById('application-employee-filter');
            const resetFilters = document.getElementById('resetFilters');

            // Handle agent filter change
            applicationFilter.addEventListener('change', function() {
                const selectedAgentId = this.value;
                loadAllApplications(selectedAgentId);
            });

            // Reset filters - update this part
            resetFilters.addEventListener('click', function() {
                // Set filter back to "All Agents" (empty value)
                applicationFilter.value = '';
                // Also reset year filter
                const filter2025Btn = document.getElementById('filter-year-2025');
                const filter2026Btn = document.getElementById('filter-year-2026');
                const filter2027Btn = document.getElementById('filter-year-2027');
                const filter2028Btn = document.getElementById('filter-year-2028');
                [filter2025Btn, filter2026Btn, filter2027Btn, filter2028Btn].forEach(btn => {
                    btn.classList.remove('active');
                    btn.style.backgroundColor = '#6b7280';
                });
                window.getSelectedYear = () => null; // Clear selected year

                // Load all applications
                loadAllApplications();
                
                // Optional: trigger change event if needed
                const changeEvent = new Event('change');
                applicationFilter.dispatchEvent(changeEvent);
            });

            // Initialize employee select
            updateAllEmployeeSelects();
        }

        // Add this to your initialization code
        function initializeAttendanceSystem() {
            // Add real-time listener for attendance updates
            const attendanceRef = database.ref('attendance');
            attendanceRef.on('value', (snapshot) => {
                updateAttendanceTable();
            });
        }

        // Make sure to initialize the real-time listener
        let attendanceListener = null;
        function initializeAttendanceTable() {
            const attendanceRef = database.ref('attendance');
            
            // Detach existing listener if it exists
            if (attendanceListener) {
                attendanceRef.off('value', attendanceListener);
                attendanceListener = null;
            }
            
            // Create a new listener function 
            attendanceListener = function(snapshot) {
                // Using a timeout to debounce multiple rapid updates
                if (window.attendanceUpdateTimeout) {
                    clearTimeout(window.attendanceUpdateTimeout);
                }
                
                window.attendanceUpdateTimeout = setTimeout(() => {
                    console.log('Attendance data changed, updating UI...');
                    updateAttendanceTable();
                }, 500); // 500ms debounce
            };
            
            // Attach the listener
            attendanceRef.on('value', attendanceListener);
            console.log('Attendance listener initialized');
        }

        // Helper function to update the application table
        function updateApplicationTable(applications) {
            const tableBody = document.getElementById('application-list-body');
            if (!tableBody) return;

            tableBody.innerHTML = '';

            if (Object.keys(applications).length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="8" class="px-6 py-4 text-center text-gray-500">
                        No applications found
                    </td>
                `;
                tableBody.appendChild(row);
                return;
            }

            // Sort applications by date (newest first)
            const sortedApplications = Object.entries(applications)
                .sort(([, a], [, b]) => new Date(b.applyDate) - new Date(a.applyDate));

            sortedApplications.forEach(([id, application]) => {
                const row = document.createElement('tr');
                
                // Format dates
                const applyDateTime = new Date(application.createdAt || application.applyDate);
                const startDate = new Date(application.leaveStartDate);
                const endDate = new Date(application.leaveEndDate);

                const formattedApplyDateTime = `${formatDate(applyDateTime)} ${formatTime(applyDateTime)}`;
                const formattedStartDate = formatDate(startDate);
                const formattedEndDate = formatDate(endDate);

                row.innerHTML = `
                    <td>${application.employeeName}</td>
                    <td>${formattedApplyDateTime}</td>
                    <td>${formattedStartDate}</td>
                    <td>${formattedEndDate}</td>
                    <td>${application.leaveType}</td>
                    <td>
                        <span class="status-${application.status.toLowerCase()}">${application.status}</span>
                        ${application.status === 'Approved' ? `
                            <button type="button" class="reject-btn" onclick="rejectApplication('${id}', '${application.employeeId}', '${application.leaveType}')">
                                Reject
                            </button>
                        ` : ''}
                    </td>
                    <td>
                        ${(application.leaveType === 'Sick Leave' || 
                        application.leaveType === '不可抗力因素' || 
                        application.leaveType === '離港') && application.proof ? 
                            `<button type="button" class="show-proof-btn" onclick="showProof('${id}')">View Proof</button>` : 
                            'N/A'}
                    </td>
                    <td>
                        <button type="button" 
                                class="remove-btn-small" 
                                onclick="handleRemoveSingleApplication(event, '${id}', '${application.employeeId}', '${application.leaveType}', ${application.leaveDays}, '${application.status}')">
                            Remove
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        function checkScrollPosition() {
            const scrollButton = document.getElementById('scroll-to-bottom-btn');
            if (!scrollButton) return;

            const scrollPosition = window.scrollY + window.innerHeight;
            const documentHeight = document.documentElement.scrollHeight;
            const buffer = 100;

            if (documentHeight > window.innerHeight && scrollPosition < documentHeight - buffer) {
                scrollButton.classList.add('visible');
            } else {
                scrollButton.classList.remove('visible');
            }
        }

        // Add validation to form submission
        async function validateLeaveApplication(formData) {
            const leaveType = formData.get('leaveType');
            if (leaveType === 'Special Approve') {
                const applyDate = formData.get('applyDate');
                const startDate = formData.get('startDate');
                const endDate = formData.get('endDate');
                
                // Check if all dates are the same and equal to today
                const today = new Date().toISOString().split('T')[0];
                if (applyDate !== today || startDate !== today || endDate !== today) {
                    alert('For Special Approve, all dates must be today\'s date.');
                    return false;
                }
            }
            return true;
        }

        // Function to remove an employee and their associated penalties
        async function removeAgent(employeeId, rowElement) {
            try {
                if (!confirm('Are you sure you want to remove this agent?')) {
                    return;
                }

                // Remove agent's applications first
                const applicationsRef = database.ref('applications');
                const applicationsSnapshot = await applicationsRef
                    .orderByChild('employeeId')
                    .equalTo(employeeId)
                    .once('value');
                
                const applicationUpdates = {};
                applicationsSnapshot.forEach(childSnapshot => {
                    applicationUpdates[`applications/${childSnapshot.key}`] = null;
                });

                // Also remove any penalties associated with this employee
                const penaltiesRef = database.ref('penalties');
                const penaltiesSnapshot = await penaltiesRef
                    .orderByChild('employeeId')
                    .equalTo(employeeId)
                    .once('value');
                
                const penaltyUpdates = {};
                penaltiesSnapshot.forEach(childSnapshot => {
                    penaltyUpdates[`penalties/${childSnapshot.key}`] = null;
                });

                // Remove agent from employees
                const employeeRef = database.ref(`employees/${employeeId}`);
                
                // Combine all deletions in a single update
                const updates = {
                    [`employees/${employeeId}`]: null,
                    ...applicationUpdates,
                    ...penaltyUpdates
                };

                // Perform the combined update
                await database.ref().update(updates);

                // Remove the row from the table if a row element was provided
                if (rowElement && rowElement.parentNode) {
                    rowElement.parentNode.removeChild(rowElement);
                }

                showSyncStatus('Agent removed successfully');
            } catch (error) {
                console.error('Error removing agent:', error);
                showSyncStatus('Error removing agent', 'error');
            }
        }

        async function adjustPenaltyAmount(penaltyId) {
            try {
                // Check if user is authenticated and is admin
                const user = auth.currentUser;
                if (!user) {
                    throw new Error('You must be logged in to adjust penalty amounts');
                }

                const adminSnapshot = await database.ref(`users/${user.uid}/isAdmin`).once('value');
                if (!adminSnapshot.val()) {
                    throw new Error('Only administrators can adjust penalty amounts');
                }

                // Prompt for the new amount
                const newAmount = prompt('Enter the new amount for this penalty:');
                if (newAmount === null) {
                    return; // User cancelled
                }

                const parsedAmount = parseFloat(newAmount);
                if (isNaN(parsedAmount) || parsedAmount < 0) {
                    throw new Error('Invalid amount. Please enter a non-negative number.');
                }

                // Update the penalty amount in Firebase
                await database.ref(`penalties/${penaltyId}`).update({
                    amount: parsedAmount,
                    lastModified: new Date().toISOString()
                });

                // Refresh the penalty tables on both admin and agent pages
                loadAllPenalties();
                if (currentUser && currentUser.id) {
                    loadEmployeePenalties(currentUser.id);
                }

                showSyncStatus('Penalty amount adjusted successfully');
            } catch (error) {
                console.error('Error adjusting penalty amount:', error);
                alert('Error adjusting penalty amount: ' + error.message);
            }
        }

        // Update the existing updateCalendarEvents function
        function updateCalendarEvents(applications) {
            if (!window.leaveCalendar) {
                console.error('Calendar not initialized');
                return;
            }

            window.leaveCalendar.removeAllEvents();
            if (!applications) return;

            const events = Object.entries(applications)
                .filter(([_, app]) => app.status === 'Approved')
                .map(([id, application]) => {
                    const endDate = new Date(application.leaveEndDate);
                    endDate.setDate(endDate.getDate() + 1);
                    return {
                        id: id,
                        title: `${application.employeeName} - ${application.leaveType}`,
                        start: application.leaveStartDate,
                        end: endDate.toISOString().split('T')[0],
                        className: `leave-${application.leaveType.toLowerCase().replace(/[^a-z0-9]/g, '-')}`
                    };
                });

            window.leaveCalendar.addEventSource(events);
            window.leaveCalendar.render();
            console.log('Calendar events updated:', events);
        }

    </script>

</body>
</html>

